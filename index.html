<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≤ Ch∆°i H·ªçc T·∫≠p Vui</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(to right top, #6d8cf0, #8d8de0, #a98fcb, #be93b6, #ce99a6);
        }
        .glass-container {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .glass-btn {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.2s ease-in-out;
            /* ƒê·∫£m b·∫£o ch·ªØ trong n√∫t c√≥ m√†u d·ªÖ ƒë·ªçc */
            color: #2d3748; /* M√†u x√°m ƒë·∫≠m cho ch·ªØ */
        }
        /* Override text color for specific buttons if needed for better contrast */
        #start-btn, #next-btn, #play-again-btn, #admin-login-btn, #logout-btn, #view-history-btn, #back-to-admin-btn {
            color: white; /* Gi·ªØ m√†u tr·∫Øng cho c√°c n√∫t h√†nh ƒë·ªông ch√≠nh */
        }
        #admin-login-btn {
            color: #cbd5e0; /* M√†u x√°m nh·∫°t cho n√∫t admin ·ªü m√†n h√¨nh ch√≠nh */
        }

        .choice-btn.selected {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            border-width: 2px;
            border-color: rgba(255, 255, 255, 0.7);
        }
        .answer-option.correct {
            background-color: rgba(34, 197, 94, 0.7) !important;
            border-color: rgba(22, 163, 74, 0.8);
            color: white !important; /* ƒê·∫£m b·∫£o ch·ªØ tr·∫Øng tr√™n n·ªÅn xanh */
        }
        .answer-option.incorrect {
            background-color: rgba(239, 68, 68, 0.7) !important;
            border-color: rgba(220, 38, 38, 0.8);
            color: white !important; /* ƒê·∫£m b·∫£o ch·ªØ tr·∫Øng tr√™n n·ªÅn ƒë·ªè */
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .glass-container {
                padding: 1rem; /* Gi·∫£m padding tr√™n ƒëi·ªán tho·∫°i */
                margin: 0.5rem; /* Gi·∫£m margin tr√™n ƒëi·ªán tho·∫°i */
            }
            h1 {
                font-size: 2.25rem; /* ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc ti√™u ƒë·ªÅ */
            }
            h2 {
                font-size: 1.5rem; /* ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc ti√™u ƒë·ªÅ ph·ª• */
            }
            .choice-btn, .answer-option, #start-btn, #next-btn, #play-again-btn {
                font-size: 1rem; /* ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc ch·ªØ n√∫t */
                padding: 0.8rem; /* ƒêi·ªÅu ch·ªânh padding n√∫t */
            }
            #progress-text, #score-text {
                font-size: 0.9rem;
            }
            #question-container p {
                font-size: 1.1rem; /* ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc ch·ªØ c√¢u h·ªèi */
            }
            #final-score {
                font-size: 4rem; /* Gi·∫£m k√≠ch th∆∞·ªõc ƒëi·ªÉm cu·ªëi c√πng */
            }
            #login-modal .glass-container {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-3xl mx-auto glass-container rounded-3xl shadow-2xl p-4 md:p-8 relative">

        <div id="selection-screen">
            <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-2">Tr√≤ Ch∆°i H·ªçc T·∫≠p</h1>
            <p class="text-center text-gray-700 mb-8">C√πng b√© v·ª´a h·ªçc v·ª´a ch∆°i!</p>

            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-3 text-gray-700">1. Ch·ªçn M√¥n H·ªçc</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button data-subject="toan" class="choice-btn glass-btn bg-sky-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-sky-500/60">üî¢ To√°n H·ªçc</button>
                    <button data-subject="tiengviet" class="choice-btn glass-btn bg-emerald-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-emerald-500/60">‚úçÔ∏è Ti·∫øng Vi·ªát</button>
                </div>
            </div>

            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-3 text-gray-700">2. Ch·ªçn L·ªõp</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button data-grade="lop1" class="choice-btn glass-btn bg-amber-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-amber-500/60">L·ªõp 1</button>
                    <button data-grade="lop2" class="choice-btn glass-btn bg-rose-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-rose-500/60">L·ªõp 2</button>
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-3 text-gray-700">3. Ch·ªçn H·ªçc K·ª≥</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button data-semester="hocky1" class="choice-btn glass-btn bg-purple-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-purple-500/60">H·ªçc K·ª≥ 1</button>
                    <button data-semester="hocky2" class="choice-btn glass-btn bg-pink-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-pink-500/60">H·ªçc K·ª≥ 2</button>
                </div>
            </div>

            <button id="start-btn" class="w-full glass-btn bg-gray-500/50 text-white font-bold py-4 rounded-2xl text-xl shadow-lg cursor-not-allowed" disabled>B·∫Øt ƒë·∫ßu!</button>
            <div class="text-right mt-4"><button id="admin-login-btn" class="text-sm text-gray-200 hover:text-white font-semibold">Qu·∫£n tr·ªã vi√™n</button></div>
        </div>

        <div id="game-screen" class="hidden">
            <div class="flex justify-between items-center mb-4 text-white">
                <div id="progress-text" class="font-semibold">C√¢u 1/20</div>
                <div id="score-text" class="font-bold text-lg">ƒêi·ªÉm: 0</div>
            </div>
            <div id="question-container" class="bg-black/10 p-6 rounded-2xl text-center mb-6 min-h-[100px] flex items-center justify-center">
                <p class="text-xl md:text-2xl font-semibold text-white"></p>
            </div>
            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            <div id="feedback-container" class="text-center mt-4 font-bold text-2xl h-8 text-white"></div>
            <button id="next-btn" class="hidden w-full mt-4 glass-btn bg-blue-500/60 text-white font-bold py-3 rounded-2xl shadow-lg hover:bg-blue-500/80">C√¢u ti·∫øp theo</button>
        </div>

        <div id="results-screen" class="hidden text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Ho√†n th√†nh!</h2>
            <p id="final-score-text" class="text-xl text-gray-700 mb-2">B√© ƒë√£ ƒë·∫°t ƒë∆∞·ª£c</p>
            <p id="final-score" class="text-6xl font-bold text-blue-600 mb-6">0/10</p>
            <p id="final-message" class="text-lg text-gray-600 mb-8">C·ªë g·∫Øng l√™n ·ªü l·∫ßn sau nh√©!</p>
            <button id="play-again-btn" class="w-full glass-btn bg-green-500/60 text-white font-bold py-4 rounded-2xl text-xl shadow-lg hover:bg-green-500/80">Ch∆°i l·∫°i</button>
        </div>
        
        <div id="admin-panel" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">B·∫£ng ƒëi·ªÅu khi·ªÉn Admin</h2>
            <div class="space-y-4">
                   <button id="view-history-btn" class="w-full glass-btn bg-indigo-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-indigo-500/80">Xem L·ªãch S·ª≠ Thi</button>
                   <button id="logout-btn" class="w-full glass-btn bg-red-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-red-500/80">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
        
        <div id="history-panel" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-4 text-center">L·ªãch S·ª≠ L√†m B√†i</h2>
            <div id="history-table-container" class="overflow-x-auto bg-white/50 rounded-2xl p-4">
                </div>
            <button id="back-to-admin-btn" class="w-full mt-6 glass-btn bg-gray-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-gray-500/80">Quay l·∫°i</button>
        </div>

    </div>

    <div id="login-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0">
        <div class="glass-container rounded-3xl shadow-2xl p-8 w-full max-w-sm relative">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">ƒêƒÉng Nh·∫≠p Admin</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-gray-700 font-semibold mb-2">T√™n ƒëƒÉng nh·∫≠p</label>
                    <input type="text" id="username" class="w-full px-4 py-2 border border-gray-300/50 rounded-2xl bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 font-semibold mb-2">M·∫≠t kh·∫©u</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300/50 rounded-2xl bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">
                </div>
                <p id="login-error" class="text-red-500 text-center text-sm h-4 mb-4"></p>
                <button type="submit" class="w-full glass-btn bg-blue-600/70 text-white font-bold py-3 rounded-2xl hover:bg-blue-600/90">ƒêƒÉng nh·∫≠p</button>
            </form>
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-2xl">&times;</button>
        </div>
    </div>


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- NG√ÇN H√ÄNG C√ÇU H·ªéI L·ªöN (Gi·ªØ nguy√™n) ---
        const questions = {
            toan: {
                lop1: {
                    hocky1: [ { question: "5 + 4 = ?", options: [8, 9, 10, 7], answer: 9 }, { question: "8 - 3 = ?", options: [4, 5, 6, 7], answer: 5 }, { question: "S·ªë li·ªÅn sau c·ªßa 9 l√†?", options: [8, 10, 11, 7], answer: 10 }, { question: "C√≥ m·∫•y h√¨nh tr√≤n: üîµ üî∫ üîµ ‚¨ú", options: [1, 2, 3, 4], answer: 2 }, { question: "2 + 6 = ?", options: [7, 8, 9, 10], answer: 8 }, { question: "S·ªë li·ªÅn tr∆∞·ªõc c·ªßa 15 l√†?", options: [13, 14, 16, 17], answer: 14 }, { question: "H√¨nh vu√¥ng c√≥ m·∫•y c·∫°nh?", options: [2, 3, 4, 5], answer: 4 }, { question: "ƒêi·ªÅn d·∫•u: 5 + 3 ... 8", options: ["<", ">", "="], answer: "=" }, { question: "7 + ... = 10", options: [1, 2, 3, 4], answer: 3 }, { question: "S·ªë b√© nh·∫•t trong c√°c s·ªë: 9, 3, 7, 5 l√†?", options: [9, 3, 7, 5], answer: 3 }, { question: "6 + 1 = ?", options: [5, 6, 7, 8], answer: 7 }, { question: "10 - 10 = ?", options: [0, 1, 10, 20], answer: 0 }, { question: "S·ªë l·ªõn nh·∫•t trong c√°c s·ªë: 1, 8, 4, 6 l√†?", options: [1, 8, 4, 6], answer: 8 }, { question: "3 + ... = 9", options: [5, 6, 7, 8], answer: 6 }, { question: "C√≥ m·∫•y h√¨nh vu√¥ng: ‚¨ú ‚¨ú üîµ ‚¨ú", options: [1, 2, 3, 4], answer: 3 }, { question: "9 - 7 = ?", options: [1, 2, 3, 16], answer: 2 }, { question: "S·ªë li·ªÅn sau c·ªßa 0 l√†?", options: [0, 1, 2, -1], answer: 1 }, { question: "4 + 4 = ?", options: [6, 7, 8, 9], answer: 8 }, { question: "ƒêi·ªÅn d·∫•u: 10 ... 5 + 6", options: ["<", ">", "="], answer: "<" }, { question: "Trong c√°c s·ªë 2, 8, 5, 1, s·ªë n√†o nh·ªè nh·∫•t?", options: [2, 8, 5, 1], answer: 1 } ],
                    hocky2: [ { question: "10 + 6 = ?", options: [15, 16, 17, 18], answer: 16 }, { question: "18 - 5 = ?", options: [12, 13, 14, 15], answer: 13 }, { question: "S·ªë g·ªìm 1 ch·ª•c v√† 7 ƒë∆°n v·ªã l√†?", options: [10, 7, 17, 71], answer: 17 }, { question: "H√¥m nay l√† th·ª© Hai, ng√†y mai l√† th·ª© m·∫•y?", options: ["Ch·ªß Nh·∫≠t", "Th·ª© Ba", "Th·ª© T∆∞"], answer: "Th·ª© Ba" }, { question: "Lan c√≥ 8 k·∫πo, m·∫π cho th√™m 5. Lan c√≥ t·∫•t c·∫£...c√°i k·∫πo?", options: [12, 13, 14, 3], answer: 13 }, { question: "S·ªë l·ªõn nh·∫•t c√≥ hai ch·ªØ s·ªë l√†?", options: [10, 90, 99, 100], answer: 99 }, { question: "15 + 4 = ?", options: [18, 19, 20, 21], answer: 19 }, { question: "Tr√™n c√†nh c√≥ 12 con chim, bay ƒëi 4 con. C√≤n l·∫°i...con chim?", options: [7, 8, 9, 16], answer: 8 }, { question: "S·ªë 50 c√≤n ƒë∆∞·ª£c g·ªçi l√†?", options: ["NƒÉm m∆∞∆°i", "NƒÉm ch·ª•c", "C·∫£ hai ƒë·ªÅu ƒë√∫ng"], answer: "C·∫£ hai ƒë·ªÅu ƒë√∫ng" }, { question: "ƒêi·ªÅn s·ªë: 20, 30, ..., 50", options: [35, 40, 45, 60], answer: 40 }, { question: "30 + 40 = ?", options: [60, 70, 80, 10], answer: 70 }, { question: "90 - 20 = ?", options: [60, 70, 80, 110], answer: 70 }, { question: "S·ªë g·ªìm 8 ch·ª•c v√† 1 ƒë∆°n v·ªã l√†?", options: [80, 18, 81, 9], answer: 81 }, { question: "S·ªë b√© nh·∫•t c√≥ hai ch·ªØ s·ªë gi·ªëng nhau l√†?", options: [10, 11, 12, 22], answer: 11 }, { question: "An c√≥ 19 vi√™n bi, An cho B√¨nh 7 vi√™n. An c√≤n l·∫°i...vi√™n bi?", options: [11, 12, 13, 26], answer: 12 }, { question: "1 tu·∫ßn c√≥ m·∫•y ng√†y?", options: [5, 6, 7, 8], answer: 7 }, { question: "S·ªë li·ªÅn tr∆∞·ªõc c·ªßa 100 l√†?", options: [90, 98, 99, 101], answer: 99 }, { question: "ƒêi·ªÅn d·∫•u: 45 ... 54", options: ["<", ">", "="], answer: "<" }, { question: "50 + 50 = ?", options: [90, 100, 10, 0], answer: 100 }, { question: "S·ªë tr√≤n ch·ª•c l·ªõn nh·∫•t c√≥ hai ch·ªØ s·ªë l√†?", options: [10, 80, 90, 99], answer: 90 } ]
                },
                lop2: {
                    hocky1: [ { question: "Ph√©p t√≠nh '3 + 3 + 3 + 3' ƒë∆∞·ª£c vi·∫øt th√†nh?", options: ["3 x 3", "3 x 4", "4 x 3", "3 + 4"], answer: "3 x 4" }, { question: "2 x 8 = ?", options: [10, 14, 16, 18], answer: 16 }, { question: "15 : 3 = ?", options: [3, 4, 5, 6], answer: 5 }, { question: "M·ªôt gi·ªù c√≥ bao nhi√™u ph√∫t?", options: [30, 60, 90, 100], answer: 60 }, { question: "T√¨m x, bi·∫øt x + 15 = 40", options: [25, 35, 55, 15], answer: 25 }, { question: "S·ªë li·ªÅn sau c·ªßa 99 l√†?", options: [98, 100, 101, 90], answer: 100 }, { question: "ƒê·ªìng h·ªì ch·ªâ 3 gi·ªù ƒë√∫ng, kim ng·∫Øn ch·ªâ s·ªë m·∫•y?", options: [12, 3, 6, 9], answer: 3 }, { question: "5 x 7 = ?", options: [12, 30, 35, 40], answer: 35 }, { question: "C√≥ 10 c√°i b√°nh chia ƒë·ªÅu cho 2 b·∫°n. M·ªói b·∫°n c√≥...c√°i b√°nh?", options: [4, 5, 8, 12], answer: 5 }, { question: "T√¨m hi·ªáu c·ªßa 50 v√† 20", options: [30, 70, 25, 35], answer: 30 }, { question: "4 x 6 = ?", options: [20, 22, 24, 26], answer: 24 }, { question: "20 : 5 = ?", options: [3, 4, 5, 6], answer: 4 }, { question: "T√¨m x, bi·∫øt x - 10 = 30", options: [10, 20, 30, 40], answer: 40 }, { question: "M·ªói chu·ªìng c√≥ 5 con g√†. 4 chu·ªìng nh∆∞ v·∫≠y c√≥...con g√†?", options: [9, 15, 20, 25], answer: 20 }, { question: "S·ªë 18 g·ªìm m·∫•y ch·ª•c v√† m·∫•y ƒë∆°n v·ªã?", options: ["1 ch·ª•c v√† 8 ƒë∆°n v·ªã", "8 ch·ª•c v√† 1 ƒë∆°n v·ªã", "10 ch·ª•c v√† 8 ƒë∆°n v·ªã"], answer: "1 ch·ª•c v√† 8 ƒë∆°n v·ªã" }, { question: "T√¨m t·ªïng c·ªßa 35 v√† 25", options: [50, 55, 60, 65], answer: 60 }, { question: "2 x 1 = ?", options: [1, 2, 3, 0], answer: 2 }, { question: "30 : 3 = ?", options: [3, 10, 33, 27], answer: 10 }, { question: "S·ªë li·ªÅn tr∆∞·ªõc c·ªßa 200 l√†?", options: [100, 190, 199, 201], answer: 199 }, { question: "Trong ph√©p chia 14 : 2 = 7, s·ªë 14 ƒë∆∞·ª£c g·ªçi l√† g√¨?", options: ["S·ªë b·ªã chia", "S·ªë chia", "Th∆∞∆°ng"], answer: "S·ªë b·ªã chia" } ],
                    hocky2: [ { question: "56 + 28 = ?", options: [74, 84, 94, 78], answer: 84 }, { question: "81 - 34 = ?", options: [47, 57, 53, 43], answer: 47 }, { question: "1km b·∫±ng bao nhi√™u m√©t?", options: [10, 100, 1000, 10000], answer: 1000 }, { question: "S·ªë l·ªõn nh·∫•t c√≥ ba ch·ªØ s·ªë l√†?", options: [100, 987, 999, 990], answer: 999 }, { question: "T√¨m y, bi·∫øt y x 4 = 36", options: [7, 8, 9, 10], answer: 9 }, { question: "S·ªë g·ªìm 5 trƒÉm, 0 ch·ª•c, 8 ƒë∆°n v·ªã l√†?", options: [508, 580, 805, 850], answer: 508 }, { question: "Th√πng th·ª© nh·∫•t c√≥ 150l d·∫ßu, th√πng th·ª© hai nhi·ªÅu h∆°n 25l. Th√πng th·ª© hai c√≥...l√≠t d·∫ßu?", options: [125, 175, 25, 165], answer: 175 }, { question: "M·ªôt ph·∫ßn ba c·ªßa 27 l√†?", options: [3, 7, 8, 9], answer: 9 }, { question: "1 m√©t b·∫±ng bao nhi√™u centimet?", options: [10, 50, 100, 1000], answer: 100 }, { question: "C√≥ 5 t√∫i k·∫πo, m·ªói t√∫i 8 c√°i. T·ªïng c·ªông c√≥...c√°i k·∫πo?", options: [13, 35, 40, 45], answer: 40 }, { question: "7 x 8 = ?", options: [54, 56, 63, 64], answer: 56 }, { question: "48 : 6 = ?", options: [6, 7, 8, 9], answer: 8 }, { question: "T√¨m y, bi·∫øt 50 : y = 5", options: [5, 10, 25, 45], answer: 10 }, { question: "S·ªë b√© nh·∫•t c√≥ ba ch·ªØ s·ªë kh√°c nhau l√†?", options: [100, 101, 102, 123], answer: 102 }, { question: "M·ªôt h√¨nh tam gi√°c c√≥ c√°c c·∫°nh l√† 10cm, 12cm, 15cm. Chu vi h√¨nh tam gi√°c l√†?", options: ["37cm", "27cm", "35cm", "40cm"], answer: "37cm" }, { question: "S·ªë 609 ƒë·ªçc l√†?", options: ["S√°u trƒÉm ch√≠n", "S√°u trƒÉm linh ch√≠n", "S√°u ch√≠n kh√¥ng"], answer: "S√°u trƒÉm linh ch√≠n" }, { question: "1000 - 500 = ?", options: [400, 500, 600, 1500], answer: 500 }, { question: "M·ªôt nƒÉm (kh√¥ng nhu·∫≠n) c√≥ bao nhi√™u ng√†y?", options: [360, 365, 366, 370], answer: 365 }, { question: "T√¨m x, bi·∫øt x : 7 = 6", options: [13, 1, 42, 49], answer: 42 }, { question: "So s√°nh: 456 ... 465", options: ["<", ">", "="], answer: "<" } ]
                }
            },
            tiengviet: {
                lop1: {
                    hocky1: [ { question: "T√¨m t·ª´ c√≥ v·∫ßn 'a'", options: ["nh√†", "b√™", "s√°ch", "bi"], answer: "nh√†" }, { question: "Ti·∫øng 'b√†' c√≥ √¢m ƒë·∫ßu l√† g√¨?", options: ["a", "b", "huy·ªÅn", "ab"], answer: "b" }, { question: "ƒêi·ªÅn 'c' hay 'k': ...on ...i·∫øn", options: ["c, k", "k, c", "c, c", "k, k"], answer: "c, k" }, { question: "ƒê√¢u l√† t√™n m·ªôt con v·∫≠t?", options: ["b√†n", "gh·∫ø", "m√®o", "s√¥ng"], answer: "m√®o" }, { question: "ƒêi·ªÅn 'g' hay 'gh': ...√† tr·ªëng", options: ["g", "gh"], answer: "g" }, { question: "S·∫Øp x·∫øp: m·∫π, y√™u, em", options: ["Em y√™u m·∫π", "M·∫π y√™u em", "Y√™u m·∫π em"], answer: "Em y√™u m·∫π" }, { question: "ƒêi·ªÅn 's' hay 'x': ...e ƒë·∫°p", options: ["s", "x"], answer: "x" }, { question: "Trong t·ª´ 'c√°i ca', ti·∫øng n√†o c√≥ thanh ngang?", options: ["c√°i", "ca", "c·∫£ hai", "kh√¥ng c√≥"], answer: "ca" }, { question: "T√¨m t·ª´ c√≥ v·∫ßn 'oi'", options: ["c√°i n∆°", "ng√¥i nh√†", "b√∫t", "c√°"], answer: "ng√¥i nh√†" }, { question: "ƒêi·ªÅn 'ng' hay 'ngh': ...·ªß", options: ["ng", "ngh"], answer: "ng" }, { question: "Ti·∫øng 'ph·ªë' c√≥ √¢m ƒë·∫ßu l√† g√¨?", options: ["ph", "√¥", "p", "h"], answer: "ph" }, { question: "T√¨m t·ª´ c√≥ v·∫ßn '√™'", options: ["qu·∫£ l√™", "c√°i l√°", "con b√≤", "c√°i √¥"], answer: "qu·∫£ l√™" }, { question: "ƒêi·ªÅn 'd' hay 'gi': ...√†y d√©p", options: ["d", "gi"], answer: "d" }, { question: "S·∫Øp x·∫øp: c√°, r√¥, kho", options: ["C√° kho r√¥", "Kho c√° r√¥", "R√¥ kho c√°"], answer: "Kho c√° r√¥" }, { question: "T·ª´ n√†o ch·ªâ ƒë·ªì v·∫≠t?", options: ["ch·∫°y", "nh·∫£y", "c√°i b√∫t", "xanh"], answer: "c√°i b√∫t" }, { question: "ƒêi·ªÅn 'gh' hay 'g': ...·∫ø", options: ["gh", "g"], answer: "gh" }, { question: "Ti·∫øng 'nh√†' c√≥ v·∫ßn g√¨?", options: ["a", "nh", "ha", "nha"], answer: "a" }, { question: "C√¢u 'B√© ƒëi h·ªçc.' c√≥ m·∫•y ti·∫øng?", options: [2, 3, 4, 5], answer: 3 }, { question: "T√¨m t·ª´ c√≥ thanh h·ªèi", options: ["b√†", "b·∫£", "b√°", "b·∫°"], answer: "b·∫£" }, { question: "ƒêi·ªÅn 'qu' hay 'c': ...·∫£ ...·∫•t", options: ["qu, c", "c, qu", "qu, qu", "c, c"], answer: "qu, c" } ],
                    hocky2: [ { question: "T√¨m t·ª´ c√≥ v·∫ßn 'at'", options: ["nh√†", "b√†i h√°t", "s√°ch", "v·ªü"], answer: "b√†i h√°t" }, { question: "ƒêi·ªÅn 'ch' ho·∫∑c 'tr': c√¢y ...e", options: ["ch", "tr"], answer: "tr" }, { question: "S·∫Øp x·∫øp: xanh, b·∫ßu, tr·ªùi", options: ["Xanh b·∫ßu tr·ªùi", "B·∫ßu tr·ªùi xanh", "Tr·ªùi xanh b·∫ßu"], answer: "B·∫ßu tr·ªùi xanh" }, { question: "T·ª´ n√†o ch·ªâ ho·∫°t ƒë·ªông?", options: ["c√°i c·∫∑p", "ng√¥i sao", "xinh ƒë·∫πp", "m√∫a h√°t"], answer: "m√∫a h√°t" }, { question: "C√¢u 'Con m√®o tr√®o c√¢y cau.' c√≥ m·∫•y ti·∫øng?", options: [5, 6, 7, 8], answer: 6 }, { question: "C√¢u 'B·ªë l√† tr·ª• c·ªôt c·ªßa gia ƒë√¨nh.' k·∫øt th√∫c b·∫±ng d·∫•u g√¨?", options: [".", "?", "!", ","], answer: "." }, { question: "T·ª´ n√†o vi·∫øt ƒë√∫ng ch√≠nh t·∫£?", options: ["qu·∫£ chanh", "q·ªßa chanh", "qu·∫£ tranh"], answer: "qu·∫£ chanh" }, { question: "T√¨m t·ª´ c√≥ v·∫ßn 'oan'", options: ["c√°i b·∫£ng", "to√°n", "lan", "s√°ch"], answer: "to√°n" }, { question: "ƒêi·ªÅn 'd', 'gi' hay 'r': ...a ƒë√¨nh", options: ["d", "gi", "r"], answer: "gi" }, { question: "T·ª´ n√†o ch·ªâ ƒë·ªì v·∫≠t trong nh√†?", options: ["c√¥ng vi√™n", "c√°i gi∆∞·ªùng", "con ƒë∆∞·ªùng", "c√°nh ƒë·ªìng"], answer: "c√°i gi∆∞·ªùng" }, { question: "T√¨m t·ª´ c√≥ v·∫ßn 'i√™n'", options: ["c√¥ ti√™n", "c√°i chi√™ng", "con ki·∫øn", "vi√™n bi"], answer: "c√¥ ti√™n" }, { question: "ƒêi·ªÅn 'l' hay 'n': ...o ...√™", options: ["l, n", "n, l", "l, l", "n, n"], answer: "n, l" }, { question: "S·∫Øp x·∫øp: hoa, h·ªìng, n·ªü", options: ["N·ªü hoa h·ªìng", "H·ªìng hoa n·ªü", "Hoa h·ªìng n·ªü"], answer: "Hoa h·ªìng n·ªü" }, { question: "T·ª´ n√†o ch·ªâ m√†u s·∫Øc?", options: ["c√°i c√¢y", "ch·∫°y b·ªô", "v√†ng t∆∞∆°i", "ng·ªçt ng√†o"], answer: "v√†ng t∆∞∆°i" }, { question: "C√¢u 'Tr·ªùi m∆∞a to.' thu·ªôc m·∫´u c√¢u n√†o?", options: ["Ai l√† g√¨?", "Ai l√†m g√¨?", "Ai th·∫ø n√†o?"], answer: "Ai th·∫ø n√†o?" }, { question: "T·ª´ n√†o vi·∫øt sai ch√≠nh t·∫£?", options: ["gieo h·∫°t", "reo vui", "dao k√©o", "rao b√°n"], answer: "reo vui" }, { question: "T√¨m t·ª´ c√≥ v·∫ßn '∆∞∆°u'", options: ["con h∆∞∆°u", "con c·ª´u", "tr√°i l·ª±u", "d√≤ng m∆∞∆°ng"], answer: "con h∆∞∆°u" }, { question: "ƒêi·ªÅn d·∫•u h·ªèi hay d·∫•u ng√£: chia se...", options: ["h·ªèi", "ng√£"], answer: "ng√£" }, { question: "T·ª´ 'tr∆∞·ªùng h·ªçc' c√≥ m·∫•y ti·∫øng?", options: [1, 2, 3, 4], answer: 2 }, { question: "C√¢u n√†o d√πng ƒë·ªÉ h·ªèi?", options: ["M·∫π ƒëang n·∫•u c∆°m.", "M·∫π n·∫•u c∆°m ch∆∞a ·∫°?", "M·∫π n·∫•u c∆°m ngon qu√°!"], answer: "M·∫π n·∫•u c∆°m ch∆∞a ·∫°?" } ]
                },
                lop2: {
                    hocky1: [ { question: "T·ª´ n√†o kh√¥ng c√πng nh√≥m: b√∫t, th∆∞·ªõc, s√°ch, hoa", options: ["b√∫t", "th∆∞·ªõc", "s√°ch", "hoa"], answer: "hoa" }, { question: "T√¨m t·ª´ tr√°i nghƒ©a v·ªõi 'nhanh'", options: ["v·ªôi", "g·∫•p", "ch·∫≠m", "mau"], answer: "ch·∫≠m" }, { question: "D·∫•u c√¢u n√†o d√πng ƒë·ªÉ k·∫øt th√∫c m·ªôt c√¢u h·ªèi?", options: [".", "?", "!", ","], answer: "?" }, { question: "T·ª´ n√†o vi·∫øt ƒë√∫ng ch√≠nh t·∫£?", options: ["ngon ngh·∫ªo", "ngo·∫±n ngo√®o", "ngon ngoeo"], answer: "ngo·∫±n ngo√®o" }, { question: "T·ª´ n√†o ch·ªâ ƒë·∫∑c ƒëi·ªÉm?", options: ["b∆°i", "t√≠m", "ng·ªß", "c√°i nh√†"], answer: "t√≠m" }, { question: "T·ª´ n√†o vi·∫øt sai ch√≠nh t·∫£?", options: ["s·∫£n xu·∫•t", "xu·∫•t s·∫Øc", "d·∫£n d·ªã", "d·ªãu d√†ng"], answer: "d·∫£n d·ªã" }, { question: "T·ª´ tr√°i nghƒ©a v·ªõi 'kh·ªèe m·∫°nh' l√†?", options: ["c∆∞·ªùng tr√°ng", "d≈©ng c·∫£m", "y·∫øu ·ªõt", "to l·ªõn"], answer: "y·∫øu ·ªõt" }, { question: "D√≤ng n√†o g·ªìm c√°c t·ª´ ch·ªâ s·ª± v·∫≠t?", options: ["ƒë·∫πp, x·∫•u, t·ªët", "th·∫ßy gi√°o, c√¢y c·ªëi, d√≤ng s√¥ng", "ƒëi, ƒë·ª©ng, n·∫±m"], answer: "th·∫ßy gi√°o, c√¢y c·ªëi, d√≤ng s√¥ng" }, { question: "T√¨m t·ª´ ƒë·ªìng nghƒ©a v·ªõi 'to l·ªõn'", options: ["nh·ªè b√©", "ch·∫≠t h·∫πp", "kh·ªïng l·ªì", "th·∫•p"], answer: "kh·ªïng l·ªì" }, { question: "T·ª´ n√†o vi·∫øt ƒë√∫ng ch√≠nh t·∫£?", options: ["l·∫Øng lo", "n·∫Øng no", "lo l·∫Øng", "no n·∫Øng"], answer: "lo l·∫Øng" }, { question: "T·ª´ 'chƒÉm ch·ªâ' l√† t·ª´ ch·ªâ g√¨?", options: ["S·ª± v·∫≠t", "Ho·∫°t ƒë·ªông", "ƒê·∫∑c ƒëi·ªÉm"], answer: "ƒê·∫∑c ƒëi·ªÉm" }, { question: "T√¨m t·ª´ c√≥ ch·ª©a v·∫ßn 'oanh'", options: ["doanh tr·∫°i", "oan ·ª©c", "loay hoay", "khoanh tay"], answer: "doanh tr·∫°i" }, { question: "C√¢u 'Con ng·ª±a phi nhanh nh∆∞ bay.' s·ª≠ d·ª•ng bi·ªán ph√°p tu t·ª´ g√¨?", options: ["Nh√¢n h√≥a", "So s√°nh", "·∫®n d·ª•"], answer: "So s√°nh" }, { question: "T·ª´ n√†o vi·∫øt sai ch√≠nh t·∫£?", options: ["c√°i ch·ªïi", "c√¢y ch√¥i", "ch√¥i n·ªïi"], answer: "c√¢y ch√¥i" }, { question: "B·ªô ph·∫≠n g·∫°ch ch√¢n trong c√¢u 'Em **r·∫•t y√™u qu√Ω** m·∫π.' tr·∫£ l·ªùi c√¢u h·ªèi n√†o?", options: ["L√† g√¨?", "L√†m g√¨?", "Th·∫ø n√†o?"], answer: "Th·∫ø n√†o?" }, { question: "T·ª´ ƒë·ªìng nghƒ©a v·ªõi 'si√™ng nƒÉng'?", options: ["l∆∞·ªùi bi·∫øng", "c·∫ßn c√π", "th√¥ng minh", "nhanh nh·∫πn"], answer: "c·∫ßn c√π" }, { question: "Trong c√°c t·ª´ sau, t·ª´ n√†o l√† t·ª´ l√°y: xinh x·∫Øn, t∆∞∆°i t·ªët, b√†n gh·∫ø, s√°ch v·ªü", options: ["xinh x·∫Øn", "t∆∞∆°i t·ªët", "b√†n gh·∫ø", "s√°ch v·ªü"], answer: "xinh x·∫Øn" }, { question: "D·∫•u hai ch·∫•m trong c√¢u 'M·∫π b·∫£o: \"Con ƒëi h·ªçc v·ªÅ ph·∫£i r·ª≠a tay nh√©!\"' c√≥ t√°c d·ª•ng g√¨?", options: ["B√°o hi·ªáu l·ªùi n√≥i tr·ª±c ti·∫øp", "K·∫øt th√∫c c√¢u", "NgƒÉn c√°ch c√°c √Ω"], answer: "B√°o hi·ªáu l·ªùi n√≥i tr·ª±c ti·∫øp" }, { question: "T·ª´ n√†o ch·ªâ ho·∫°t ƒë·ªông c·ªßa h·ªçc sinh?", options: ["c√¥ gi√°o", "b·∫£ng ƒëen", "h·ªçc b√†i", "s√¢n tr∆∞·ªùng"], answer: "h·ªçc b√†i" }, { question: "T√¨m t·ª´ tr√°i nghƒ©a v·ªõi 'ƒëo√†n k·∫øt'", options: ["chia r·∫Ω", "y√™u th∆∞∆°ng", "ƒë√πm b·ªçc", "g·∫Øn b√≥"], answer: "chia r·∫Ω" } ],
                    hocky2: [ { question: "C√¢u 'Ai th·∫ø n√†o?':", options: ["Em ƒëang h·ªçc b√†i.", "B√¥ng hoa n√†y r·∫•t ƒë·∫πp.", "B·ªë em l√† b√°c sƒ©."], answer: "B√¥ng hoa n√†y r·∫•t ƒë·∫πp." }, { question: "ƒê·∫∑t c√¢u h·ªèi cho b·ªô ph·∫≠n g·∫°ch ch√¢n: '**B√°c n√¥ng d√¢n** ƒëang c√†y ru·ªông.'", options: ["Ai?", "L√†m g√¨?", "Th·∫ø n√†o?"], answer: "Ai?" }, { question: "C√¢u 'Nh·ªØng ch√∫ chim ƒëang h√≥t tr√™n c√†nh.' thu·ªôc m·∫´u c√¢u n√†o?", options: ["Ai l√† g√¨?", "Ai l√†m g√¨?", "Ai th·∫ø n√†o?"], answer: "Ai l√†m g√¨?" }, { question: "Trong c√¢u 'M·∫∑t bi·ªÉn ph·∫≥ng l·∫∑ng v√† r·ªông m√™nh m√¥ng.', t·ª´ ch·ªâ ƒë·∫∑c ƒëi·ªÉm l√†?", options: ["M·∫∑t bi·ªÉn", "ph·∫≥ng l·∫∑ng, r·ªông m√™nh m√¥ng", "v√†"], answer: "ph·∫≥ng l·∫∑ng, r·ªông m√™nh m√¥ng" }, { question: "B·ªô ph·∫≠n tr·∫£ l·ªùi c√¢u h·ªèi 'Khi n√†o?' trong c√¢u: '**M√πa h√®**, hoa ph∆∞·ª£ng n·ªü ƒë·ªè r·ª±c.'", options: ["M√πa h√®", "hoa ph∆∞·ª£ng", "n·ªü ƒë·ªè r·ª±c"], answer: "M√πa h√®" }, { question: "C√¢u '√îi, b·∫°n gi·ªèi qu√°!' l√† lo·∫°i c√¢u g√¨?", options: ["C√¢u k·ªÉ", "C√¢u h·ªèi", "C√¢u c·∫£m"], answer: "C√¢u c·∫£m" }, { question: "T√¨m t·ª´ c√≥ hai ti·∫øng ƒë·ªÅu b·∫Øt ƒë·∫ßu b·∫±ng 'ch'", options: ["chƒÉm ch·ªâ", "trung th·ª±c", "ch·∫Øc ch·∫Øn", "ch√≥ng v√°nh"], answer: "chƒÉm ch·ªâ" }, { question: "D·∫•u ph·∫©y trong c√¢u 'Em th√≠ch h·ªçc To√°n, Ti·∫øng Vi·ªát v√† √Çm nh·∫°c.' c√≥ t√°c d·ª•ng g√¨?", options: ["NgƒÉn c√°ch c√°c b·ªô ph·∫≠n c√πng ch·ª©c v·ª•", "K·∫øt th√∫c c√¢u", "B·∫Øt ƒë·∫ßu c√¢u"], answer: "NgƒÉn c√°ch c√°c b·ªô ph·∫≠n c√πng ch·ª©c v·ª•" }, { question: "T·ª´ 'hi·ªÅn l√†nh' l√† t·ª´ ch·ªâ ...", options: ["Ho·∫°t ƒë·ªông", "ƒê·∫∑c ƒëi·ªÉm", "S·ª± v·∫≠t"], answer: "ƒê·∫∑c ƒëi·ªÉm" }, { question: "B·ªô ph·∫≠n tr·∫£ l·ªùi c√¢u h·ªèi 'V√¨ sao?' trong c√¢u: 'B·∫°n Nam ƒë∆∞·ª£c c√¥ gi√°o khen **v√¨ b·∫°n ·∫•y h·ªçc gi·ªèi**.'", options: ["B·∫°n Nam", "ƒë∆∞·ª£c c√¥ gi√°o khen", "v√¨ b·∫°n ·∫•y h·ªçc gi·ªèi"], answer: "v√¨ b·∫°n ·∫•y h·ªçc gi·ªèi" }, { question: "T·ª´ n√†o l√† t·ª´ gh√©p: xe ƒë·∫°p, xinh x·∫Øn, ƒëi ƒë·ª©ng, lung linh", options: ["xe ƒë·∫°p", "xinh x·∫Øn", "ƒëi ƒë·ª©ng", "lung linh"], answer: "xe ƒë·∫°p" }, { question: "C√¢u 'Ch√∫ b·ªô ƒë·ªôi canh gi·ªØ ƒë·∫•t tr·ªùi.' c√≥ b·ªô ph·∫≠n v·ªã ng·ªØ l√†?", options: ["Ch√∫ b·ªô ƒë·ªôi", "canh gi·ªØ ƒë·∫•t tr·ªùi", "ƒë·∫•t tr·ªùi"], answer: "canh gi·ªØ ƒë·∫•t tr·ªùi" }, { question: "T·ª´ n√†o sau ƒë√¢y vi·∫øt ƒë√∫ng ch√≠nh t·∫£: chia s·∫ª, chia x·∫ª, x·∫ª chia", options: ["chia s·∫ª", "chia x·∫ª", "x·∫ª chia"], answer: "chia s·∫ª" }, { question: "ƒê·∫∑t c√¢u h·ªèi cho b·ªô ph·∫≠n g·∫°ch ch√¢n: 'Hoa ph∆∞·ª£ng n·ªü ƒë·ªè r·ª±c **tr√™n s√¢n tr∆∞·ªùng**.'", options: ["Khi n√†o?", "·ªû ƒë√¢u?", "V√¨ sao?"], answer: "·ªû ƒë√¢u?" }, { question: "T·ª´ 'd≈©ng c·∫£m' ƒë·ªìng nghƒ©a v·ªõi t·ª´ n√†o?", options: ["nh√∫t nh√°t", "gan d·∫°", "hi·ªÅn l√†nh", "th·∫≠t th√†"], answer: "gan d·∫°" }, { question: "C√¢u 'M√πa xu√¢n, c√¢y c·ªëi ƒë√¢m ch·ªìi n·∫£y l·ªôc.' c√≥ m·∫•y t·ª´ ch·ªâ s·ª± v·∫≠t?", options: [2, 3, 4, 5], answer: 3 }, { question: "T·ª´ n√†o kh√¥ng ph·∫£i l√† t·ª´ ch·ªâ ng∆∞·ªùi?", options: ["b√°c sƒ©", "gi√°o vi√™n", "k·ªπ s∆∞", "b·ªánh vi·ªán"], answer: "b·ªánh vi·ªán" }, { question: "D·∫•u ch·∫•m than (!) th∆∞·ªùng ƒë∆∞·ª£c d√πng ·ªü cu·ªëi c√¢u n√†o?", options: ["C√¢u k·ªÉ", "C√¢u h·ªèi", "C√¢u c·∫£m"], answer: "C√¢u c·∫£m" }, { question: "Trong c√°c t·ª´ sau, t·ª´ n√†o l√† t·ª´ H√°n Vi·ªát: n√∫i s√¥ng, ƒë·∫•t n∆∞·ªõc, giang s∆°n, non n∆∞·ªõc", options: ["n√∫i s√¥ng", "ƒë·∫•t n∆∞·ªõc", "giang s∆°n", "non n∆∞·ªõc"], answer: "giang s∆°n" }, { question: "B·ªô ph·∫≠n ch·ªß ng·ªØ trong c√¢u 'Nh·ªØng b√¥ng hoa ƒëua nhau khoe s·∫Øc.' l√†?", options: ["Nh·ªØng b√¥ng hoa", "ƒëua nhau khoe s·∫Øc", "khoe s·∫Øc"], answer: "Nh·ªØng b√¥ng hoa" } ]
                }
            }
        };

        // --- BI·∫æN TR·∫†NG TH√ÅI ---
        let selectedSubject = null, selectedGrade = null, selectedSemester = null;
        let currentQuestions = [], currentQuestionIndex = 0, score = 0;
        const NUM_OF_QUESTIONS_PER_GAME = 20;

        // --- BI·∫æN FIREBASE ---
        let db, auth;
        // The __app_id variable is expected to be defined by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- L·∫§Y C√ÅC PH·∫¶N T·ª¨ DOM ---
        const selectionScreen = document.getElementById('selection-screen');
        const gameScreen = document.getElementById('game-screen');
        const resultsScreen = document.getElementById('results-screen');
        const startBtn = document.getElementById('start-btn');
        const subjectBtns = document.querySelectorAll('[data-subject]');
        const gradeBtns = document.querySelectorAll('[data-grade]');
        const semesterBtns = document.querySelectorAll('[data-semester]');
        
        // DOM CHO ADMIN
        const adminPanel = document.getElementById('admin-panel');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const loginModal = document.getElementById('login-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');
        const viewHistoryBtn = document.getElementById('view-history-btn');
        const historyPanel = document.getElementById('history-panel');
        const backToAdminBtn = document.getElementById('back-to-admin-btn');
        const historyTableContainer = document.getElementById('history-table-container');

        // --- H√ÄM KH·ªûI T·∫†O FIREBASE V√Ä X√ÅC TH·ª∞C ---
        async function initializeFirebase() {
            try {
                // The __firebase_config variable is expected to be defined by the environment
                const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Sign in anonymously to get permissions
                onAuthStateChanged(auth, user => {
                    if (!user) {
                        signInAnonymously(auth).catch(error => {
                            console.error("Anonymous sign-in error:", error);
                        });
                    }
                });
            } catch (error) {
                console.error("Firebase config error:", error);
                alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn c∆° s·ªü d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u h√¨nh.");
            }
        }
        
        // --- H√ÄM L∆ØU V√Ä HI·ªÇN TH·ªä L·ªäCH S·ª¨ (D√ôNG FIRESTORE) ---
        async function saveResult(resultData) {
            if (!db) {
                console.error("DB not connected.");
                return;
            }
            try {
                // FIX: Simplified the collection path to avoid permission issues with complex paths.
                const historyCollectionRef = collection(db, `artifacts/${appId}/public/quizResults`);
                await addDoc(historyCollectionRef, resultData);
            } catch (e) {
                console.error("Error writing result to Firestore:", e);
            }
        }

        async function displayHistory() {
            adminPanel.classList.add('hidden');
            historyPanel.classList.remove('hidden');
            
            if (!db) {
                historyTableContainer.innerHTML = '<p class="text-center text-gray-500">L·ªói k·∫øt n·ªëi CSDL.</p>';
                return;
            }
            
            historyTableContainer.innerHTML = '<p class="text-center text-gray-500">ƒêang t·∫£i l·ªãch s·ª≠...</p>';

            try {
                // FIX: Reading from the simplified collection path.
                const historyCollectionRef = collection(db, `artifacts/${appId}/public/quizResults`);
                const q = query(historyCollectionRef, orderBy("date", "desc"));
                const querySnapshot = await getDocs(q);
                
                historyTableContainer.innerHTML = '';
                if (querySnapshot.empty) {
                    historyTableContainer.innerHTML = '<p class="text-center text-gray-500">Ch∆∞a c√≥ l·ªãch s·ª≠ l√†m b√†i.</p>';
                    return;
                }

                const nameMap = { toan: 'To√°n', tiengviet: 'Ti·∫øng Vi·ªát', lop1: 'L·ªõp 1', lop2: 'L·ªõp 2', hocky1: 'H·ªçc K·ª≥ 1', hocky2: 'H·ªçc K·ª≥ 2' };
                const table = document.createElement('table');
                table.classList.add('min-w-full', 'divide-y', 'divide-gray-200', 'rounded-lg', 'overflow-hidden');
                table.innerHTML = `
                    <thead class="bg-gray-100/50">
                        <tr>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Ng√†y Gi·ªù</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">M√¥n</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">L·ªõp</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">H·ªçc K·ª≥</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">ƒêi·ªÉm</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white/30 divide-y divide-gray-200 text-gray-800"></tbody>
                `;
                const tbody = table.querySelector('tbody');

                querySnapshot.forEach((doc) => {
                    const result = doc.data();
                    const row = tbody.insertRow();
                    // Firestore timestamp needs to be converted to a Date object
                    const date = result.date.toDate ? result.date.toDate() : new Date(result.date);
                    const formattedDate = date.toLocaleString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                    row.innerHTML = `
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${formattedDate}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${nameMap[result.subject] || result.subject}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${nameMap[result.grade] || result.grade}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${nameMap[result.semester] || result.semester}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-bold">${result.score}/10</td>
                    `;
                });
                historyTableContainer.appendChild(table);

            } catch (e) {
                console.error("Error fetching history from Firestore:", e);
                historyTableContainer.innerHTML = '<p class="text-center text-red-500">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠. L·ªói quy·ªÅn truy c·∫≠p ho·∫∑c k·∫øt n·ªëi.</p>';
            }
        }
        
        function hideHistory() {
            historyPanel.classList.add('hidden');
            adminPanel.classList.remove('hidden');
        }

        // --- C√ÅC H√ÄM LOGIC GAME (Gi·ªØ nguy√™n) ---
        function updateStartButtonState() { 
            if (selectedSubject && selectedGrade && selectedSemester) { 
                startBtn.disabled = false; 
                startBtn.classList.remove('bg-gray-500/50', 'cursor-not-allowed'); 
                startBtn.classList.add('bg-blue-600/70', 'hover:bg-blue-600/90'); 
            } else { 
                startBtn.disabled = true; 
                startBtn.classList.add('bg-gray-500/50', 'cursor-not-allowed'); 
                startBtn.classList.remove('bg-blue-600/70', 'hover:bg-blue-600/90'); 
            } 
        }
        function startGame() { 
            let allQuestions = questions[selectedSubject][selectedGrade][selectedSemester]; 
            currentQuestions = allQuestions.sort(() => 0.5 - Math.random()).slice(0, NUM_OF_QUESTIONS_PER_GAME); 
            currentQuestionIndex = 0; 
            score = 0; 
            selectionScreen.classList.add('hidden'); 
            gameScreen.classList.remove('hidden'); 
            resultsScreen.classList.add('hidden'); 
            displayQuestion(); 
        }
        function displayQuestion() { 
            document.getElementById('feedback-container').innerHTML = ''; 
            document.getElementById('next-btn').classList.add('hidden'); 
            const questionData = currentQuestions[currentQuestionIndex]; 
            document.getElementById('question-container').querySelector('p').textContent = questionData.question; 
            const optionsContainer = document.getElementById('options-container'); 
            optionsContainer.innerHTML = ''; 
            const shuffledOptions = [...questionData.options].sort(() => Math.random() - 0.5); 
            shuffledOptions.forEach(option => { 
                const button = document.createElement('button'); 
                button.textContent = option; 
                button.classList.add('answer-option', 'w-full', 'p-4', 'rounded-2xl', 'font-semibold', 'glass-btn', 'bg-white/20', 'hover:bg-white/40', 'text-gray-800'); /* Th√™m text-gray-800 */
                button.onclick = (e) => checkAnswer(e.target, questionData.answer); 
                optionsContainer.appendChild(button); 
            }); 
            document.getElementById('progress-text').textContent = `C√¢u ${currentQuestionIndex + 1}/${currentQuestions.length}`; 
            document.getElementById('score-text').textContent = `ƒêi·ªÉm: ${score / 2}/10`; 
        }
        function checkAnswer(selectedButton, correctAnswer) { 
            const allOptions = document.querySelectorAll('.answer-option'); 
            allOptions.forEach(btn => btn.disabled = true); 
            const feedbackContainer = document.getElementById('feedback-container'); 
            if (selectedButton.textContent == correctAnswer) { 
                score++; 
                selectedButton.classList.add('correct'); 
                feedbackContainer.textContent = 'üéâ ƒê√∫ng r·ªìi!'; 
            } else { 
                selectedButton.classList.add('incorrect'); 
                feedbackContainer.textContent = 'üò• Sai r·ªìi!'; 
                allOptions.forEach(btn => { 
                    if (btn.textContent == correctAnswer) { 
                        btn.classList.add('correct'); 
                    } 
                }); 
            } 
            document.getElementById('score-text').textContent = `ƒêi·ªÉm: ${score / 2}/10`; 
            document.getElementById('next-btn').classList.remove('hidden'); 
        }
        function nextQuestion() { 
            currentQuestionIndex++; 
            if (currentQuestionIndex < currentQuestions.length) { 
                displayQuestion(); 
            } else { 
                showResults(); 
            } 
        }
        function showResults() { 
            gameScreen.classList.add('hidden'); 
            resultsScreen.classList.remove('hidden'); 
            const finalScore = score / 2; // Score out of 10 (20 questions * 0.5 points per question)
            document.getElementById('final-score').textContent = `${finalScore}/10`; 
            const resultData = { date: serverTimestamp(), subject: selectedSubject, grade: selectedGrade, semester: selectedSemester, score: finalScore }; 
            saveResult(resultData); 
            const finalMessage = document.getElementById('final-message'); 
            const percentage = (score / currentQuestions.length) * 100; 
            if (percentage === 100) { 
                finalMessage.textContent = "Xu·∫•t s·∫Øc! B√© th·∫≠t l√† gi·ªèi!"; 
            } else if (percentage >= 70) { 
                finalMessage.textContent = "Gi·ªèi l·∫Øm! C·ªë g·∫Øng th√™m ch√∫t n·ªØa nh√©!"; 
            } else if (percentage >= 50) { 
                finalMessage.textContent = "L√†m t·ªët l·∫Øm! Ti·∫øp t·ª•c luy·ªán t·∫≠p nh√©!"; 
            } else { 
                finalMessage.textContent = "ƒê·ª´ng bu·ªìn, l·∫ßn sau s·∫Ω t·ªët h∆°n!"; 
            } 
        }
        function resetGame() { 
            resultsScreen.classList.add('hidden'); 
            selectionScreen.classList.remove('hidden'); 
            selectedSubject = null; 
            selectedGrade = null; 
            selectedSemester = null; 
            subjectBtns.forEach(btn => btn.classList.remove('selected')); 
            gradeBtns.forEach(btn => btn.classList.remove('selected')); 
            semesterBtns.forEach(btn => btn.classList.remove('selected')); 
            updateStartButtonState(); 
        }

        // --- H√ÄM X·ª¨ L√ù CHO ADMIN ---
        function showLoginModal() { loginModal.classList.remove('hidden'); setTimeout(() => loginModal.classList.remove('opacity-0'), 10); }
        function hideLoginModal() { loginModal.classList.add('opacity-0'); setTimeout(() => loginModal.classList.add('hidden'), 300); loginError.textContent = ''; loginForm.reset(); }
        function handleLogin(event) { 
            event.preventDefault(); 
            const username = loginForm.username.value; 
            const password = loginForm.password.value; 
            if (username === 'admin' && password === 'admin') { /* C·∫£nh b√°o: Hardcoded credentials! */
                hideLoginModal(); 
                selectionScreen.classList.add('hidden'); 
                adminPanel.classList.remove('hidden'); 
            } else { 
                loginError.textContent = 'T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.'; 
            } 
        }
        function handleLogout() { adminPanel.classList.add('hidden'); selectionScreen.classList.remove('hidden'); resetGame(); }

        // --- G·∫ÆN S·ª∞ KI·ªÜN ---
        subjectBtns.forEach(btn => btn.addEventListener('click', () => { selectedSubject = btn.dataset.subject; subjectBtns.forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); updateStartButtonState(); }));
        gradeBtns.forEach(btn => btn.addEventListener('click', () => { selectedGrade = btn.dataset.grade; gradeBtns.forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); updateStartButtonState(); }));
        semesterBtns.forEach(btn => btn.addEventListener('click', () => { selectedSemester = btn.dataset.semester; semesterBtns.forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); updateStartButtonState(); }));
        startBtn.addEventListener('click', () => { if (!startBtn.disabled) startGame(); });
        document.getElementById('next-btn').addEventListener('click', nextQuestion);
        document.getElementById('play-again-btn').addEventListener('click', resetGame);
        adminLoginBtn.addEventListener('click', showLoginModal);
        closeModalBtn.addEventListener('click', hideLoginModal);
        loginModal.addEventListener('click', (e) => { if (e.target === loginModal) hideLoginModal(); });
        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        viewHistoryBtn.addEventListener('click', displayHistory);
        backToAdminBtn.addEventListener('click', hideHistory);
        
        // --- KH·ªûI CH·∫†Y ·ª®NG D·ª§NG ---
        initializeFirebase();

    </script>
</body>
</html>
