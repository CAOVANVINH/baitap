<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≤ Ch∆°i H·ªçc T·∫≠p Vui</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Quicksand -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tone.js for Sound Effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(to right top, #6d8cf0, #8d8de0, #a98fcb, #be93b6, #ce99a6);
        }
        .glass-container {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .glass-btn {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.2s ease-in-out;
            color: #2d3748;
        }
        #start-btn, #next-btn, #admin-login-btn, #logout-btn, #view-history-btn, #back-to-admin-btn, #leaderboard-btn, #back-to-menu-btn, .name-btn, #save-settings-btn {
            color: white;
        }
        #admin-login-btn, #leaderboard-btn {
            color: #cbd5e0;
        }
        .choice-btn.selected {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            border-width: 2px;
            border-color: rgba(255, 255, 255, 0.7);
        }
        .answer-option.correct {
            background-color: rgba(34, 197, 94, 0.7) !important;
            border-color: rgba(22, 163, 74, 0.8);
            color: white !important;
        }
        .answer-option.incorrect {
            background-color: rgba(239, 68, 68, 0.7) !important;
            border-color: rgba(220, 38, 38, 0.8);
            color: white !important;
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        #history-table-container, #leaderboard-table-container, #history-detail-content {
            max-height: 400px;
            overflow-y: auto;
        }
        .speaker-btn, #sound-toggle-btn {
            cursor: pointer;
            transition: transform 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .speaker-btn:hover, #sound-toggle-btn:hover {
            transform: scale(1.1);
            color: #6366f1;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-3xl mx-auto glass-container rounded-3xl shadow-2xl p-4 md:p-8 relative">
        <!-- Sound Toggle Button -->
        <button id="sound-toggle-btn" class="absolute top-4 left-5 text-white focus:outline-none z-10">
            <svg id="speaker-on-icon" xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="currentColor"><path d="M18.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM5 10v4h3l4 4V6l-4 4H5z"></path><path d="M16 8.5v7l-4-4H8V8.5h4l4-4zM19 12c0 2.8-1.56 5.28-3.8 6.5l1.2 1.5c2.95-1.7 5.1-4.86 5.1-8.5s-2.15-6.8-5.1-8.5L15.2 5.5C17.44 6.72 19 9.2 19 12z"></path></svg>
            <svg id="speaker-off-icon" xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"></path></svg>
        </button>

        <!-- Selection Screen -->
        <div id="selection-screen">
            <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-2">Tr√≤ Ch∆°i H·ªçc T·∫≠p</h1>
            <p class="text-center text-gray-700 mb-6">C√πng b√© v·ª´a h·ªçc v·ª´a ch∆°i!</p>
            <div id="loading-questions" class="text-center text-gray-600 font-semibold mb-4"><p>ƒêang t·∫£i d·ªØ li·ªáu, vui l√≤ng ch·ªù...</p></div>
            <div id="selections-container" class="hidden">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-3 text-gray-700">1. Ch·ªçn M√¥n H·ªçc</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button data-subject="toan" class="choice-btn glass-btn bg-sky-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-sky-500/60">üî¢ To√°n H·ªçc</button>
                        <button data-subject="tiengviet" class="choice-btn glass-btn bg-emerald-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-emerald-500/60">‚úçÔ∏è Ti·∫øng Vi·ªát</button>
                    </div>
                </div>
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-3 text-gray-700">2. Ch·ªçn L·ªõp</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button data-grade="lop1" class="choice-btn glass-btn bg-amber-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-amber-500/60">L·ªõp 1</button>
                        <button data-grade="lop2" class="choice-btn glass-btn bg-rose-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-rose-500/60">L·ªõp 2</button>
                    </div>
                </div>
                <div class="mb-8">
                    <h2 class="text-xl font-semibold mb-3 text-gray-700">3. Ch·ªçn H·ªçc K·ª≥</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button data-semester="hocky1" class="choice-btn glass-btn bg-purple-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-purple-500/60">H·ªçc K·ª≥ 1</button>
                        <button data-semester="hocky2" class="choice-btn glass-btn bg-pink-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-pink-500/60">H·ªçc K·ª≥ 2</button>
                    </div>
                </div>
            </div>
            <button id="start-btn" class="w-full glass-btn bg-gray-500/50 text-white font-bold py-4 rounded-2xl text-xl shadow-lg cursor-not-allowed" disabled>B·∫Øt ƒë·∫ßu!</button>
            <!-- Error message container -->
            <p id="start-error" class="text-red-600 font-bold text-center text-sm h-5 mt-2"></p>
            <div class="flex justify-between items-center mt-4">
                <button id="leaderboard-btn" class="text-sm font-semibold hover:text-white">üèÜ B·∫£ng X·∫øp H·∫°ng</button>
                <button id="admin-login-btn" class="text-sm font-semibold hover:text-white">Qu·∫£n tr·ªã vi√™n</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden">
             <div class="flex justify-between items-center mb-4 text-white">
                 <div id="progress-text" class="font-semibold">C√¢u 1/10</div>
                 <div id="timer-display" class="font-bold text-lg hidden"></div>
                 <div id="score-text" class="font-bold text-lg">ƒêi·ªÉm: 0</div>
             </div>
             <div id="question-container" class="bg-black/10 p-6 rounded-2xl text-center mb-6 min-h-[100px] flex items-center justify-center relative">
                 <p class="text-xl md:text-2xl font-semibold text-white"></p>
                 <button id="read-question-btn" class="speaker-btn absolute top-4 right-4 text-white focus:outline-none">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7"><path d="M13.5 4.06c0-1.34 1.61-2.26 2.86-1.48l.29.18c.54.33.86.94.86 1.58v13.32c0 .64-.32 1.25-.86 1.58l-.29.18c-1.25.78-2.86-.14-2.86-1.48V4.06ZM5.5 4.06c0-1.34 1.61-2.26 2.86-1.48l.29.18c.54.33.86.94.86 1.58v13.32c0 .64-.32 1.25-.86 1.58l-.29.18c-1.25.78-2.86-.14-2.86-1.48V4.06Z" /></svg>
                 </button>
             </div>
             <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
             <div id="feedback-container" class="text-center mt-4 font-bold text-2xl h-8 text-white"></div>
             <div id="explanation-container" class="hidden relative mt-2 bg-black/10 p-4 rounded-2xl text-white text-center font-medium">
                  <p id="explanation-text" class="pr-10"></p>
                  <button id="read-explanation-btn" class="speaker-btn absolute top-1/2 -translate-y-1/2 right-3 text-white focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M13.5 4.06c0-1.34 1.61-2.26 2.86-1.48l.29.18c.54.33.86.94.86 1.58v13.32c0 .64-.32 1.25-.86 1.58l-.29.18c-1.25.78-2.86-.14-2.86-1.48V4.06ZM5.5 4.06c0-1.34 1.61-2.26 2.86-1.48l.29.18c.54.33.86.94.86 1.58v13.32c0 .64-.32 1.25-.86 1.58l-.29.18c-1.25.78-2.86-.14-2.86-1.48V4.06Z" /></svg>
                  </button>
             </div>
             <button id="next-btn" class="hidden w-full mt-4 glass-btn bg-blue-500/60 text-white font-bold py-3 rounded-2xl shadow-lg hover:bg-blue-500/80">C√¢u ti·∫øp theo</button>
        </div>
        
        <!-- Admin & History Panels -->
        <div id="admin-panel" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">B·∫£ng ƒëi·ªÅu khi·ªÉn Admin</h2>
            <div class="space-y-4">
                <button id="view-history-btn" class="w-full glass-btn bg-indigo-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-indigo-500/80">Xem L·ªãch S·ª≠ Thi</button>
                <div class="mt-8 border-t pt-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">C√†i ƒë·∫∑t ƒê·ªìng h·ªì</h3>
                    <div class="space-y-4 max-w-sm mx-auto">
                        <div class="flex items-center justify-between p-3 bg-white/20 rounded-xl">
                            <label for="timer-toggle" class="font-medium text-gray-800">B·∫≠t ƒê·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c</label>
                            <input type="checkbox" id="timer-toggle" class="h-6 w-6 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        </div>
                        <div class="flex items-center justify-between p-3 bg-white/20 rounded-xl">
                            <label for="timer-duration" class="font-medium text-gray-800">Th·ªùi gian (gi√¢y)</label>
                            <input type="number" id="timer-duration" min="5" max="120" class="w-24 px-3 py-1 border border-gray-300/50 rounded-lg bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">
                        </div>
                        <button id="save-settings-btn" class="w-full glass-btn bg-green-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-green-500/80">L∆∞u C√†i ƒê·∫∑t</button>
                        <p id="settings-feedback" class="text-center text-sm text-green-800 font-bold h-4"></p>
                    </div>
                </div>
                <button id="logout-btn" class="w-full glass-btn bg-red-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-red-500/80 mt-8">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
        <div id="history-panel" class="hidden"><h2 class="text-3xl font-bold text-gray-800 mb-4 text-center">L·ªãch S·ª≠ L√†m B√†i</h2><div id="history-table-container" class="overflow-x-auto bg-white/50 rounded-2xl p-4"></div><button id="back-to-admin-btn" class="w-full mt-6 glass-btn bg-gray-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-gray-500/80">Quay l·∫°i</button></div>
        
        <!-- Leaderboard Panel -->
        <div id="leaderboard-panel" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-4 text-center">üèÜ B·∫£ng X·∫øp H·∫°ng üèÜ</h2>
            <div class="flex flex-wrap justify-center items-center gap-4 mb-4">
                <select id="leaderboard-subject-filter" class="glass-btn bg-white/30 rounded-lg px-3 py-2 font-semibold text-gray-800">
                    <option value="all">T·∫•t c·∫£ m√¥n</option>
                    <option value="toan">To√°n H·ªçc</option>
                    <option value="tiengviet">Ti·∫øng Vi·ªát</option>
                </select>
                <select id="leaderboard-grade-filter" class="glass-btn bg-white/30 rounded-lg px-3 py-2 font-semibold text-gray-800">
                    <option value="all">T·∫•t c·∫£ l·ªõp</option>
                    <option value="lop1">L·ªõp 1</option>
                    <option value="lop2">L·ªõp 2</option>
                </select>
                <input type="text" id="leaderboard-name-filter" placeholder="L·ªçc theo t√™n..." class="glass-btn bg-white/30 rounded-lg px-3 py-2 font-semibold text-gray-800 placeholder-gray-600">
            </div>
            <div id="leaderboard-table-container" class="overflow-x-auto bg-white/50 rounded-2xl p-4"></div>
            <button id="back-to-menu-btn" class="w-full mt-6 glass-btn bg-gray-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-gray-500/80">Ch∆°i L·∫°i</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="login-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0"><div class="glass-container rounded-3xl shadow-2xl p-8 w-full max-w-sm relative"><h2 class="text-2xl font-bold text-center text-gray-800 mb-6">ƒêƒÉng Nh·∫≠p Admin</h2><form id="login-form"><div class="mb-4"><label for="username" class="block text-gray-700 font-semibold mb-2">T√™n ƒëƒÉng nh·∫≠p</label><input type="text" id="username" class="w-full px-4 py-2 border border-gray-300/50 rounded-2xl bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800"></div><div class="mb-6"><label for="password" class="block text-gray-700 font-semibold mb-2">M·∫≠t kh·∫©u</label><input type="password" id="password" class="w-full px-4 py-2 border border-gray-300/50 rounded-2xl bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800"></div><p id="login-error" class="text-red-500 text-center text-sm h-4 mb-4"></p><button type="submit" class="w-full glass-btn bg-blue-600/70 text-white font-bold py-3 rounded-2xl hover:bg-blue-600/90">ƒêƒÉng nh·∫≠p</button></form><button id="close-modal-btn" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-2xl">&times;</button></div></div>
    
    <div id="name-selection-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0">
        <div class="glass-container rounded-3xl shadow-2xl p-8 w-full max-w-sm relative text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Ho√†n th√†nh!</h2>
            <p id="modal-final-score" class="text-6xl font-bold text-blue-600 my-4">0/10</p>
            <p id="modal-final-message" class="text-lg text-gray-600 mb-6">B√© ƒë√£ l√†m r·∫•t t·ªët! H√£y ch·ªçn t√™n c·ªßa m√¨nh ƒë·ªÉ l∆∞u ƒëi·ªÉm nh√©.</p>
            <div id="name-selection-container" class="space-y-3">
                <button data-name="Th·∫£o Huy·ªÅn" class="name-btn w-full glass-btn bg-pink-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-pink-500/80">Th·∫£o Huy·ªÅn</button>
                <button data-name="H·∫±ng Nga" class="name-btn w-full glass-btn bg-indigo-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-indigo-500/80">H·∫±ng Nga</button>
            </div>
            <button id="skip-and-play-again-btn" class="w-full mt-6 text-gray-600 font-semibold hover:text-gray-800 text-sm">Ch∆°i L·∫°i (Kh√¥ng l∆∞u)</button>
        </div>
    </div>

    <div id="history-detail-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0">
        <div class="glass-container rounded-3xl shadow-2xl p-8 w-full max-w-2xl relative">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Chi Ti·∫øt L·∫ßn Ch∆°i</h2>
            <div id="history-detail-summary" class="text-center text-gray-700 mb-4"></div>
            <div id="history-detail-content" class="space-y-3 bg-white/30 p-4 rounded-2xl">
                <!-- Detailed results will be injected here -->
            </div>
            <button id="close-history-detail-btn" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-3xl">&times;</button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, serverTimestamp, doc, getDoc, setDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- SOUND EFFECTS SETUP ---
        let soundsEnabled = true;
        const synths = {
            click: new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 } }).toDestination(),
            correct: new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.005, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination(),
            incorrect: new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.4, sustain: 0, release: 0.2 } }).toDestination(),
            complete: new Tone.PolySynth(Tone.Synth).toDestination()
        };
        function playSound(soundType) {
            if (!soundsEnabled || !Tone.context.state === 'running') return;
            try {
                switch (soundType) {
                    case 'click': synths.click.triggerAttackRelease("C5", "8n"); break;
                    case 'correct': synths.correct.triggerAttackRelease("G5", "8n", Tone.now()); break;
                    case 'incorrect': synths.incorrect.triggerAttackRelease("C3", "8n"); break;
                    case 'complete': const now = Tone.now(); synths.complete.triggerAttackRelease(["C4", "E4", "G4"], "8n", now); synths.complete.triggerAttackRelease(["E4", "G4", "B4"], "8n", now + 0.2); synths.complete.triggerAttackRelease(["G4", "B4", "D5"], "8n", now + 0.4); break;
                }
            } catch (error) { console.error("Sound play error:", error); }
        }

        // --- EXPANDED LOCAL QUESTION SEED DATA ---
        const localQuestionSeedData = {
            version: 2.0, // Used to force update the question bank in Firestore
            toan: {
                lop1: {
                    hocky1: [
                        { question: "5 + 4 = ?", options: [8, 9, 10, 7], answer: 9 },
                        { question: "8 - 3 = ?", options: [4, 5, 6, 7], answer: 5 },
                        { question: "S·ªë li·ªÅn sau c·ªßa 9 l√†?", options: [8, 10, 11, 7], answer: 10 },
                        { question: "C√≥ m·∫•y h√¨nh tr√≤n: üîµ üî∫ üîµ ‚¨ú", options: [1, 2, 3, 4], answer: 2 },
                        { question: "2 + 6 = ?", options: [7, 8, 9, 10], answer: 8 },
                        { question: "S·ªë li·ªÅn tr∆∞·ªõc c·ªßa 7 l√†?", options: [5, 6, 8, 9], answer: 6 },
                        { question: "H√¨nh vu√¥ng c√≥ m·∫•y c·∫°nh?", options: [2, 3, 4, 5], answer: 4 },
                        { question: "ƒêi·ªÅn d·∫•u th√≠ch h·ª£p: 5 + 3 ... 8", options: ["<", ">", "="], answer: "=" },
                        { question: "7 + ... = 10", options: [1, 2, 3, 4], answer: 3 },
                        { question: "S·ªë b√© nh·∫•t trong c√°c s·ªë: 9, 3, 7, 5 l√†?", options: [9, 3, 7, 5], answer: 3 },
                        { question: "S·ªë l·ªõn nh·∫•t trong c√°c s·ªë: 2, 8, 4, 10 l√†?", options: [2, 8, 4, 10], answer: 10 },
                        { question: "Ph√©p t√≠nh n√†o c√≥ k·∫øt qu·∫£ b·∫±ng 6?", options: ["3 + 2", "9 - 3", "4 + 3"], answer: "9 - 3" },
                        { question: "S·∫Øp x·∫øp c√°c s·ªë sau theo th·ª© t·ª± t·ª´ b√© ƒë·∫øn l·ªõn: 5, 2, 9, 1", options: ["1, 2, 5, 9", "9, 5, 2, 1", "1, 5, 2, 9"], answer: "1, 2, 5, 9" },
                        { question: "C√≥ 4 qu·∫£ t√°o, th√™m 3 qu·∫£ t√°o n·ªØa. C√≥ t·∫•t c·∫£ m·∫•y qu·∫£ t√°o?", options: [6, 7, 8, 1], answer: 7 },
                        { question: "H√¨nh n√†o kh√°c v·ªõi c√°c h√¨nh c√≤n l·∫°i: üî¥ üî¥ üî∑ üî¥", options: ["H√¨nh tr√≤n", "H√¨nh vu√¥ng", "T·∫•t c·∫£ ƒë·ªÅu gi·ªëng nhau"], answer: "H√¨nh vu√¥ng" },
                        { question: "10 - ... = 4", options: [5, 6, 7, 8], answer: 6 },
                        { question: "Trong c√°c s·ªë 1, 5, 0, 8, s·ªë n√†o l√† s·ªë 0?", options: [1, 5, 0, 8], answer: 0 },
                        { question: "C√≥ bao nhi√™u √¥ vu√¥ng trong h√¨nh n√†y: ‚¨úÔ∏è‚¨úÔ∏è‚¨úÔ∏è", options: [2, 3, 4, 1], answer: 3 },
                    ],
                    hocky2: [
                        { question: "10 + 6 = ?", options: [15, 16, 17, 18], answer: 16 },
                        { question: "18 - 5 = ?", options: [12, 13, 14, 15], answer: 13 },
                        { question: "S·ªë g·ªìm 1 ch·ª•c v√† 7 ƒë∆°n v·ªã l√†?", options: [10, 7, 17, 71], answer: 17 },
                        { question: "H√¥m nay l√† th·ª© Hai, ng√†y mai l√† th·ª© m·∫•y?", options: ["Ch·ªß Nh·∫≠t", "Th·ª© Ba", "Th·ª© T∆∞"], answer: "Th·ª© Ba" },
                        { question: "Lan c√≥ 8 k·∫πo, m·∫π cho th√™m 5. Lan c√≥ t·∫•t c·∫£...c√°i k·∫πo?", options: [12, 13, 14, 3], answer: 13 },
                        { question: "15 - 7 = ?", options: [6, 7, 8, 9], answer: 8 },
                        { question: "Kim ng·∫Øn ch·ªâ s·ªë 3, kim d√†i ch·ªâ s·ªë 12. L√† m·∫•y gi·ªù?", options: ["12 gi·ªù 3 ph√∫t", "3 gi·ªù 12 ph√∫t", "3 gi·ªù ƒë√∫ng", "12 gi·ªù 15 ph√∫t"], answer: "3 gi·ªù ƒë√∫ng" },
                        { question: "An c√≥ 12 vi√™n bi, An cho B√¨nh 5 vi√™n. H·ªèi An c√≤n l·∫°i m·∫•y vi√™n bi?", options: [17, 7, 8, 6], answer: 7 },
                        { question: "ƒêi·ªÅn d·∫•u th√≠ch h·ª£p v√†o ch·ªó ch·∫•m: 19 ... 16", options: ["<", ">", "="], answer: ">" },
                        { question: "S·ªë 14 g·ªìm m·∫•y ch·ª•c v√† m·∫•y ƒë∆°n v·ªã?", options: ["4 ch·ª•c 1 ƒë∆°n v·ªã", "1 ch·ª•c 4 ƒë∆°n v·ªã", "10 ch·ª•c 4 ƒë∆°n v·ªã"], answer: "1 ch·ª•c 4 ƒë∆°n v·ªã" },
                        { question: "S·ªë li·ªÅn sau c·ªßa 29 l√†?", options: [28, 30, 31, 20], answer: 30 },
                        { question: "S·ªë 50 ƒë·ªçc l√† g√¨?", options: ["NƒÉm m∆∞∆°i", "M∆∞·ªùi lƒÉm", "NƒÉm kh√¥ng"], answer: "NƒÉm m∆∞∆°i" },
                        { question: "40 + 30 = ?", options: [60, 70, 80, 50], answer: 70 },
                        { question: "90 - 20 = ?", options: [60, 70, 80, 50], answer: 70 },
                        { question: "ƒêo·∫°n th·∫≥ng AB d√†i 10cm, ƒëo·∫°n th·∫≥ng CD d√†i 8cm. ƒêo·∫°n th·∫≥ng n√†o d√†i h∆°n?", options: ["AB", "CD", "B·∫±ng nhau"], answer: "AB" },
                        { question: "M·ªôt tu·∫ßn l·ªÖ c√≥ m·∫•y ng√†y?", options: [5, 6, 7, 8], answer: 7 },
                        { question: "S·ªë tr√≤n ch·ª•c l·ªõn nh·∫•t c√≥ 2 ch·ªØ s·ªë l√†?", options: [90, 99, 100, 80], answer: 90 },
                        { question: "L·ªõp 1A c√≥ 20 b·∫°n nam v√† 15 b·∫°n n·ªØ. L·ªõp 1A c√≥ t·∫•t c·∫£ bao nhi√™u b·∫°n?", options: [30, 35, 40, 25], answer: 35 },
                    ]
                },
                lop2: {
                    hocky1: [
                        { question: "35 + 24 = ?", options: [58, 59, 69, 60], answer: 59 },
                        { question: "78 - 45 = ?", options: [33, 32, 43, 23], answer: 33 },
                        { question: "S·ªë 56 ƒë·ªçc l√† g√¨?", options: ["NƒÉm s√°u", "NƒÉm m∆∞∆°i s√°u", "S√°u m∆∞∆°i nƒÉm", "NƒÉm m∆∞∆°i s√°u lƒÉm"], answer: "NƒÉm m∆∞∆°i s√°u" },
                        { question: "1 m√©t b·∫±ng bao nhi√™u xƒÉng-ti-m√©t?", options: ["10 cm", "100 cm", "1000 cm", "1 cm"], answer: "100 cm" },
                        { question: "T√¨m x, bi·∫øt x + 15 = 40", options: [25, 35, 55, 15], answer: 25 },
                        { question: "Trong ph√©p t√≠nh 4 x 5 = 20, s·ªë 4 ƒë∆∞·ª£c g·ªçi l√† g√¨?", options: ["T√≠ch", "Th·ª´a s·ªë", "T·ªïng", "Hi·ªáu"], answer: "Th·ª´a s·ªë" },
                        { question: "Th·ª© t∆∞ tu·∫ßn n√†y l√† ng√†y 10, v·∫≠y th·ª© t∆∞ tu·∫ßn sau l√† ng√†y m·∫•y?", options: [16, 17, 18, 11], answer: 17 },
                        { question: "2 x 8 = ?", options: [10, 14, 16, 18], answer: 16 },
                        { question: "C√≥ 15 qu·∫£ cam chia ƒë·ªÅu v√†o 3 ƒëƒ©a. M·ªói ƒëƒ©a c√≥ m·∫•y qu·∫£ cam?", options: [3, 4, 5, 6], answer: 5 },
                        { question: "S·ªë l·ªõn nh·∫•t c√≥ hai ch·ªØ s·ªë l√† s·ªë n√†o?", options: [90, 98, 99, 100], answer: 99 },
                        { question: "K·∫øt qu·∫£ c·ªßa ph√©p t√≠nh 27 + 35 l√†?", options: [52, 62, 51, 61], answer: 62 },
                        { question: "Hi·ªáu c·ªßa 64 v√† 28 l√†?", options: [36, 46, 34, 44], answer: 36 },
                        { question: "T√¨m x, bi·∫øt 50 - x = 25", options: [25, 35, 75], answer: 25 },
                        { question: "Trong ph√©p chia 18 : 2 = 9, s·ªë 18 ƒë∆∞·ª£c g·ªçi l√† g√¨?", options: ["S·ªë chia", "Th∆∞∆°ng", "S·ªë b·ªã chia"], answer: "S·ªë b·ªã chia" },
                        { question: "1 dm = ... cm?", options: [1, 10, 100], answer: 10 },
                        { question: "T·ªïng c·ªßa s·ªë l·ªõn nh·∫•t c√≥ m·ªôt ch·ªØ s·ªë v√† s·ªë b√© nh·∫•t c√≥ hai ch·ªØ s·ªë l√†?", options: [18, 19, 20, 91], answer: 19 },
                        { question: "M·∫π mua 2 ch·ª•c qu·∫£ tr·ª©ng, m·∫π ƒë√£ d√πng h·∫øt 5 qu·∫£. M·∫π c√≤n l·∫°i bao nhi√™u qu·∫£ tr·ª©ng?", options: [15, 25, 10], answer: 15 },
                    ],
                    hocky2: [
                        { question: "5 x 9 = ?", options: [40, 45, 50, 54], answer: 45 },
                        { question: "36 : 4 = ?", options: [7, 8, 9, 10], answer: 9 },
                        { question: "M·ªôt ph·∫ßn ba c·ªßa 27 l√† bao nhi√™u?", options: [7, 8, 9, 3], answer: 9 },
                        { question: "ƒê·ªìng h·ªì ch·ªâ 8 gi·ªù 30 ph√∫t. Kim ph√∫t ch·ªâ v√†o s·ªë m·∫•y?", options: [3, 6, 8, 12], answer: 6 },
                        { question: "M·ªôt c·ª≠a h√†ng bu·ªïi s√°ng b√°n ƒë∆∞·ª£c 150kg g·∫°o, bu·ªïi chi·ªÅu b√°n ƒë∆∞·ª£c nhi·ªÅu h∆°n bu·ªïi s√°ng 50kg. C·∫£ hai bu·ªïi b√°n ƒë∆∞·ª£c bao nhi√™u kg g·∫°o?", options: [200, 250, 350, 300], answer: 350 },
                        { question: "H√¨nh ch·ªØ nh·∫≠t c√≥ m·∫•y g√≥c vu√¥ng?", options: [1, 2, 3, 4], answer: 4 },
                        { question: "ƒêi·ªÅn s·ªë th√≠ch h·ª£p: 8, 12, 16, ..., 24", options: [18, 20, 22, 19], answer: 20 },
                        { question: "1000 - 300 = ?", options: [600, 700, 800, 500], answer: 700 },
                        { question: "Chu vi h√¨nh tam gi√°c c√≥ ba c·∫°nh b·∫±ng nhau, m·ªói c·∫°nh d√†i 8cm l√†:", options: ["16cm", "24cm", "32cm", "11cm"], answer: "24cm" },
                        { question: "S·ªë b√© nh·∫•t c√≥ ba ch·ªØ s·ªë kh√°c nhau l√† s·ªë n√†o?", options: [100, 111, 102, 123], answer: 102 },
                        { question: "T√¨m y, bi·∫øt y x 5 = 40", options: [6, 7, 8, 9], answer: 8 },
                        { question: "1/4 c·ªßa 20 l√†?", options: [4, 5, 6, 16], answer: 5 },
                        { question: "B·ªë 36 tu·ªïi, con 9 tu·ªïi. Tu·ªïi b·ªë g·∫•p m·∫•y l·∫ßn tu·ªïi con?", options: [3, 4, 5, 27], answer: 4 },
                        { question: "S·ªë 758 g·ªìm m·∫•y trƒÉm, m·∫•y ch·ª•c, m·∫•y ƒë∆°n v·ªã?", options: ["7 trƒÉm, 5 ch·ª•c, 8 ƒë∆°n v·ªã", "8 trƒÉm, 5 ch·ª•c, 7 ƒë∆°n v·ªã", "7 trƒÉm, 8 ch·ª•c, 5 ƒë∆°n v·ªã"], answer: "7 trƒÉm, 5 ch·ª•c, 8 ƒë∆°n v·ªã" },
                        { question: "Chu vi h√¨nh vu√¥ng c√≥ c·∫°nh 6m l√†?", options: ["12m", "24m", "36m"], answer: "24m" },
                        { question: "C√≥ 45 h·ªçc sinh x·∫øp th√†nh 5 h√†ng ƒë·ªÅu nhau. H·ªèi m·ªói h√†ng c√≥ bao nhi√™u h·ªçc sinh?", options: [8, 9, 10, 7], answer: 9 },
                        { question: "Ng√†y 25 th√°ng 4 l√† th·ª© ba, v·∫≠y ng√†y 1 th√°ng 5 c√πng nƒÉm ƒë√≥ l√† th·ª© m·∫•y?", options: ["Th·ª© hai", "Th·ª© ba", "Th·ª© t∆∞"], answer: "Th·ª© hai" },
                    ]
                }
            },
            tiengviet: {
                lop1: {
                    hocky1: [
                        { question: "Ch·ªØ c√°i n√†o ƒë·ª©ng sau 'a' trong b·∫£ng ch·ªØ c√°i?", options: ["c", "b", "d", "e"], answer: "b" },
                        { question: "T·ª´ n√†o ch·ªâ ho·∫°t ƒë·ªông 'ƒÉn'?", options: ["Ng·ªß", "Ch∆°i", "ƒÇn", "H·ªçc"], answer: "ƒÇn" },
                        { question: "ƒêi·ªÅn t·ª´ c√≤n thi·∫øu: 'Con ... ƒëang b∆°i.'", options: ["chim", "c√°", "m√®o", "ch√≥"], answer: "c√°" },
                        { question: "T·ª´ n√†o c√≥ v·∫ßn 'ai'?", options: ["C√°i", "Con", "S√°ch", "B√∫t"], answer: "C√°i" },
                        { question: "Ch·ªØ c√°i n√†o ƒë·ª©ng tr∆∞·ªõc 'd' trong b·∫£ng ch·ªØ c√°i?", options: ["c", "e", "f", "b"], answer: "c" },
                        { question: "Gh√©p √¢m 'nh' v√† v·∫ßn 'a' ta ƒë∆∞·ª£c ti·∫øng g√¨?", options: ["na", "anh", "nha", "han"], answer: "nha" },
                        { question: "T√¨m t·ª´ c√≥ v·∫ßn '∆∞∆°n'.", options: ["V∆∞·ªùn", "C∆°m", "Cam", "B√°nh"], answer: "V∆∞·ªùn" },
                        { question: "ƒêi·ªÅn v√†o ch·ªó tr·ªëng: '...√† n·ªôi em hi·ªÅn.'", options: ["B√†", "B√≤", "Ba"], answer: "B√†" },
                        { question: "S·∫Øp x·∫øp c√°c t·ª´ 's√†n', 'nh√†', 'em', '·ªü' th√†nh c√¢u c√≥ nghƒ©a.", options: ["Em ·ªü nh√† s√†n.", "Nh√† em ·ªü s√†n.", "S√†n nh√† em ·ªü."], answer: "Em ·ªü nh√† s√†n." },
                        { question: "Trong c√¢u 'Nh√† b√† c√≥ g√†. G√† c√≥ l√¥ng v√†ng.', g√† c√≥ l√¥ng m√†u g√¨?", options: ["V√†ng", "N√¢u", "ƒêen"], answer: "V√†ng" },
                        { question: "Ti·∫øng 's√°ch' c√≥ √¢m ƒë·∫ßu l√† g√¨?", options: ["s", "a", "ch"], answer: "s" },
                        { question: "V·∫ßn 'eo' c√≥ trong t·ª´ n√†o?", options: ["C√°i k√©o", "C√°i ca", "Con b√≤"], answer: "C√°i k√©o" },
                        { question: "ƒêi·ªÅn 'g' hay 'gh' v√†o ch·ªó tr·ªëng: 'C√°i ...·∫ø'", options: ["g", "gh"], answer: "gh" },
                        { question: "C√¢u 'B√© v·∫Ω' c√≥ m·∫•y ti·∫øng?", options: [1, 2, 3], answer: 2 },
                        { question: "T√¨m t·ª´ ch·ªâ ƒë·ªì v·∫≠t trong nh√†.", options: ["C√¢y b√†ng", "C√°i b√†n", "Con ƒë∆∞·ªùng"], answer: "C√°i b√†n" },
                        { question: "ƒêi·ªÅn v·∫ßn 'ay' ho·∫∑c '√¢y' v√†o ch·ªó tr·ªëng: 'M√°y c...'", options: ["ay", "√¢y"], answer: "√¢y" },
                    ],
                    hocky2: [
                        { question: "T·ª´ n√†o c√≥ ti·∫øng 's√°ch'?", options: ["Quy·ªÉn v·ªü", "B√∫t ch√¨", "S√°ch gi√°o khoa", "C√°i b√†n"], answer: "S√°ch gi√°o khoa" },
                        { question: "T·ª´ n√†o ƒë·ªìng nghƒ©a v·ªõi 'vui v·∫ª'?", options: ["Bu·ªìn b√£", "H√¢n hoan", "T·ª©c gi·∫≠n", "S·ª£ h√£i"], answer: "H√¢n hoan" },
                        { question: "ƒêi·ªÅn t·ª´ c√≤n thi·∫øu: 'B·∫ßu tr·ªùi cao v√† ...'", options: ["xanh", "ƒë·ªè", "v√†ng", "ƒëen"], answer: "xanh" },
                        { question: "ƒê·∫∑t c√¢u v·ªõi t·ª´ 'tr∆∞·ªùng h·ªçc'.", options: ["Em ƒëi h·ªçc.", "Tr∆∞·ªùng h·ªçc c·ªßa em r·∫•t ƒë·∫πp.", "C√¢y ph∆∞·ª£ng n·ªü hoa."], answer: "Tr∆∞·ªùng h·ªçc c·ªßa em r·∫•t ƒë·∫πp." },
                        { question: "T·ª´ n√†o tr√°i nghƒ©a v·ªõi 's·∫°ch s·∫Ω'?", options: ["NgƒÉn n·∫Øp", "G·ªçn g√†ng", "B·∫©n th·ªâu"], answer: "B·∫©n th·ªâu" },
                        { question: "ƒêi·ªÅn d·∫•u c√¢u th√≠ch h·ª£p: 'M·∫π em l√† c√¥ gi√°o_'", options: [".", "?", "!"], answer: "." },
                        { question: "Trong c√¢u 'B√¥ng hoa h·ªìng r·∫•t ƒë·∫πp', t·ª´ n√†o ch·ªâ ƒë·∫∑c ƒëi·ªÉm?", options: ["B√¥ng hoa", "h·ªìng", "ƒë·∫πp"], answer: "ƒë·∫πp" },
                        { question: "ƒê·ªì v·∫≠t n√†o sau ƒë√¢y c√≥ trong l·ªõp h·ªçc?", options: ["C√°i gi∆∞·ªùng", "C√°i b√†n", "C√°i t·ªß l·∫°nh"], answer: "C√°i b√†n" },
                        { question: "ƒêi·ªÅn 'ch' hay 'tr' v√†o ch·ªó tr·ªëng: '...ƒÉm h·ªçc'", options: ["ch", "tr"], answer: "ch" },
                        { question: "T·ª´ n√†o ch·ªâ m·ªôt lo√†i c√¢y?", options: ["Con ch√≥", "C√¢y b√†ng", "C√°i nh√†"], answer: "C√¢y b√†ng" },
                        { question: "C√¢u 'Ai tr·ªìng c√¢y?' l√† lo·∫°i c√¢u g√¨?", options: ["C√¢u k·ªÉ", "C√¢u h·ªèi", "C√¢u c·∫£m"], answer: "C√¢u h·ªèi" },
                        { question: "T·ª´ n√†o ch·ªâ ho·∫°t ƒë·ªông c·ªßa h·ªçc sinh?", options: ["Bu√¥n b√°n", "D·∫°y h·ªçc", "H·ªçc b√†i"], answer: "H·ªçc b√†i" },
                        { question: "S·∫Øp x·∫øp l·∫°i c√¢u: 'em, r·∫•t, y√™u, tr∆∞·ªùng, c·ªßa, em'", options: ["Em y√™u r·∫•t tr∆∞·ªùng c·ªßa em.", "Em r·∫•t y√™u tr∆∞·ªùng c·ªßa em."], answer: "Em r·∫•t y√™u tr∆∞·ªùng c·ªßa em." },
                        { question: "T·ª´ 'chƒÉm ch·ªâ' l√† t·ª´ ch·ªâ g√¨?", options: ["Ch·ªâ ng∆∞·ªùi", "Ch·ªâ ho·∫°t ƒë·ªông", "Ch·ªâ t√≠nh n·∫øt"], answer: "Ch·ªâ t√≠nh n·∫øt" },
                        { question: "ƒêi·ªÅn d·∫•u ch·∫•m than (!) v√†o cu·ªëi c√¢u n√†o?", options: ["B·∫°n t√™n l√† g√¨", "√îi, b√¥ng hoa ƒë·∫πp qu√°", "Em ƒëang h·ªçc b√†i"], answer: "√îi, b√¥ng hoa ƒë·∫πp qu√°" },
                    ]
                },
                lop2: {
                    hocky1: [
                        { question: "T·ª´ n√†o l√† t·ª´ ch·ªâ s·ª± v·∫≠t?", options: ["Ch·∫°y", "ƒê·∫πp", "C√°i b√†n", "Vui"], answer: "C√°i b√†n" },
                        { question: "T·ª´ n√†o l√† t·ª´ ch·ªâ ho·∫°t ƒë·ªông?", options: ["Con m√®o", "ƒê·ªçc s√°ch", "M√†u xanh", "Cao l·ªõn"], answer: "ƒê·ªçc s√°ch" },
                        { question: "T·ª´ n√†o kh√¥ng c√πng nh√≥m v·ªõi c√°c t·ª´ c√≤n l·∫°i: 'b√∫t, th∆∞·ªõc, s√°ch, ƒëi'?", options: ["b√∫t", "th∆∞·ªõc", "s√°ch", "ƒëi"], answer: "ƒëi" },
                        { question: "T√¨m 2 t·ª´ ch·ªâ ng∆∞·ªùi trong gia ƒë√¨nh.", options: ["Th·∫ßy c√¥, b·∫°n b√®", "√îng b√†, b·ªë m·∫π", "B√°c sƒ©, y t√°"], answer: "√îng b√†, b·ªë m·∫π" },
                        { question: "C√¢u 'M·∫π em l√† gi√°o vi√™n.' thu·ªôc m·∫´u c√¢u n√†o?", options: ["Ai l√† g√¨?", "Ai l√†m g√¨?", "Ai th·∫ø n√†o?"], answer: "Ai l√† g√¨?" },
                        { question: "T√¨m t·ª´ ƒë·ªìng nghƒ©a v·ªõi 'si√™ng nƒÉng'.", options: ["L∆∞·ªùi bi·∫øng", "ChƒÉm ch·ªâ", "Th√¥ng minh"], answer: "ChƒÉm ch·ªâ" },
                        { question: "ƒêi·ªÅn 'l' hay 'n' v√†o ch·ªó tr·ªëng: '...o l·∫Øng'", options: ["l", "n"], answer: "l" },
                        { question: "ƒêi·ªÅn 's' hay 'x' v√†o ch·ªó tr·ªëng: '...inh ƒë·∫πp'", options: ["s", "x"], answer: "x" },
                        { question: "ƒê·∫∑t c√¢u h·ªèi cho b·ªô ph·∫≠n ƒë∆∞·ª£c g·∫°ch ch√¢n: '<u>B·∫°n Lan</u> l√† m·ªôt h·ªçc sinh gi·ªèi.'", options: ["Ai l√† m·ªôt h·ªçc sinh gi·ªèi?", "B·∫°n Lan l√† g√¨?", "B·∫°n Lan th·∫ø n√†o?"], answer: "Ai l√† m·ªôt h·ªçc sinh gi·ªèi?" },
                        { question: "Trong c√¢u 'Tr√™n c√†nh c√¢y, chim h√≥t l√≠u lo.', d·∫•u ph·∫©y d√πng ƒë·ªÉ l√†m g√¨?", options: ["K·∫øt th√∫c c√¢u", "NgƒÉn c√°ch tr·∫°ng ng·ªØ v·ªõi n√≤ng c·ªët c√¢u", "Li·ªát k√™"], answer: "NgƒÉn c√°ch tr·∫°ng ng·ªØ v·ªõi n√≤ng c·ªët c√¢u" },
                        { question: "T·ª´ n√†o l√† t·ª´ ch·ªâ ƒë·∫∑c ƒëi·ªÉm?", options: ["C√°i c√¢y", "Cao", "ƒêi b·ªô"], answer: "Cao" },
                        { question: "C√¢u 'ƒê√†n c√° tung tƒÉng b∆°i l·ªôi.' thu·ªôc m·∫´u c√¢u n√†o?", options: ["Ai l√† g√¨?", "Con g√¨ l√†m g√¨?", "Ai th·∫ø n√†o?"], answer: "Con g√¨ l√†m g√¨?" },
                        { question: "T√¨m t·ª´ tr√°i nghƒ©a v·ªõi 'cao'.", options: ["To", "Th·∫•p", "D√†i"], answer: "Th·∫•p" },
                        { question: "B·ªô ph·∫≠n tr·∫£ l·ªùi c√¢u h·ªèi '·ªû ƒë√¢u?' trong c√¢u 'Em h·ªçc b√†i ·ªü trong ph√≤ng.' l√† g√¨?", options: ["Em", "h·ªçc b√†i", "·ªü trong ph√≤ng"], answer: "·ªü trong ph√≤ng" },
                        { question: "ƒêi·ªÅn 'r', 'd' hay 'gi' v√†o ch·ªó tr·ªëng: '...·ªØ g√¨n'", options: ["r", "d", "gi"], answer: "gi" },
                    ],
                    hocky2: [
                        { question: "C√¢u '√îng m·∫∑t tr·ªùi th·ª©c d·∫≠y' s·ª≠ d·ª•ng bi·ªán ph√°p ngh·ªá thu·∫≠t g√¨?", options: ["So s√°nh", "Nh√¢n h√≥a", "·∫®n d·ª•"], answer: "Nh√¢n h√≥a" },
                        { question: "T√¨m t·ª´ tr√°i nghƒ©a v·ªõi 'd≈©ng c·∫£m'.", options: ["Gan d·∫°", "Anh h√πng", "Nh√∫t nh√°t"], answer: "Nh√∫t nh√°t" },
                        { question: "C√¢u 'ƒê√†n b√≤ ƒëang g·∫∑m c·ªè.' thu·ªôc m·∫´u c√¢u n√†o?", options: ["Ai l√† g√¨?", "Ai l√†m g√¨?", "Ai th·∫ø n√†o?"], answer: "Ai l√†m g√¨?" },
                        { question: "D·∫•u hai ch·∫•m trong c√¢u 'B√† k·ªÉ: Ng√†y x∆∞a c√≥ m·ªôt n√†ng c√¥ng ch√∫a.' d√πng ƒë·ªÉ l√†m g√¨?", options: ["K·∫øt th√∫c c√¢u", "B√°o hi·ªáu l·ªùi n√≥i tr·ª±c ti·∫øp c·ªßa nh√¢n v·∫≠t", "Ng·∫Øt ngh·ªâ"], answer: "B√°o hi·ªáu l·ªùi n√≥i tr·ª±c ti·∫øp c·ªßa nh√¢n v·∫≠t" },
                        { question: "T√¨m t·ª´ ch·ªâ ƒë·∫∑c ƒëi·ªÉm trong c√¢u: 'M·∫∑t bi·ªÉn xanh bi·∫øc.'", options: ["M·∫∑t bi·ªÉn", "xanh bi·∫øc", "bi·ªÉn"], answer: "xanh bi·∫øc" },
                        { question: "C√¢u 'Tr∆∞·ªùng em xanh, s·∫°ch, ƒë·∫πp.' s·ª≠ d·ª•ng d·∫•u ph·∫©y ƒë·ªÉ l√†m g√¨?", options: ["NgƒÉn c√°ch c√°c b·ªô ph·∫≠n c√πng ch·ª©c v·ª•", "NgƒÉn c√°ch tr·∫°ng ng·ªØ", "B√°o hi·ªáu l·ªùi n√≥i"], answer: "NgƒÉn c√°ch c√°c b·ªô ph·∫≠n c√πng ch·ª©c v·ª•" },
                        { question: "Trong c√¢u 'Nh·ªØng ch√∫ g√† con lon ton ch·∫°y theo m·∫π.', t·ª´ n√†o l√† t·ª´ l√°y?", options: ["G√† con", "Ch·∫°y theo", "Lon ton"], answer: "Lon ton" },
                        { question: "ƒê·∫∑t c√¢u h·ªèi cho b·ªô ph·∫≠n g·∫°ch ch√¢n: 'Em t·∫∑ng m·∫π m·ªôt b√¥ng hoa <u>v√¨ h√¥m nay l√† sinh nh·∫≠t m·∫π</u>.'", options: ["Em t·∫∑ng m·∫π m·ªôt b√¥ng hoa khi n√†o?", "V√¨ sao em t·∫∑ng m·∫π m·ªôt b√¥ng hoa?", "Em t·∫∑ng m·∫π c√°i g√¨?"], answer: "V√¨ sao em t·∫∑ng m·∫π m·ªôt b√¥ng hoa?" },
                        { question: "C√¢u 'B·∫°n c√≥ th√≠ch ƒë·ªçc truy·ªán kh√¥ng?' l√† lo·∫°i c√¢u g√¨?", options: ["C√¢u k·ªÉ", "C√¢u h·ªèi", "C√¢u khi·∫øn"], answer: "C√¢u h·ªèi" },
                        { question: "T·ª´ 'T·ªï qu·ªëc' vi·∫øt hoa v√¨ l√Ω do g√¨?", options: ["ƒê·ª©ng ƒë·∫ßu c√¢u", "L√† danh t·ª´ ri√™ng", "L√† t·ª´ kh√≥"], answer: "L√† danh t·ª´ ri√™ng" },
                        { question: "Bi·ªán ph√°p so s√°nh ƒë∆∞·ª£c s·ª≠ d·ª•ng trong c√¢u n√†o sau ƒë√¢y?", options: ["M·∫∑t tr·ªùi ƒë·ªè nh∆∞ qu·∫£ c·∫ßu l·ª≠a.", "Gi√≥ th·ªïi √†o √†o.", "Ch·ªã tre ch·∫£i t√≥c b√™n ao."], answer: "M·∫∑t tr·ªùi ƒë·ªè nh∆∞ qu·∫£ c·∫ßu l·ª≠a." },
                        { question: "Ch·ªß ng·ªØ trong c√¢u 'Nh·ªØng b√¥ng hoa trong v∆∞·ªùn ƒëang khoe s·∫Øc.' l√† g√¨?", options: ["Nh·ªØng b√¥ng hoa", "Nh·ªØng b√¥ng hoa trong v∆∞·ªùn", "ƒëang khoe s·∫Øc"], answer: "Nh·ªØng b√¥ng hoa trong v∆∞·ªùn" },
                        { question: "H√£y lao ƒë·ªông th·∫≠t t·ªët! - l√† c√¢u g√¨?", options: ["C√¢u k·ªÉ", "C√¢u c·∫£m", "C√¢u khi·∫øn"], answer: "C√¢u khi·∫øn" },
                        { question: "T·ª´ n√†o vi·∫øt sai ch√≠nh t·∫£?", options: ["Ngh·ªâ ng∆°i", "Ngo·∫±n ngo√®o", "Ngho·∫πo c·ªï"], answer: "Ngho·∫πo c·ªï" },
                    ]
                }
            }
        };

        // --- STATE & DOM VARIABLES ---
        let db, auth, appId, questionBank, selectedSubject, selectedGrade, selectedSemester;
        let currentQuestions = [], currentQuestionIndex = 0, score = 0, sessionAnswers = [];
        const NUM_OF_QUESTIONS_PER_GAME = 10;
        let timerEnabled = false, timerDuration = 30, timerInterval;

        const screens = {
            selection: document.getElementById('selection-screen'),
            game: document.getElementById('game-screen'),
            admin: document.getElementById('admin-panel'),
            history: document.getElementById('history-panel'),
            leaderboard: document.getElementById('leaderboard-panel')
        };
        const modals = {
            login: document.getElementById('login-modal'),
            nameSelection: document.getElementById('name-selection-modal'),
            historyDetail: document.getElementById('history-detail-modal')
        };
        const leaderboardBtn = document.getElementById('leaderboard-btn');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        const leaderboardSubjectFilter = document.getElementById('leaderboard-subject-filter');
        const leaderboardGradeFilter = document.getElementById('leaderboard-grade-filter');
        const leaderboardNameFilter = document.getElementById('leaderboard-name-filter');

        // --- FIREBASE & DATA LOADING ---
        async function initializeFirebase() { try { let firebaseConfig; if (typeof __firebase_config !== 'undefined' && __firebase_config) { firebaseConfig = JSON.parse(__firebase_config); appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId; } else { console.warn("Using hardcoded fallback Firebase config."); firebaseConfig = { apiKey: "AIzaSyDJBY6U0LUtmnk4PrfNeA7UE7qq1FZ84X8", authDomain: "data-chung-a62ee.firebaseapp.com", projectId: "data-chung-a62ee", storageBucket: "data-chung-a62ee.appspot.com", messagingSenderId: "453115303161", appId: "1:453115303161:web:c885f876f4914829863e28" }; appId = firebaseConfig.appId; } if (!firebaseConfig.projectId) throw new Error("Firebase config is missing projectId."); const app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); if (typeof __initial_auth_token !== 'undefined') { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); } onAuthStateChanged(auth, (user) => { if (user) { console.log("User authenticated, loading data..."); Promise.all([loadAndSeedQuestions(), loadAdminSettings()]); } }); } catch (error) { console.error("Firebase initialization error:", error); document.getElementById('loading-questions').textContent = "L·ªói k·∫øt n·ªëi ƒë·∫øn c∆° s·ªü d·ªØ li·ªáu."; } }
        async function loadAndSeedQuestions() { if (!db || !appId) { console.error("Firestore DB or App ID not initialized."); return; } const questionBankRef = doc(db, `artifacts/${appId}/public/data/questions`, 'mainBank'); try { const docSnap = await getDoc(questionBankRef); if (docSnap.exists() && docSnap.data().version === 2.0) { questionBank = docSnap.data(); console.log("Loaded question bank version 2.0 from Firestore."); } else { console.log("Old question bank version or no data found. Seeding with new version 2.0."); await setDoc(questionBankRef, localQuestionSeedData); questionBank = localQuestionSeedData; } document.getElementById('loading-questions').classList.add('hidden'); document.getElementById('selections-container').classList.remove('hidden'); updateStartButtonState(); } catch (error) { console.error("Error loading or seeding questions:", error); document.getElementById('loading-questions').textContent = "L·ªói khi t·∫£i c√¢u h·ªèi."; } }
        async function loadAdminSettings() { if (!db || !appId) { return; } const settingsRef = doc(db, `artifacts/${appId}/public/data/adminSettings`, 'config'); try { const docSnap = await getDoc(settingsRef); if (docSnap.exists()) { const settings = docSnap.data(); timerEnabled = settings.timerEnabled ?? false; timerDuration = settings.timerDuration ?? 30; console.log("Admin settings loaded:", {timerEnabled, timerDuration}); } else { console.log("No admin settings found, using defaults."); } } catch (error) { console.error("Error loading admin settings:", error); } }
        
        // --- AI EXPLANATION WITH CACHING ---
        async function getExplanationFromAI(question, answer, grade) {
            const explanationContainer = document.getElementById('explanation-container');
            const explanationTextEl = document.getElementById('explanation-text');
            const readExplanationBtn = document.getElementById('read-explanation-btn');

            explanationTextEl.textContent = 'ƒêang t√¨m gi·∫£i th√≠ch...';
            readExplanationBtn.style.display = 'none';
            explanationContainer.classList.remove('hidden');

            const explanationId = btoa(encodeURIComponent(`${grade}-${question}`)).replace(/[^a-zA-Z0-9]/g, '');
            const explanationRef = doc(db, `artifacts/${appId}/public/data/explanations`, explanationId);

            try {
                const docSnap = await getDoc(explanationRef);

                if (docSnap.exists()) {
                    const cachedExplanation = docSnap.data().text;
                    explanationTextEl.textContent = `üí° Gi·∫£i th√≠ch: ${cachedExplanation}`;
                    readExplanationBtn.onclick = () => speakText(cachedExplanation);
                    readExplanationBtn.style.display = 'block';
                    console.log("Loaded explanation from cache.");
                    return;
                }

                console.log("Cache miss. Generating new explanation from AI.");
                explanationTextEl.textContent = 'ƒêang t·∫°o gi·∫£i th√≠ch m·ªõi...';

                const gradeMap = { lop1: "l·ªõp 1", lop2: "l·ªõp 2" };
                const gradeText = gradeMap[grade] || "h·ªçc sinh ti·ªÉu h·ªçc";

                const prompt = `H√£y gi·∫£i th√≠ch ƒë√°p √°n cho c√¢u h·ªèi sau m·ªôt c√°ch th·∫≠t ng·∫Øn g·ªçn v√† d·ªÖ hi·ªÉu, ph√π h·ª£p v·ªõi tr√¨nh ƒë·ªô c·ªßa h·ªçc sinh ${gradeText}. C√¢u h·ªèi: "${question}" ƒê√°p √°n ƒë√∫ng l√†: "${answer}".`;

                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiKey = "AIzaSyDOfRZnSkMqUAddDF1jZqqzCDZzn68hUyE"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                
                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    explanationTextEl.textContent = `üí° Gi·∫£i th√≠ch: ${generatedText}`;
                    readExplanationBtn.onclick = () => speakText(generatedText);
                    readExplanationBtn.style.display = 'block';

                    await setDoc(explanationRef, {
                        text: generatedText,
                        question: question,
                        grade: grade,
                        createdAt: serverTimestamp()
                    });
                    console.log("Saved new explanation to cache.");
                } else {
                    throw new Error("Invalid response structure from API.");
                }
            } catch (error) {
                console.error("Error in explanation process:", error);
                explanationTextEl.textContent = 'Kh√¥ng th·ªÉ t·∫°o gi·∫£i th√≠ch l√∫c n√†y.';
                readExplanationBtn.style.display = 'none';
            }
        }


        // --- HISTORY & LEADERBOARD FUNCTIONS ---
        async function saveResult(resultData, playerName = null) {
            if (!db || !appId || !auth.currentUser) return;
            const dataToSaveForHistory = { ...resultData, name: playerName };
            // Leaderboard only needs score and name
            const dataToSaveForLeaderboard = {
                name: playerName,
                score: resultData.score,
                totalQuestions: resultData.totalQuestions,
                subject: resultData.subject,
                grade: resultData.grade,
                date: resultData.date
            };

            if (playerName) {
                try {
                    const leaderboardCollectionRef = collection(db, `artifacts/${appId}/public/data/leaderboard`);
                    await addDoc(leaderboardCollectionRef, dataToSaveForLeaderboard);
                    console.log("Score saved to leaderboard!");
                } catch (e) {
                    console.error("Error writing to leaderboard:", e);
                }
            }
            try {
                const historyCollectionRef = collection(db, `artifacts/${appId}/public/data/quizResults`);
                await addDoc(historyCollectionRef, dataToSaveForHistory);
                console.log("Full quiz result saved to history!");
            } catch (e) {
                console.error("Error writing to history:", e);
            }
        }

        async function displayHistory() {
            showScreen('history');
            const container = document.getElementById('history-table-container');
            container.innerHTML = '<p class="text-center text-gray-500">ƒêang t·∫£i l·ªãch s·ª≠...</p>';
            if (!db || !appId) {
                container.innerHTML = '<p class="text-center text-red-500">L·ªói CSDL.</p>';
                return;
            }
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/quizResults`));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    container.innerHTML = '<p class="text-center text-gray-500">Ch∆∞a c√≥ l·ªãch s·ª≠ l√†m b√†i.</p>';
                    return;
                }
                const results = [];
                querySnapshot.forEach(doc => results.push(doc.data()));
                results.sort((a, b) => (b.date?.toDate() || 0) - (a.date?.toDate() || 0));

                const nameMap = { toan: 'To√°n', tiengviet: 'Ti·∫øng Vi·ªát', lop1: 'L·ªõp 1', lop2: 'L·ªõp 2', hocky1: 'H·ªçc K·ª≥ 1', hocky2: 'H·ªçc K·ª≥ 2' };
                let tableHTML = '<table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden"><thead class="bg-gray-100/50"><tr><th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase">Ng√†y Gi·ªù</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase">T√™n</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase">M√¥n</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase">ƒêi·ªÉm</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase">Chi ti·∫øt</th></tr></thead><tbody id="history-table-body" class="bg-white/30 divide-y divide-gray-200 text-gray-800">';
                results.forEach((r, index) => {
                    const date = r.date?.toDate() ? r.date.toDate().toLocaleString('vi-VN') : 'N/A';
                    const scoreDisplay = `${r.score}/${r.totalQuestions || 10}`;
                    tableHTML += `<tr>
                        <td class="px-3 py-2 text-sm">${date}</td>
                        <td class="px-3 py-2 text-sm font-semibold">${r.name || 'Kh√¥ng l∆∞u'}</td>
                        <td class="px-3 py-2 text-sm">${nameMap[r.subject] || r.subject}</td>
                        <td class="px-3 py-2 text-sm font-bold">${scoreDisplay}</td>
                        <td class="px-3 py-2 text-sm"><button data-index="${index}" class="view-detail-btn bg-blue-500 text-white px-2 py-1 rounded-md text-xs hover:bg-blue-600">Xem</button></td>
                    </tr>`;
                });
                tableHTML += '</tbody></table>';
                container.innerHTML = tableHTML;
                
                document.getElementById('history-table-body').addEventListener('click', (e) => {
                    if (e.target.classList.contains('view-detail-btn')) {
                        const index = e.target.dataset.index;
                        showHistoryDetail(results[index]);
                    }
                });

            } catch (error) {
                console.error("Error fetching history:", error);
                container.innerHTML = '<p class="text-center text-red-500">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠.</p>';
            }
        }

        function showHistoryDetail(result) {
            const summaryEl = document.getElementById('history-detail-summary');
            const contentEl = document.getElementById('history-detail-content');
            
            summaryEl.innerHTML = `<strong>T√™n:</strong> ${result.name || 'Kh√¥ng l∆∞u'} | <strong>ƒêi·ªÉm:</strong> ${result.score}/${result.totalQuestions}`;
            
            contentEl.innerHTML = '';
            if (result.questions && Array.isArray(result.questions)) {
                result.questions.forEach((q, index) => {
                    const isCorrect = q.isCorrect;
                    const itemEl = document.createElement('div');
                    itemEl.className = `p-3 rounded-lg border ${isCorrect ? 'border-green-500 bg-green-100/50' : 'border-red-500 bg-red-100/50'}`;
                    itemEl.innerHTML = `
                        <p class="font-bold text-gray-800">${index + 1}. ${q.questionText}</p>
                        <p class="text-sm ${isCorrect ? 'text-green-700' : 'text-red-700'}"><strong>B√© ch·ªçn:</strong> ${q.userAnswer || 'Kh√¥ng tr·∫£ l·ªùi'}</p>
                        ${!isCorrect ? `<p class="text-sm text-blue-700"><strong>ƒê√°p √°n ƒë√∫ng:</strong> ${q.correctAnswer}</p>` : ''}
                    `;
                    contentEl.appendChild(itemEl);
                });
            } else {
                contentEl.innerHTML = '<p>Kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt cho l·∫ßn ch∆°i n√†y.</p>';
            }

            showModal('historyDetail');
        }

        async function displayLeaderboard() { showScreen('leaderboard'); const container = document.getElementById('leaderboard-table-container'); container.innerHTML = '<p class="text-center text-gray-500">ƒêang t·∫£i b·∫£ng x·∫øp h·∫°ng...</p>'; if (!db || !appId) { container.innerHTML = '<p class="text-center text-red-500">L·ªói CSDL.</p>'; return; } const subjectFilter = leaderboardSubjectFilter.value; const gradeFilter = leaderboardGradeFilter.value; const nameFilter = leaderboardNameFilter.value.trim().toLowerCase(); try { let queryConstraints = []; if (subjectFilter !== 'all') queryConstraints.push(where("subject", "==", subjectFilter)); if (gradeFilter !== 'all') queryConstraints.push(where("grade", "==", gradeFilter)); const q = query(collection(db, `artifacts/${appId}/public/data/leaderboard`), ...queryConstraints); const querySnapshot = await getDocs(q); if (querySnapshot.empty) { container.innerHTML = '<p class="text-center text-gray-500">Ch∆∞a c√≥ ai tr√™n b·∫£ng x·∫øp h·∫°ng cho m·ª•c n√†y.</p>'; return; } let results = []; querySnapshot.forEach(doc => { results.push(doc.data()); }); if (nameFilter) { results = results.filter(r => r.name && r.name.toLowerCase().includes(nameFilter)); } results.sort((a, b) => { if (b.score !== a.score) { return b.score - a.score; } const dateA = a.date?.toDate() || new Date(0); const dateB = b.date?.toDate() || new Date(0); return dateB - dateA; }); const topResults = results.slice(0, 10); if (topResults.length === 0) { container.innerHTML = '<p class="text-center text-gray-500">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p.</p>'; return; } let tableHTML = '<table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden"><thead class="bg-gray-100/50"><tr><th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase">H·∫°ng</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase">T√™n B√©</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase">ƒêi·ªÉm</th></tr></thead><tbody class="bg-white/30 divide-y divide-gray-200 text-gray-800">'; topResults.forEach((data, index) => { const scoreDisplay = `${data.score}/${data.totalQuestions || 10}`; tableHTML += `<tr><td class="px-3 py-2 text-center text-sm font-bold">${index + 1}</td><td class="px-3 py-2 text-sm font-semibold">${data.name}</td><td class="px-3 py-2 text-sm font-bold">${scoreDisplay}</td></tr>`; }); tableHTML += '</tbody></table>'; container.innerHTML = tableHTML; } catch (error) { console.error("Error fetching leaderboard:", error); container.innerHTML = '<p class="text-center text-red-500">Kh√¥ng th·ªÉ t·∫£i b·∫£ng x·∫øp h·∫°ng.</p>'; } }
        
        // --- GAME LOGIC ---
        function updateStartButtonState() { if (selectedSubject && selectedGrade && selectedSemester && questionBank) { document.getElementById('start-btn').disabled = false; document.getElementById('start-btn').classList.remove('bg-gray-500/50', 'cursor-not-allowed'); document.getElementById('start-btn').classList.add('bg-blue-600/70', 'hover:bg-blue-600/90'); } else { document.getElementById('start-btn').disabled = true; document.getElementById('start-btn').classList.add('bg-gray-500/50', 'cursor-not-allowed'); document.getElementById('start-btn').classList.remove('bg-blue-600/70', 'hover:bg-blue-600/90'); } }
        
        function startGame() {
            clearInterval(timerInterval);
            sessionAnswers = []; // Reset session answers
            const errorEl = document.getElementById('start-error');
            errorEl.textContent = ''; 
            const questionsExist = questionBank?.[selectedSubject]?.[selectedGrade]?.[selectedSemester]?.length > 0;
            if (!questionsExist) {
                console.error("Could not find question set for:", selectedSubject, selectedGrade, selectedSemester);
                errorEl.textContent = "L·ªói: Kh√¥ng t√¨m th·∫•y b·ªô c√¢u h·ªèi. Vui l√≤ng ch·ªçn l·∫°i.";
                setTimeout(() => { errorEl.textContent = ''; }, 4000);
                return;
            }
            let allQuestions = questionBank[selectedSubject][selectedGrade][selectedSemester];
            currentQuestions = allQuestions.sort(() => 0.5 - Math.random()).slice(0, NUM_OF_QUESTIONS_PER_GAME);
            if (currentQuestions.length === 0) {
                 console.error("Not enough questions to start the game:", selectedSubject, selectedGrade, selectedSemester);
                 errorEl.textContent = "L·ªói: Kh√¥ng ƒë·ªß c√¢u h·ªèi ƒë·ªÉ b·∫Øt ƒë·∫ßu. Vui l√≤ng ch·ªçn l·∫°i.";
                 setTimeout(() => { errorEl.textContent = ''; }, 4000);
                 return;
            }
            currentQuestionIndex = 0;
            score = 0;
            showScreen('game');
            displayQuestion();
        }

        function displayQuestion() { 
            clearInterval(timerInterval);
            document.getElementById('feedback-container').innerHTML = ''; 
            document.getElementById('explanation-container').classList.add('hidden'); 
            document.getElementById('next-btn').classList.add('hidden'); 
            const questionData = currentQuestions[currentQuestionIndex]; 
            document.getElementById('question-container').querySelector('p').textContent = questionData.question; 
            const optionsContainer = document.getElementById('options-container'); 
            optionsContainer.innerHTML = ''; 
            const shuffledOptions = [...questionData.options].sort(() => Math.random() - 0.5); 
            shuffledOptions.forEach(option => { 
                const button = document.createElement('button'); 
                button.textContent = option; 
                button.className = 'answer-option w-full p-4 rounded-2xl font-semibold glass-btn bg-white/20 hover:bg-white/40 text-gray-800'; 
                button.onclick = (e) => { playSound('click'); checkAnswer(e.target, questionData.answer); }; 
                optionsContainer.appendChild(button); 
            }); 
            document.getElementById('progress-text').textContent = `C√¢u ${currentQuestionIndex + 1}/${currentQuestions.length}`; 
            document.getElementById('score-text').textContent = `ƒêi·ªÉm: ${score}`; 
            document.getElementById('read-question-btn').onclick = () => speakText(questionData.question); 
            
            const timerDisplay = document.getElementById('timer-display');
            if (timerEnabled) {
                timerDisplay.classList.remove('hidden');
                let timeLeft = timerDuration;
                timerDisplay.textContent = `‚è∞ ${timeLeft}`;
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timerDisplay.textContent = `‚è∞ ${timeLeft}`;
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        document.getElementById('feedback-container').textContent = '‚åõ H·∫øt gi·ªù!';
                        checkAnswer({ textContent: null }, questionData.answer);
                    }
                }, 1000);
            } else {
                timerDisplay.classList.add('hidden');
            }
        }
        
        function checkAnswer(selectedButton, correctAnswer) {
            clearInterval(timerInterval);
            document.querySelectorAll('.answer-option').forEach(btn => btn.disabled = true);
            const questionData = currentQuestions[currentQuestionIndex];
            const userAnswer = selectedButton.textContent;
            const isCorrect = userAnswer == correctAnswer;

            if (isCorrect) {
                score++;
                selectedButton.classList.add('correct');
                document.getElementById('feedback-container').textContent = 'üéâ ƒê√∫ng r·ªìi!';
                playSound('correct');
            } else {
                if (userAnswer) {
                    selectedButton.classList.add('incorrect');
                }
                if (document.getElementById('feedback-container').textContent === '') {
                    document.getElementById('feedback-container').textContent = 'üò• Sai r·ªìi!';
                }
                playSound('incorrect');
                document.querySelectorAll('.answer-option').forEach(btn => { if (btn.textContent == correctAnswer) btn.classList.add('correct'); });
            }

            sessionAnswers.push({
                questionText: questionData.question,
                userAnswer: userAnswer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect
            });
            
            getExplanationFromAI(questionData.question, questionData.answer, selectedGrade);
            document.getElementById('score-text').textContent = `ƒêi·ªÉm: ${score}`;
            document.getElementById('next-btn').classList.remove('hidden');
            if (speechSynthesis.speaking) speechSynthesis.cancel();
        }

        function nextQuestion() { currentQuestionIndex++; if (currentQuestionIndex < currentQuestions.length) { displayQuestion(); } else { showResults(); } }
        function showResults() { 
            playSound('complete'); 
            const finalScore = score; 
            const totalQuestions = currentQuestions.length; 
            document.getElementById('modal-final-score').textContent = `${finalScore}/${totalQuestions}`; 
            const percentage = (finalScore / totalQuestions) * 100; 
            const finalMessageElement = document.getElementById('modal-final-message'); 
            if (percentage === 100) finalMessageElement.textContent = "Xu·∫•t s·∫Øc! B√© th·∫≠t l√† gi·ªèi! H√£y ch·ªçn t√™n ƒë·ªÉ l∆∞u ƒëi·ªÉm nh√©."; 
            else if (percentage >= 70) finalMessageElement.textContent = "Gi·ªèi l·∫Øm! H√£y ch·ªçn t√™n ƒë·ªÉ l∆∞u ƒëi·ªÉm nh√©."; 
            else if (percentage >= 50) finalMessageElement.textContent = "L√†m t·ªët l·∫Øm! H√£y ch·ªçn t√™n ƒë·ªÉ l∆∞u ƒëi·ªÉm nh√©."; 
            else finalMessageElement.textContent = "C·ªë g·∫Øng h∆°n l·∫ßn sau nh√©! Ch·ªçn t√™n ƒë·ªÉ l∆∞u ƒëi·ªÉm n√†o."; 
            
            // Save result immediately before showing name selection
            const resultData = { 
                date: serverTimestamp(), 
                subject: selectedSubject, 
                grade: selectedGrade, 
                semester: selectedSemester, 
                score: score, 
                totalQuestions: currentQuestions.length,
                questions: sessionAnswers // Add detailed answers
            };
            
            document.getElementById('name-selection-container').onclick = (e) => {
                if (e.target.classList.contains('name-btn')) {
                    playSound('click');
                    const playerName = e.target.dataset.name;
                    saveResult(resultData, playerName);
                    hideModal('nameSelection');
                    displayLeaderboard();
                }
            };
            document.getElementById('skip-and-play-again-btn').onclick = () => {
                playSound('click');
                saveResult(resultData, null); // Save with null name
                hideModal('nameSelection');
                resetGame();
            };

            showModal('nameSelection'); 
        }
        function resetGame() { showScreen('selection'); selectedSubject = null; selectedGrade = null; selectedSemester = null; document.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('selected')); updateStartButtonState(); }

        // --- UI & MODAL MANAGEMENT ---
        function showScreen(screenName) { Object.values(screens).forEach(s => s.classList.add('hidden')); if (screens[screenName]) screens[screenName].classList.remove('hidden'); }
        function showModal(modalName) { if (modals[modalName]) { modals[modalName].classList.remove('hidden'); setTimeout(() => modals[modalName].classList.remove('opacity-0'), 10); } }
        function hideModal(modalName) { if (modals[modalName]) { modals[modalName].classList.add('opacity-0'); setTimeout(() => modals[modalName].classList.add('hidden'), 300); } }
        function speakText(text) { if (!'speechSynthesis' in window) { console.warn("Speech synthesis not supported."); return; } if (speechSynthesis.speaking) speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(text); utterance.lang = 'vi-VN'; const voice = speechSynthesis.getVoices().find(v => v.lang === 'vi-VN'); if (voice) utterance.voice = voice; speechSynthesis.speak(utterance); }
        
        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', async () => { await initializeFirebase(); document.body.addEventListener('click', async () => { if (Tone.context.state !== 'running') { await Tone.start(); console.log('Audio context started'); } }, { once: true }); });
        document.getElementById('sound-toggle-btn').addEventListener('click', () => { soundsEnabled = !soundsEnabled; document.getElementById('speaker-on-icon').classList.toggle('hidden', !soundsEnabled); document.getElementById('speaker-off-icon').classList.toggle('hidden', soundsEnabled); });
        document.querySelectorAll('.choice-btn').forEach(btn => btn.addEventListener('click', (e) => { playSound('click'); const type = Object.keys(e.target.dataset)[0]; const value = e.target.dataset[type]; if (type === 'subject') selectedSubject = value; if (type === 'grade') selectedGrade = value; if (type === 'semester') selectedSemester = value; document.querySelectorAll(`[data-${type}]`).forEach(b => b.classList.remove('selected')); e.target.classList.add('selected'); updateStartButtonState(); }));
        document.getElementById('start-btn').addEventListener('click', () => { if (!document.getElementById('start-btn').disabled) { playSound('click'); startGame(); } });
        document.getElementById('next-btn').addEventListener('click', () => { playSound('click'); nextQuestion(); });

        leaderboardBtn.addEventListener('click', () => { playSound('click'); displayLeaderboard(); });
        backToMenuBtn.addEventListener('click', () => { playSound('click'); resetGame(); });
        leaderboardSubjectFilter.addEventListener('change', displayLeaderboard);
        leaderboardGradeFilter.addEventListener('change', displayLeaderboard);
        leaderboardNameFilter.addEventListener('input', displayLeaderboard);
        document.getElementById('admin-login-btn').addEventListener('click',_=> { playSound('click'); showModal('login'); });
        document.getElementById('close-modal-btn').addEventListener('click', () => hideModal('login'));
        document.getElementById('close-history-detail-btn').addEventListener('click', () => hideModal('historyDetail'));
        document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); playSound('click'); const u = document.getElementById('username').value; const p = document.getElementById('password').value; if (u === 'admin' && p === 'admin') { document.getElementById('timer-toggle').checked = timerEnabled; document.getElementById('timer-duration').value = timerDuration; hideModal('login'); showScreen('admin'); } else { document.getElementById('login-error').textContent = 'T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.'; } });
        document.getElementById('logout-btn').addEventListener('click', () => { playSound('click'); showScreen('selection'); });
        document.getElementById('view-history-btn').addEventListener('click', () => { playSound('click'); displayHistory(); });
        document.getElementById('back-to-admin-btn').addEventListener('click', () => { playSound('click'); showScreen('admin'); });
        document.getElementById('save-settings-btn').addEventListener('click', async () => {
            playSound('click');
            const newTimerEnabled = document.getElementById('timer-toggle').checked;
            const newTimerDuration = parseInt(document.getElementById('timer-duration').value, 10);
            const feedbackEl = document.getElementById('settings-feedback');

            if (isNaN(newTimerDuration) || newTimerDuration < 5 || newTimerDuration > 120) {
                feedbackEl.textContent = "Th·ªùi gian ph·∫£i t·ª´ 5 ƒë·∫øn 120 gi√¢y.";
                feedbackEl.classList.remove('text-green-800');
                feedbackEl.classList.add('text-red-600');
                return;
            }

            const settingsRef = doc(db, `artifacts/${appId}/public/data/adminSettings`, 'config');
            try {
                await setDoc(settingsRef, { timerEnabled: newTimerEnabled, timerDuration: newTimerDuration });
                timerEnabled = newTimerEnabled;
                timerDuration = newTimerDuration;
                feedbackEl.textContent = "ƒê√£ l∆∞u c√†i ƒë·∫∑t!";
                feedbackEl.classList.add('text-green-800');
                feedbackEl.classList.remove('text-red-600');
                setTimeout(() => feedbackEl.textContent = '', 3000);
            } catch (error) {
                console.error("Error saving settings:", error);
                feedbackEl.textContent = "L·ªói khi l∆∞u.";
                feedbackEl.classList.remove('text-green-800');
                feedbackEl.classList.add('text-red-600');
            }
        });

    </script>
</body>
</html>
