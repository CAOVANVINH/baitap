<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≤ Ch∆°i H·ªçc T·∫≠p Vui (Admin Pro)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Quicksand -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tone.js for Sound Effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.4);
        }

        /* Base body styling with gradient background and Quicksand font */
        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(to right top, #6d8cf0, #8d8de0, #a98fcb, #be93b6, #ce99a6);
        }
        /* Glassmorphism effect for containers */
        .glass-container {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        /* Glassmorphism effect for buttons */
        .glass-btn {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.2s ease-in-out;
            color: #2d3748; /* Default text color for glass buttons */
        }
        /* Specific text colors for certain buttons for better contrast */
        #start-btn, #next-btn, #admin-login-btn, #logout-btn, .admin-action-btn, #back-to-admin-btn, #leaderboard-btn, #back-to-menu-btn, .name-btn, #save-settings-btn {
            color: white;
        }
        /* Adjusted styles for prominent buttons on selection screen */
        .prominent-btn {
            background: rgba(100, 116, 139, 0.6); /* Slate-500 with transparency */
            color: white;
            font-weight: bold;
            padding-top: 1rem;
            padding-bottom: 1rem;
            border-radius: 1rem; /* rounded-2xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            transition: all 0.2s ease-in-out;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            text-align: center;
        }
        .prominent-btn:hover {
            background: rgba(100, 116, 139, 0.8); /* Darker on hover */
            transform: translateY(-2px); /* Slight lift effect */
        }

        /* Styling for selected choice buttons */
        .choice-btn.selected {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            border-width: 2px;
            border-color: rgba(255, 255, 255, 0.7);
        }
        /* Styling for correct answer options */
        .answer-option.correct {
            background-color: rgba(34, 197, 94, 0.7) !important;
            border-color: rgba(22, 163, 74, 0.8);
            color: white !important;
        }
        /* Styling for incorrect answer options */
        .answer-option.incorrect {
            background-color: rgba(239, 68, 68, 0.7) !important;
            border-color: rgba(220, 38, 38, 0.8);
            color: white !important;
        }
        /* Modal overlay transition */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        /* Max height and overflow for scrollable containers */
        #history-table-container, #leaderboard-table-container, #history-detail-content, #question-list-container, #student-list-container, #ai-generated-questions-list, #duplicate-questions-list {
            max-height: 400px; /* Consistent max height for scrollable lists */
            overflow-y: auto;
        }
        /* Speaker button hover effect */
        .speaker-btn, #sound-toggle-btn {
            cursor: pointer;
            transition: transform 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .speaker-btn:hover, #sound-toggle-btn:hover {
            transform: scale(1.1);
            color: #6366f1; /* Indigo color on hover */
        }
        /* Spinner animation for loading states */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Main Container for the Application -->
    <div class="w-full max-w-3xl mx-auto glass-container rounded-3xl shadow-2xl p-4 md:p-8 relative">
        <!-- Sound Toggle Button - positioned at top-left -->
        <button id="sound-toggle-btn" class="absolute top-4 left-5 text-white focus:outline-none z-10">
            <!-- Speaker On Icon (default) -->
            <svg id="speaker-on-icon" xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="currentColor"><path d="M18.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM5 10v4h3l4 4V6l-4 4H5z"></path><path d="M16 8.5v7l-4-4H8V8.5h4l4-4zM19 12c0 2.8-1.56 5.28-3.8 6.5l1.2 1.5c2.95-1.7 5.1-4.86 5.1-8.5s-2.15-6.8-5.1-8.5L15.2 5.5C17.44 6.72 19 9.2 19 12z"></path></svg>
            <!-- Speaker Off Icon (hidden by default) -->
            <svg id="speaker-off-icon" xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"></path></svg>
        </button>

        <!-- Selection Screen - Initial view for users to choose game parameters -->
        <div id="selection-screen">
            <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-2">Tr√≤ Ch∆°i H·ªçc T·∫≠p</h1>
            <p class="text-center text-gray-700 mb-6">C√πng b√© v·ª´a h·ªçc v·ª´a ch∆°i!</p>
            <!-- Loading indicator for questions -->
            <div id="loading-questions" class="text-center text-gray-600 font-semibold mb-4"><p>ƒêang t·∫£i d·ªØ li·ªáu, vui l√≤ng ch·ªù...</p></div>
            <!-- Game selection options (hidden until data loaded) -->
            <div id="selections-container" class="hidden">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-3 text-gray-700">1. Ch·ªçn M√¥n H·ªçc</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button data-subject="toan" class="choice-btn glass-btn bg-sky-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-sky-500/60">üî¢ To√°n H·ªçc</button>
                        <button data-subject="tiengviet" class="choice-btn glass-btn bg-emerald-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-emerald-500/60">‚úçÔ∏è Ti·∫øng Vi·ªát</button>
                    </div>
                </div>
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-3 text-gray-700">2. Ch·ªçn L·ªõp</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button data-grade="lop1" class="choice-btn glass-btn bg-amber-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-amber-500/60">L·ªõp 1</button>
                        <button data-grade="lop2" class="choice-btn glass-btn bg-rose-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-rose-500/60">L·ªõp 2</button>
                    </div>
                </div>
                <div class="mb-8">
                    <h2 class="text-xl font-semibold mb-3 text-gray-700">3. Ch·ªçn H·ªçc K·ª≥</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button data-semester="hocky1" class="choice-btn glass-btn bg-purple-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-purple-500/60">H·ªçc K·ª≥ 1</button>
                        <button data-semester="hocky2" class="choice-btn glass-btn bg-pink-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-pink-500/60">H·ªçc K·ª≥ 2</button>
                    </div>
                </div>
            </div>
            <!-- Start Game Button (disabled until selections are made) -->
            <button id="start-btn" class="w-full glass-btn bg-gray-500/50 text-white font-bold py-4 rounded-2xl text-xl shadow-lg cursor-not-allowed" disabled>B·∫Øt ƒë·∫ßu!</button>
            <p id="start-error" class="text-red-600 font-bold text-center text-sm h-5 mt-2"></p>
            <!-- Footer links for Leaderboard and Admin Login -->
            <div class="flex flex-col gap-3 mt-6"> <!-- Changed to flex-col and added gap -->
                <button id="leaderboard-btn" class="prominent-btn text-lg">üèÜ B·∫£ng X·∫øp H·∫°ng</button>
                <button id="admin-login-btn" class="prominent-btn text-lg">Qu·∫£n tr·ªã vi√™n</button>
            </div>
        </div>

        <!-- Game Screen - Displays questions and answer options -->
        <div id="game-screen" class="hidden">
            <div class="flex justify-between items-center mb-4 text-white">
                <div id="progress-text" class="font-semibold">C√¢u 1/10</div>
                <div id="timer-display" class="font-bold text-lg hidden"></div>
                <div id="score-text" class="font-bold text-lg">ƒêi·ªÉm: 0</div>
            </div>
            <div id="question-container" class="bg-black/10 p-6 rounded-2xl text-center mb-6 min-h-[100px] flex items-center justify-center relative">
                <p class="text-xl md:text-2xl font-semibold text-white"></p>
                <!-- Button to read the question aloud -->
                <button id="read-question-btn" class="speaker-btn absolute top-4 right-4 text-white focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7"><path d="M13.5 4.06c0-1.34 1.61-2.26 2.86-1.48l.29.18c.54.33.86.94.86 1.58v13.32c0 .64-.32 1.25-.86 1.58l-.29.18c-1.25.78-2.86-.14-2.86-1.48V4.06ZM5.5 4.06c0-1.34 1.61-2.26 2.86-1.48l.29.18c.54.33.86.94.86 1.58v13.32c0 .64-.32 1.25-.86 1.58l-.29.18c-1.25.78-2.86-.14-2.86-1.48V4.06Z" /></svg>
                </button>
            </div>
            <!-- Container for answer options -->
            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            <!-- Feedback message (Correct/Incorrect) -->
            <div id="feedback-container" class="text-center mt-4 font-bold text-2xl h-8 text-white"></div>
            <!-- AI-generated explanation (hidden by default) -->
            <div id="explanation-container" class="hidden relative mt-2 bg-black/10 p-4 rounded-2xl text-white text-center font-medium">
                <p id="explanation-text" class="pr-10"></p>
                <!-- Button to read the explanation aloud -->
                <button id="read-explanation-btn" class="speaker-btn absolute top-1/2 -translate-y-1/2 right-3 text-white focus:outline-none">
                       <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M13.5 4.06c0-1.34 1.61-2.26 2.86-1.48l.29.18c.54.33.86.94.86 1.58v13.32c0 .64-.32 1.25-.86 1.58l-.29.18c-1.25.78-2.86-.14-2.86-1.48V4.06Z" /></svg>
                </button>
            </div>
            <!-- Next Question Button (hidden until answer is checked) -->
            <button id="next-btn" class="hidden w-full mt-4 glass-btn bg-blue-500/60 text-white font-bold py-3 rounded-2xl shadow-lg hover:bg-blue-500/80">C√¢u ti·∫øp theo</button>
        </div>
        
        <!-- Admin Panel - Main menu for administrators -->
        <div id="admin-panel" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">B·∫£ng ƒëi·ªÅu khi·ªÉn Admin</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="manage-questions-btn" class="admin-action-btn w-full glass-btn bg-blue-500/60 py-4 rounded-2xl text-lg shadow-lg hover:bg-blue-500/80">üìù Qu·∫£n l√Ω c√¢u h·ªèi</button>
                <button id="manage-students-btn" class="admin-action-btn w-full glass-btn bg-cyan-500/60 py-4 rounded-2xl text-lg shadow-lg hover:bg-cyan-500/80">üßë‚Äçüéì Qu·∫£n l√Ω h·ªçc sinh</button>
                <button id="ai-generate-btn" class="admin-action-btn w-full glass-btn bg-teal-500/60 py-4 rounded-2xl text-lg shadow-lg hover:bg-teal-500/80">ü§ñ T·∫°o c√¢u h·ªèi b·∫±ng AI</button>
                <button id="view-history-btn" class="admin-action-btn w-full glass-btn bg-indigo-500/60 py-4 rounded-2xl text-lg shadow-lg hover:bg-indigo-500/80">üìä Xem L·ªãch S·ª≠ Thi</button>
                <button id="manage-settings-btn" class="admin-action-btn w-full glass-btn bg-purple-500/60 py-4 rounded-2xl text-lg shadow-lg hover:bg-purple-500/80 md:col-span-2">‚öôÔ∏è C√†i ƒë·∫∑t chung</button>
            </div>
            <button id="logout-btn" class="w-full glass-btn bg-red-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-red-500/80 mt-8">ƒêƒÉng xu·∫•t</button>
        </div>

        <!-- Settings Panel - For general application settings -->
        <div id="settings-panel" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">C√†i ƒë·∫∑t chung</h2>
            <div class="space-y-6">
                <!-- Timer Settings Section -->
                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">C√†i ƒë·∫∑t ƒê·ªìng h·ªì</h3>
                    <div class="space-y-4 max-w-sm mx-auto p-4 bg-white/20 rounded-xl">
                        <div class="flex items-center justify-between">
                            <label for="timer-toggle" class="font-medium text-gray-800">B·∫≠t ƒê·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c</label>
                            <input type="checkbox" id="timer-toggle" class="h-6 w-6 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="timer-duration" class="font-medium text-gray-800">Th·ªùi gian (gi√¢y)</label>
                            <input type="number" id="timer-duration" min="5" max="120" class="w-24 px-3 py-1 border border-gray-300/50 rounded-lg bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">
                        </div>
                    </div>
                </div>
                <!-- API Key Settings Section -->
                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">C√†i ƒë·∫∑t Gemini API Key</h3>
                     <div class="space-y-4 max-w-sm mx-auto p-4 bg-white/20 rounded-xl">
                        <p class="text-xs text-center text-gray-600">Th√™m API Key c·ªßa b·∫°n ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng t·∫°o c√¢u h·ªèi b·∫±ng AI. ƒê·ªÉ tr·ªëng ƒë·ªÉ d√πng key m·∫∑c ƒë·ªãnh c·ªßa h·ªá th·ªëng.</p>
                        <input type="text" id="gemini-api-key-input" placeholder="Nh·∫≠p Gemini API Key c·ªßa b·∫°n..." class="w-full px-3 py-2 border border-gray-300/50 rounded-lg bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">
                        <div id="gemini-api-status" class="text-center text-sm font-semibold h-4 text-gray-700"></div> <!-- New status display -->
                        <div class="flex gap-2">
                            <button id="save-api-key-btn" class="w-full glass-btn bg-green-500/60 text-white font-bold py-2 rounded-xl shadow-lg hover:bg-green-500/80 flex justify-center items-center">L∆∞u Key</button>
                            <button id="delete-api-key-btn" class="w-full glass-btn bg-gray-500/60 text-white font-bold py-2 rounded-xl shadow-lg hover:bg-gray-500/80 flex justify-center items-center">X√≥a Key</button>
                        </div>
                    </div>
                </div>
                <!-- Dangerous Actions Section (Clear Data) -->
                <div>
                    <h3 class="text-xl font-semibold text-red-700 mb-4 text-center">T√°c V·ª• Nguy Hi·ªÉm</h3>
                    <div class="space-y-4 max-w-sm mx-auto p-4 bg-red-500/10 rounded-xl">
                        <button id="clear-leaderboard-btn" class="w-full glass-btn bg-amber-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-amber-500/80 flex justify-center items-center">X√≥a B·∫£ng X·∫øp H·∫°ng</button>
                        <button id="clear-history-btn" class="w-full glass-btn bg-amber-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-amber-500/80 flex justify-center items-center">X√≥a L·ªãch S·ª≠ Thi</button>
                    </div>
                </div>
            </div>
            <p id="settings-feedback" class="text-center text-sm font-bold h-4 mt-4"></p>
            <button id="save-settings-btn" class="w-full glass-btn bg-blue-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-blue-500/80 mt-6 flex justify-center items-center">L∆∞u t·∫•t c·∫£ c√†i ƒë·∫∑t</button>
            <button class="back-to-admin-btn w-full mt-4 glass-btn bg-gray-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-gray-500/80">Quay l·∫°i</button>
        </div>

        <!-- Student Manager Panel - For managing student names -->
        <div id="student-manager-panel" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-4 text-center">Qu·∫£n l√Ω h·ªçc sinh</h2>
            <div class="p-4 bg-white/20 rounded-2xl space-y-4">
                <form id="add-student-form" class="flex gap-2">
                    <input type="text" id="new-student-name" placeholder="Nh·∫≠p t√™n h·ªçc sinh m·ªõi..." class="w-full glass-btn bg-white/30 rounded-lg px-3 py-2 font-semibold text-gray-800 placeholder-gray-600" required>
                    <button type="submit" class="glass-btn bg-green-500/70 text-white font-bold py-2 px-4 rounded-xl shadow-lg hover:bg-green-500/90 flex justify-center items-center">Th√™m</button>
                </form>
            </div>
            <!-- List of students -->
            <div id="student-list-container" class="mt-4 space-y-2 p-3 bg-white/20 rounded-2xl custom-scrollbar">
                <!-- Student list will be loaded here -->
            </div>
            <button class="back-to-admin-btn w-full mt-6 glass-btn bg-gray-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-gray-500/80">Quay l·∫°i</button>
        </div>

        <!-- Question Manager Panel - For managing quiz questions -->
        <div id="question-manager-panel" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-4 text-center">Qu·∫£n l√Ω c√¢u h·ªèi</h2>
            <!-- New summary display area -->
            <div id="question-summary-display" class="text-center text-gray-700 font-semibold mb-4"></div>
            <div class="flex flex-wrap justify-center items-center gap-2 md:gap-4 mb-4 p-2 bg-black/10 rounded-xl">
                <select id="q-manager-subject-filter" class="flex-grow glass-btn bg-white/30 rounded-lg px-3 py-2 font-semibold text-gray-800"><option value="all">T·∫•t c·∫£ m√¥n</option><option value="toan">To√°n H·ªçc</option><option value="tiengviet">Ti·∫øng Vi·ªát</option></select>
                <select id="q-manager-grade-filter" class="flex-grow glass-btn bg-white/30 rounded-lg px-3 py-2 font-semibold text-gray-800"><option value="all">T·∫•t c·∫£ l·ªõp</option><option value="lop1">L·ªõp 1</option><option value="lop2">L·ªõp 2</option></select>
                <select id="q-manager-semester-filter" class="flex-grow glass-btn bg-white/30 rounded-lg px-3 py-2 font-semibold text-gray-800"><option value="all">T·∫•t c·∫£ k·ª≥</option><option value="hocky1">H·ªçc K·ª≥ 1</option><option value="hocky2">H·ªçc K·ª≥ 2</option></select>
            </div>
            <div id="question-list-container" class="space-y-3 p-3 bg-white/20 rounded-2xl custom-scrollbar">
                <!-- Question list will be loaded here -->
            </div>
            <div class="flex gap-4 mt-6">
                <button id="add-new-question-btn" class="w-full glass-btn bg-green-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-green-500/80">Th√™m c√¢u h·ªèi m·ªõi</button>
                <button id="find-duplicates-btn" class="w-full glass-btn bg-orange-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-orange-500/80">T√¨m c√¢u h·ªèi tr√πng l·∫∑p</button>
                <button class="back-to-admin-btn w-full glass-btn bg-gray-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-gray-500/80">Quay l·∫°i</button>
            </div>
        </div>

        <!-- AI Generator Panel - For generating questions using AI -->
        <div id="ai-generator-panel" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-4 text-center">T·∫°o c√¢u h·ªèi b·∫±ng AI</h2>
            <div class="p-4 bg-white/20 rounded-2xl space-y-4">
                <p class="text-center text-gray-700 font-medium">Ch·ªçn ch·ªß ƒë·ªÅ v√† ƒë·ªÉ AI t·ª± ƒë·ªông t·∫°o ra c√°c c√¢u h·ªèi tr·∫Øc nghi·ªám m·ªõi!</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <select id="ai-gen-subject" class="glass-btn bg-white/30 rounded-lg px-3 py-2 font-semibold text-gray-800"><option value="toan">To√°n H·ªçc</option><option value="tiengviet">Ti·∫øng Vi·ªát</option></select>
                    <select id="ai-gen-grade" class="glass-btn bg-white/30 rounded-lg px-3 py-2 font-semibold text-gray-800"><option value="lop1">L·ªõp 1</option><option value="lop2">L·ªõp 2</option></select>
                    <select id="ai-gen-semester" class="glass-btn bg-white/30 rounded-lg px-3 py-2 font-semibold text-gray-800"><option value="hocky1">H·ªçc K·ª≥ 1</option><option value="hocky2">H·ªçc K·ª≥ 2</option></select>
                </div>
                <input type="text" id="ai-gen-topic" placeholder="Nh·∫≠p ch·ªß ƒë·ªÅ c·ª• th·ªÉ (v√≠ d·ª•: ph√©p c·ªông ph·∫°m vi 20)" class="w-full glass-btn bg-white/30 rounded-lg px-3 py-2 font-semibold text-gray-800 placeholder-gray-600">
                <div class="flex items-center justify-between">
                    <label for="ai-gen-count" class="font-medium text-gray-800">S·ªë c√¢u h·ªèi mu·ªën t·∫°o:</label>
                    <input type="number" id="ai-gen-count" value="5" min="1" max="20" class="w-24 px-3 py-1 border border-gray-300/50 rounded-lg bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">
                </div>
                <button id="ai-execute-generation-btn" class="w-full glass-btn bg-blue-500/70 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-blue-500/90 flex justify-center items-center">üöÄ B·∫Øt ƒë·∫ßu t·∫°o!</button>
            </div>
            <!-- AI generation results container (hidden by default) -->
            <div id="ai-results-container" class="mt-4 p-4 bg-white/20 rounded-2xl hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-2 text-center">Xem l·∫°i c√¢u h·ªèi do AI t·∫°o</h3>
                <div id="ai-generated-questions-list" class="space-y-3 max-h-64 overflow-y-auto custom-scrollbar"></div>
                <div id="ai-generation-feedback" class="text-center font-semibold my-2"></div>
                <div class="flex gap-4 mt-4">
                    <button id="ai-save-all-btn" class="w-full glass-btn bg-green-500/70 text-white font-bold py-2 rounded-xl shadow-lg hover:bg-green-500/90 hidden">L∆∞u t·∫•t c·∫£ c√¢u h·ªèi</button>
                    <button id="ai-discard-all-btn" class="w-full glass-btn bg-red-500/70 text-white font-bold py-2 rounded-xl shadow-lg hover:bg-red-500/90 hidden">H·ªßy b·ªè</button>
                </div>
            </div>
            <button class="back-to-admin-btn w-full mt-6 glass-btn bg-gray-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-gray-500/80">Quay l·∫°i</button>
        </div>

        <!-- Duplicate Manager Panel -->
        <div id="duplicate-manager-panel" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-4 text-center">Qu·∫£n l√Ω c√¢u h·ªèi tr√πng l·∫∑p</h2>
            <div id="duplicate-questions-list" class="space-y-4 p-3 bg-white/20 rounded-2xl custom-scrollbar">
                <!-- Duplicate question groups will be loaded here -->
                <p class="text-center text-gray-600 font-semibold p-4">ƒêang t√¨m c√¢u h·ªèi tr√πng l·∫∑p...</p>
            </div>
            <div id="duplicate-feedback" class="text-center text-sm font-bold h-4 mt-4"></div> <!-- New feedback element -->
            <button class="back-to-admin-btn w-full mt-6 glass-btn bg-gray-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-gray-500/80">Quay l·∫°i</button>
        </div>

        <!-- History Panel - Displays past quiz results -->
        <div id="history-panel" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-4 text-center">L·ªãch S·ª≠ L√†m B√†i</h2>
            <div id="history-table-container" class="overflow-x-auto bg-white/50 rounded-2xl p-4 custom-scrollbar"></div>
            <button class="back-to-admin-btn w-full mt-6 glass-btn bg-gray-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-gray-500/80">Quay l·∫°i</button>
        </div>
        
        <!-- Leaderboard Panel - Displays top scores -->
        <div id="leaderboard-panel" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-4 text-center">üèÜ B·∫£ng X·∫øp H·∫°ng üèÜ</h2>
            <!-- Filters for leaderboard -->
            <div class="flex flex-wrap justify-center items-center gap-4 mb-4">
                <select id="leaderboard-subject-filter" class="glass-btn bg-white/30 rounded-lg px-3 py-2 font-semibold text-gray-800"><option value="all">T·∫•t c·∫£ m√¥n</option><option value="toan">To√°n H·ªçc</option><option value="tiengviet">Ti·∫øng Vi·ªát</option></select>
                <select id="leaderboard-grade-filter" class="glass-btn bg-white/30 rounded-lg px-3 py-2 font-semibold text-gray-800"><option value="all">T·∫•t c·∫£ l·ªõp</option><option value="lop1">L·ªõp 1</option><option value="lop2">L·ªõp 2</option></select>
                <input type="text" id="leaderboard-name-filter" placeholder="L·ªçc theo t√™n..." class="glass-btn bg-white/30 rounded-lg px-3 py-2 font-semibold text-gray-800 placeholder-gray-600">
            </div>
            <div id="leaderboard-table-container" class="overflow-x-auto bg-white/50 rounded-2xl p-4 custom-scrollbar"></div>
            <button id="back-to-menu-btn" class="w-full mt-6 glass-btn bg-gray-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-gray-500/80">Ch∆°i L·∫°i</button>
        </div>
    </div>

    <!-- Modals -->
    <!-- Admin Login Modal -->
    <div id="login-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0">
        <div class="glass-container rounded-3xl shadow-2xl p-8 w-full max-w-sm relative">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">ƒêƒÉng Nh·∫≠p Admin</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-gray-700 font-semibold mb-2">T√™n ƒëƒÉng nh·∫≠p</label>
                    <input type="text" id="username" class="w-full px-4 py-2 border border-gray-300/50 rounded-2xl bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 font-semibold mb-2">M·∫≠t kh·∫©u</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300/50 rounded-2xl bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">
                </div>
                <p id="login-error" class="text-red-500 text-center text-sm h-4 mb-4"></p>
                <button type="submit" class="w-full glass-btn bg-blue-600/70 text-white font-bold py-3 rounded-2xl hover:bg-blue-600/90">ƒêƒÉng nh·∫≠p</button>
            </form>
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-2xl">&times;</button>
        </div>
    </div>
    <!-- Name Selection Modal (shown after game completion) -->
    <div id="name-selection-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0">
        <div class="glass-container rounded-3xl shadow-2xl p-8 w-full max-w-sm relative text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Ho√†n th√†nh!</h2>
            <p id="modal-final-score" class="text-6xl font-bold text-blue-600 my-4">0/10</p>
            <p id="modal-final-message" class="text-lg text-gray-600 mb-6">B√© ƒë√£ l√†m r·∫•t t·ªët! H√£y ch·ªçn t√™n c·ªßa m√¨nh ƒë·ªÉ l∆∞u ƒëi·ªÉm nh√©.</p>
            <div id="name-selection-container" class="space-y-3"></div>
            <button id="skip-and-play-again-btn" class="w-full mt-6 text-gray-600 font-semibold hover:text-gray-800 text-sm">Ch∆°i L·∫°i (Kh√¥ng l∆∞u)</button>
        </div>
    </div>
    <!-- History Detail Modal -->
    <div id="history-detail-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0">
        <div class="glass-container rounded-3xl shadow-2xl p-8 w-full max-w-2xl relative">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Chi Ti·∫øt L·∫ßn Ch∆°i</h2>
            <div id="history-detail-summary" class="text-center text-gray-700 mb-4"></div>
            <div id="history-detail-content" class="space-y-3 bg-white/30 p-4 rounded-2xl custom-scrollbar"></div>
            <button id="close-history-detail-btn" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-3xl">&times;</button>
        </div>
    </div>
    <!-- Confirmation Modal (for delete actions) -->
    <div id="confirmation-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0">
        <div class="glass-container rounded-3xl shadow-2xl p-8 w-full max-w-sm relative text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">X√°c nh·∫≠n h√†nh ƒë·ªông</h2>
            <p id="confirmation-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-delete-btn" class="w-full glass-btn bg-red-600/70 text-white font-bold py-3 rounded-2xl hover:bg-red-600/90">X√°c nh·∫≠n</button>
                <button id="cancel-delete-btn" class="w-full glass-btn bg-gray-500/60 text-white font-bold py-3 rounded-2xl hover:bg-gray-500/80">H·ªßy</button>
            </div>
        </div>
    </div>
    
    <!-- Question Edit/Add Modal -->
    <div id="question-edit-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0">
        <div class="glass-container rounded-3xl shadow-2xl p-8 w-full max-w-2xl relative">
            <h2 id="question-modal-title" class="text-2xl font-bold text-center text-gray-800 mb-6">Ch·ªânh s·ª≠a c√¢u h·ªèi</h2>
            <form id="question-form" class="space-y-4">
                <input type="hidden" id="question-id-input">
                <div>
                    <label for="question-text-input" class="block text-gray-700 font-semibold mb-1">N·ªôi dung c√¢u h·ªèi</label>
                    <textarea id="question-text-input" rows="2" class="w-full px-4 py-2 border border-gray-300/50 rounded-2xl bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800" required></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="option-1-input" class="block text-gray-700 font-semibold mb-1">L·ª±a ch·ªçn 1</label>
                        <input type="text" id="option-1-input" class="option-input w-full px-4 py-2 border border-gray-300/50 rounded-2xl bg-white/50" required>
                    </div>
                     <div>
                        <label for="option-2-input" class="block text-gray-700 font-semibold mb-1">L·ª±a ch·ªçn 2</label>
                        <input type="text" id="option-2-input" class="option-input w-full px-4 py-2 border border-gray-300/50 rounded-2xl bg-white/50" required>
                    </div>
                     <div>
                        <label for="option-3-input" class="block text-gray-700 font-semibold mb-1">L·ª±a ch·ªçn 3</label>
                        <input type="text" id="option-3-input" class="option-input w-full px-4 py-2 border border-gray-300/50 rounded-2xl bg-white/50" required>
                    </div>
                     <div>
                        <label for="option-4-input" class="block text-gray-700 font-semibold mb-1">L·ª±a ch·ªçn 4</label>
                        <input type="text" id="option-4-input" class="option-input w-full px-4 py-2 border border-gray-300/50 rounded-2xl bg-white/50" required>
                    </div>
                </div>
                <div>
                    <label for="correct-answer-select" class="block text-gray-700 font-semibold mb-1">ƒê√°p √°n ƒë√∫ng</label>
                    <select id="correct-answer-select" class="w-full px-4 py-2 border border-gray-300/50 rounded-2xl bg-white/50" required></select>
                </div>
                <p id="question-form-error" class="text-red-500 text-center text-sm h-4"></p>
                <div class="flex gap-4 pt-4">
                    <button type="submit" class="w-full glass-btn bg-green-600/70 text-white font-bold py-3 rounded-2xl hover:bg-green-600/90 flex justify-center items-center">L∆∞u thay ƒë·ªïi</button>
                    <button type="button" id="close-question-modal-btn" class="w-full glass-btn bg-gray-500/60 text-white font-bold py-3 rounded-2xl hover:bg-gray-500/80">H·ªßy</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, serverTimestamp, doc, getDoc, setDoc, where, deleteDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- SOUND EFFECTS SETUP ---
        let soundsEnabled = true; // Flag to control sound
        // Initialize Tone.js synths for different sound effects
        const synths = {
            click: new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 } }).toDestination(),
            correct: new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.005, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination(),
            incorrect: new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.4, sustain: 0, release: 0.2 } }).toDestination(),
            complete: new Tone.PolySynth(Tone.Synth).toDestination()
        };

        /**
         * Plays a specific sound effect.
         * @param {string} soundType - The type of sound to play ('click', 'correct', 'incorrect', 'complete').
         */
        function playSound(soundType) {
            // Only play if sounds are enabled and audio context is running
            if (!soundsEnabled || Tone.context.state !== 'running') return;
            try {
                switch (soundType) {
                    case 'click': synths.click.triggerAttackRelease("C5", "8n"); break;
                    case 'correct': synths.correct.triggerAttackAttackRelease("G5", "8n", Tone.now()); break;
                    case 'incorrect': synths.incorrect.triggerAttackRelease("C3", "8n"); break;
                    case 'complete': 
                        const now = Tone.now(); 
                        synths.complete.triggerAttackRelease(["C4", "E4", "G4"], "8n", now); 
                        synths.complete.triggerAttackRelease(["E4", "G4", "B4"], "8n", now + 0.2); 
                        synths.complete.triggerAttackRelease(["G4", "B4", "D5"], "8n", now + 0.4); 
                        break;
                }
            } catch (error) { 
                console.error("Sound play error:", error); 
            }
        }

        // --- STATE & DOM VARIABLES ---
        let db, auth, appId, userDefinedApiKey = null;
        let questionBank = {}; // Stores questions categorized by subject, grade, semester
        let selectedSubject, selectedGrade, selectedSemester; // User's game selections
        let currentQuestions = [], currentQuestionIndex = 0, score = 0, sessionAnswers = []; // Game state
        const NUM_OF_QUESTIONS_PER_GAME = 10; // Number of questions in one game session
        let timerEnabled = false, timerDuration = 30, timerInterval; // Timer settings and state
        let fullQuestionCollection = []; // All questions loaded from Firestore
        let studentList = []; // List of student names for score saving

        // References to main screen elements
        const screens = {
            selection: document.getElementById('selection-screen'),
            game: document.getElementById('game-screen'),
            admin: document.getElementById('admin-panel'),
            settings: document.getElementById('settings-panel'),
            studentManager: document.getElementById('student-manager-panel'),
            history: document.getElementById('history-panel'),
            leaderboard: document.getElementById('leaderboard-panel'),
            questionManager: document.getElementById('question-manager-panel'),
            aiGenerator: document.getElementById('ai-generator-panel'),
            duplicateManager: document.getElementById('duplicate-manager-panel'), // New duplicate manager panel
        };
        // References to modal elements
        const modals = {
            login: document.getElementById('login-modal'),
            nameSelection: document.getElementById('name-selection-modal'),
            historyDetail: document.getElementById('history-detail-modal'),
            confirmation: document.getElementById('confirmation-modal'),
            questionEdit: document.getElementById('question-edit-modal'),
        };
        
        // Specific elements for leaderboard filtering
        const leaderboardBtn = document.getElementById('leaderboard-btn');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        const leaderboardSubjectFilter = document.getElementById('leaderboard-subject-filter');
        const leaderboardGradeFilter = document.getElementById('leaderboard-grade-filter');
        const leaderboardNameFilter = document.getElementById('leaderboard-name-filter');

        // --- FIREBASE & DATA LOADING ---

        /**
         * Initializes Firebase and loads initial data.
         */
        async function initializeFirebase() {
            try {
                // Check if Firebase config is available
                if (typeof __firebase_config === 'undefined' || !__firebase_config) {
                    console.error("Firebase configuration is not available.");
                    document.getElementById('loading-questions').textContent = "L·ªói c·∫•u h√¨nh. Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn c∆° s·ªü d·ªØ li·ªáu.";
                    return;
                }
                const firebaseConfig = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Get app ID from environment
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Authenticate user (custom token for Canvas, anonymous fallback)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for authentication state changes and load data once authenticated
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("User authenticated, loading data...");
                        // Load all necessary data concurrently
                        Promise.all([loadQuestionsFromFirestore(), loadAdminSettings(), loadApiKey(), loadStudentList()]);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                document.getElementById('loading-questions').textContent = "L·ªói k·∫øt n·ªëi ƒë·∫øn c∆° s·ªü d·ªØ li·ªáu.";
            }
        }

        /**
         * Loads questions from Firestore. If no questions exist, seeds initial data.
         */
        async function loadQuestionsFromFirestore() {
            if (!db || !appId) return; // Ensure Firebase is initialized
            const qCollection = collection(db, `artifacts/${appId}/public/data/questions`);
            try {
                const querySnapshot = await getDocs(qCollection);
                if (querySnapshot.empty) {
                    console.log("No questions found in Firestore. Seeding initial data...");
                    await seedInitialQuestions(); // Seed if collection is empty
                } else {
                    fullQuestionCollection = []; // Clear existing questions
                    querySnapshot.forEach(doc => {
                        fullQuestionCollection.push({ id: doc.id, ...doc.data() }); // Add questions with their IDs
                    });
                    restructureQuestionBank(); // Organize questions for game logic
                    console.log("Successfully loaded questions from Firestore.");
                }
                // Hide loading message and show selection options
                document.getElementById('loading-questions').classList.add('hidden');
                document.getElementById('selections-container').classList.remove('hidden');
                updateStartButtonState(); // Update start button based on selections
            } catch (error) {
                console.error("Error loading questions from Firestore:", error);
                document.getElementById('loading-questions').textContent = "L·ªói khi t·∫£i c√¢u h·ªèi.";
            }
        }

        /**
         * Seeds initial question data into Firestore.
         */
        async function seedInitialQuestions() {
            const seedData = [
                // To√°n L·ªõp 1 - H·ªçc K·ª≥ 1
                { subject: 'toan', grade: 'lop1', semester: 'hocky1', question: "1 + 1 = ?", options: ["1", "2", "3", "4"], answer: "2" },
                { subject: 'toan', grade: 'lop1', semester: 'hocky1', question: "2 + 3 = ?", options: ["4", "5", "6", "7"], answer: "5" },
                { subject: 'toan', grade: 'lop1', semester: 'hocky1', question: "5 - 2 = ?", options: ["1", "2", "3", "4"], answer: "3" },
                { subject: 'toan', grade: 'lop1', semester: 'hocky1', question: "S·ªë li·ªÅn sau c·ªßa 8 l√† s·ªë n√†o?", options: ["7", "9", "10", "8"], answer: "9" },
                { subject: 'toan', grade: 'lop1', semester: 'hocky1', question: "H√¨nh tr√≤n c√≥ m·∫•y c·∫°nh?", options: ["0", "1", "2", "3"], answer: "0" },
                { subject: 'toan', grade: 'lop1', semester: 'hocky1', question: "4 + 0 = ?", options: ["0", "4", "1", "5"], answer: "4" },
                { subject: 'toan', grade: 'lop1', semester: 'hocky1', question: "6 + 3 = ?", options: ["8", "9", "10", "11"], answer: "9" },
                { subject: 'toan', grade: 'lop1', semester: 'hocky1', question: "7 - 4 = ?", options: ["2", "3", "4", "5"], answer: "3" },
                { subject: 'toan', grade: 'lop1', semester: 'hocky1', question: "S·ªë n√†o l·ªõn h∆°n 5 nh∆∞ng b√© h∆°n 7?", options: ["4", "5", "6", "7"], answer: "6" },
                { subject: 'toan', grade: 'lop1', semester: 'hocky1', question: "C√≥ 5 con chim ƒë·∫≠u tr√™n c√¢y, 1 con bay ƒëi. C√≤n l·∫°i m·∫•y con?", options: ["3", "4", "5", "6"], answer: "4" },

                // To√°n L·ªõp 1 - H·ªçc K·ª≥ 2
                { subject: 'toan', grade: 'lop1', semester: 'hocky2', question: "10 + 5 = ?", options: ["12", "15", "10", "5"], answer: "15" },
                { subject: 'toan', grade: 'lop1', semester: 'hocky2', question: "12 - 7 = ?", options: ["3", "4", "5", "6"], answer: "5" },
                { subject: 'toan', grade: 'lop1', semester: 'hocky2', question: "S·ªë l·ªõn nh·∫•t c√≥ m·ªôt ch·ªØ s·ªë l√†?", options: ["8", "9", "10", "1"], answer: "9" },
                { subject: 'toan', grade: 'lop1', semester: 'hocky2', question: "C√≥ 3 qu·∫£ t√°o, th√™m 2 qu·∫£ n·ªØa l√† m·∫•y qu·∫£?", options: ["4", "5", "6", "7"], answer: "5" },
                { subject: 'toan', grade: 'lop1', semester: 'hocky2', question: "S·ªë n√†o b√© h∆°n 11?", options: ["12", "11", "10", "13"], answer: "10" },
                { subject: 'toan', grade: 'lop1', semester: 'hocky2', question: "15 + 3 = ?", options: ["17", "18", "19", "20"], answer: "18" },
                { subject: 'toan', grade: 'lop1', semester: 'hocky2', question: "18 - 6 = ?", options: ["10", "11", "12", "13"], answer: "12" },
                { subject: 'toan', grade: 'lop1', semester: 'hocky2', question: "S·ªë li·ªÅn tr∆∞·ªõc c·ªßa 20 l√† s·ªë n√†o?", options: ["18", "19", "21", "22"], answer: "19" },
                { subject: 'toan', grade: 'lop1', semester: 'hocky2', question: "B·∫°n An c√≥ 7 vi√™n bi, b·∫°n B√¨nh cho An th√™m 4 vi√™n. An c√≥ t·∫•t c·∫£ m·∫•y vi√™n bi?", options: ["10", "11", "12", "13"], answer: "11" },
                { subject: 'toan', grade: 'lop1', semester: 'hocky2', question: "Trong ph√©p t√≠nh 9 - 4 = 5, s·ªë 5 g·ªçi l√† g√¨?", options: ["S·ªë b·ªã tr·ª´", "S·ªë tr·ª´", "Hi·ªáu", "T·ªïng"], answer: "Hi·ªáu" },

                // Ti·∫øng Vi·ªát L·ªõp 1 - H·ªçc K·ª≥ 1
                { subject: 'tiengviet', grade: 'lop1', semester: 'hocky1', question: "Ch·ªØ c√°i ƒë·∫ßu ti√™n trong b·∫£ng ch·ªØ c√°i l√†?", options: ["b", "c", "a", "d"], answer: "a" },
                { subject: 'tiengviet', grade: 'lop1', semester: 'hocky1', question: "T·ª´ n√†o ch·ªâ ho·∫°t ƒë·ªông?", options: ["c√°i b√†n", "ƒëi h·ªçc", "quy·ªÉn s√°ch", "b√¥ng hoa"], answer: "ƒëi h·ªçc" },
                { subject: 'tiengviet', grade: 'lop1', semester: 'hocky1', question: "ƒêi·ªÅn v·∫ßn 'ay' hay 'ai' v√†o ch·ªó tr·ªëng: 'c√°i b___'", options: ["ay", "ai", "ao", "au"], answer: "ai" },
                { subject: 'tiengviet', grade: 'lop1', semester: 'hocky1', question: "Ti·∫øng 'c√¢y' g·ªìm nh·ªØng √¢m n√†o?", options: ["c·ªù - ay", "c·ªù - a - y", "c - ay", "c - a - i"], answer: "c·ªù - ay" },
                { subject: 'tiengviet', grade: 'lop1', semester: 'hocky1', question: "T·ª´ n√†o l√† t√™n con v·∫≠t?", options: ["c√°i b√∫t", "con m√®o", "c√°i gh·∫ø", "b·∫ßu tr·ªùi"], answer: "con m√®o" },
                { subject: 'tiengviet', grade: 'lop1', semester: 'hocky1', question: "Ch·ªçn t·ª´ c√≥ v·∫ßn 'ong'.", options: ["con ch√≥", "c√°i l·ªìng", "b√¥ng hoa", "c√¢y tre"], answer: "c√°i l·ªìng" },
                { subject: 'tiengviet', grade: 'lop1', semester: 'hocky1', question: "T·ª´ n√†o vi·∫øt ƒë√∫ng ch√≠nh t·∫£?", options: ["quy·ªÉn v·ªü", "quy·ªÉn v·ª°", "quy·ªÉn v·ªù", "quy·ªÉn v·ª°"], answer: "quy·ªÉn v·ªü" },
                { subject: 'tiengviet', grade: 'lop1', semester: 'hocky1', question: "ƒêi·ªÅn t·ª´ th√≠ch h·ª£p v√†o c√¢u: 'M·∫π em ƒëang ____ c∆°m.'", options: ["n·∫•u", "n·∫•uu", "n√¢√∫", "n√¢√∫u"], answer: "n·∫•u" },
                { subject: 'tiengviet', grade: 'lop1', semester: 'hocky1', question: "Ti·∫øng 'hoa' g·ªìm nh·ªØng √¢m n√†o?", options: ["h·ªù - oa", "h·ªù - o - a", "ho - a", "h - oa"], answer: "h·ªù - oa" },
                { subject: 'tiengviet', grade: 'lop1', semester: 'hocky1', question: "T·ª´ n√†o ch·ªâ m√†u s·∫Øc?", options: ["c√°i b√†n", "m√†u ƒë·ªè", "ƒëi ch∆°i", "con c√°"], answer: "m√†u ƒë·ªè" },

                // Ti·∫øng Vi·ªát L·ªõp 1 - H·ªçc K·ª≥ 2
                { subject: 'tiengviet', grade: 'lop1', semester: 'hocky2', question: "T·ª´ n√†o vi·∫øt ƒë√∫ng ch√≠nh t·∫£?", options: ["nghi√™ng ng·∫£", "ngi√™ng ng·∫£", "ngi√™n ng·∫£", "nghi√™n ng·∫£"], answer: "nghi√™ng ng·∫£" },
                { subject: 'tiengviet', grade: 'lop1', semester: 'hocky2', question: "Ch·ªçn t·ª´ ƒë√∫ng ƒë·ªÉ ƒëi·ªÅn v√†o c√¢u: 'B√© ƒëang ____ s√°ch.'", options: ["ƒë·ªçc", "ƒëoc", "ƒë·ªçcj", "ƒë·ªçck"], answer: "ƒë·ªçc" },
                { subject: 'tiengviet', grade: 'lop1', semester: 'hocky2', question: "T·ª´ n√†o kh√¥ng c√πng nh√≥m v·ªõi c√°c t·ª´ c√≤n l·∫°i?", options: ["b·ªë", "m·∫π", "√¥ng", "c√°i nh√†"], answer: "c√°i nh√†" },
                { subject: 'tiengviet', grade: 'lop1', semester: 'hocky2', question: "ƒê√¢u l√† c√¢u h·ªèi?", options: ["Em ƒëi h·ªçc.", "Tr·ªùi ƒë·∫πp qu√°!", "B·∫°n t√™n g√¨?", "C√¢y xanh t·ªët."], answer: "B·∫°n t√™n g√¨?" },
                { subject: 'tiengviet', grade: 'lop1', semester: 'hocky2', question: "Ch·ªçn ti·∫øng c√≥ v·∫ßn 'uan'.", options: ["loan", "luan", "lu√¢n", "lo·∫°n"], answer: "loan" },
                { subject: 'tiengviet', grade: 'lop1', semester: 'hocky2', question: "T·ª´ n√†o l√† t·ª´ ch·ªâ ng∆∞·ªùi?", options: ["b√¥ng hoa", "h·ªçc sinh", "c√°i c√¢y", "con chim"], answer: "h·ªçc sinh" },
                { subject: 'tiengviet', grade: 'lop1', semester: 'hocky2', question: "ƒêi·ªÅn d·∫•u ch·∫•m hay d·∫•u h·ªèi v√†o cu·ªëi c√¢u: 'B·∫°n c√≥ kh·ªèe kh√¥ng___'", options: [".", "!", "?", ","], answer: "?" },
                { subject: 'tiengviet', grade: 'lop1', semester: 'hocky2', question: "T·ª´ n√†o c√≥ nghƒ©a l√† 'r·∫•t ƒë·∫πp'?", options: ["x·∫•u x√≠", "xinh x·∫Øn", "b√¨nh th∆∞·ªùng", "nh·ªè b√©"], answer: "xinh x·∫Øn" },
                { subject: 'tiengviet', grade: 'lop1', semester: 'hocky2', question: "Ti·∫øng 's√¥ng' g·ªìm nh·ªØng √¢m n√†o?", options: ["s·ªù - √¥ng", "s·ªù - √¥ - ng", "s - √¥ng", "s - o - ng"], answer: "s·ªù - √¥ng" },
                { subject: 'tiengviet', grade: 'lop1', semester: 'hocky2', question: "T·ª´ n√†o l√† t·ª´ gh√©p?", options: ["c√¢y", "nh√†", "s√°ch v·ªü", "b√∫t"], answer: "s√°ch v·ªü" },

                // To√°n L·ªõp 2 - H·ªçc K·ª≥ 1
                { subject: 'toan', grade: 'lop2', semester: 'hocky1', question: "5 + 3 = ?", options: ["7", "8", "9", "10"], answer: "8" },
                { subject: 'toan', grade: 'lop2', semester: 'hocky1', question: "15 + 7 = ?", options: ["20", "21", "22", "23"], answer: "22" },
                { subject: 'toan', grade: 'lop2', semester: 'hocky1', question: "20 - 8 = ?", options: ["10", "11", "12", "13"], answer: "12" },
                { subject: 'toan', grade: 'lop2', semester: 'hocky1', question: "S·ªë ch·∫µn l·ªõn nh·∫•t c√≥ hai ch·ªØ s·ªë l√†?", options: ["98", "99", "90", "100"], answer: "98" },
                { subject: 'toan', grade: 'lop2', semester: 'hocky1', question: "M·ªôt tu·∫ßn c√≥ m·∫•y ng√†y?", options: ["5", "6", "7", "8"], answer: "7" },
                { subject: 'toan', grade: 'lop2', semester: 'hocky1', question: "Gi√° tr·ªã c·ªßa ch·ªØ s·ªë 3 trong s·ªë 35 l√†?", options: ["3", "30", "5", "35"], answer: "30" },
                { subject: 'toan', grade: 'lop2', semester: 'hocky1', question: "3 x 4 = ?", options: ["7", "12", "15", "18"], answer: "12" },
                { subject: 'toan', grade: 'lop2', semester: 'hocky1', question: "24 : 6 = ?", options: ["3", "4", "5", "6"], answer: "4" },
                { subject: 'toan', grade: 'lop2', semester: 'hocky1', question: "S·ªë l·∫ª b√© nh·∫•t c√≥ hai ch·ªØ s·ªë l√†?", options: ["10", "11", "13", "21"], answer: "11" },
                { subject: 'toan', grade: 'lop2', semester: 'hocky1', question: "Trong ph√©p t√≠nh 6 + 7 = 13, s·ªë 13 g·ªçi l√† g√¨?", options: ["S·ªë h·∫°ng", "T·ªïng", "Hi·ªáu", "Th·ª´a s·ªë"], answer: "T·ªïng" },

                // To√°n L·ªõp 2 - H·ªçc K·ª≥ 2
                { subject: 'toan', grade: 'lop2', semester: 'hocky2', question: "4 x 5 = ?", options: ["9", "15", "20", "25"], answer: "20" },
                { subject: 'toan', grade: 'lop2', semester: 'hocky2', question: "18 : 3 = ?", options: ["4", "5", "6", "7"], answer: "6" },
                { subject: 'toan', grade: 'lop2', semester: 'hocky2', question: "ƒê·ªìng h·ªì ch·ªâ m·∫•y gi·ªù n·∫øu kim ng·∫Øn ch·ªâ s·ªë 3 v√† kim d√†i ch·ªâ s·ªë 12?", options: ["12 gi·ªù", "3 gi·ªù", "6 gi·ªù", "9 gi·ªù"], answer: "3 gi·ªù" },
                { subject: 'toan', grade: 'lop2', semester: 'hocky2', question: "M·ªôt m√©t b·∫±ng bao nhi√™u xƒÉng-ti-m√©t?", options: ["10 cm", "100 cm", "1000 cm", "1 cm"], answer: "100 cm" },
                { subject: 'toan', grade: 'lop2', semester: 'hocky2', question: "H√¨nh tam gi√°c c√≥ m·∫•y ƒë·ªânh?", options: ["2", "3", "4", "5"], answer: "3" },
                { subject: 'toan', grade: 'lop2', semester: 'hocky2', question: "M·ªôt gi·ªù c√≥ bao nhi√™u ph√∫t?", options: ["30 ph√∫t", "60 ph√∫t", "90 ph√∫t", "120 ph√∫t"], answer: "60 ph√∫t" },
                { subject: 'toan', grade: 'lop2', semester: 'hocky2', question: "K·∫øt qu·∫£ c·ªßa 7 x 8 l√†?", options: ["49", "54", "56", "63"], answer: "56" },
                { subject: 'toan', grade: 'lop2', semester: 'hocky2', question: "S·ªë n√†o l√† s·ªë l·∫ª?", options: ["10", "12", "15", "18"], answer: "15" },
                { subject: 'toan', grade: 'lop2', semester: 'hocky2', question: "C√≥ 20 c√°i k·∫πo chia ƒë·ªÅu cho 4 b·∫°n. M·ªói b·∫°n ƒë∆∞·ª£c m·∫•y c√°i k·∫πo?", options: ["4", "5", "6", "7"], answer: "5" },
                { subject: 'toan', grade: 'lop2', semester: 'hocky2', question: "H√¨nh vu√¥ng c√≥ m·∫•y c·∫°nh b·∫±ng nhau?", options: ["2", "3", "4", "5"], answer: "4" },

                // Ti·∫øng Vi·ªát L·ªõp 2 - H·ªçc K·ª≥ 1
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky1', question: "T·ª´ n√†o sau ƒë√¢y l√† t·ª´ ch·ªâ ƒë·∫∑c ƒëi·ªÉm?", options: ["c√°i b√∫t", "h·ªçc b√†i", "xinh ƒë·∫πp", "con ch√≥"], answer: "xinh ƒë·∫πp" },
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky1', question: "ƒêi·ªÅn t·ª´ th√≠ch h·ª£p v√†o ch·ªó tr·ªëng: 'Con chim h√≥t l√≠u ____'.", options: ["lo", "l√¥", "la", "l√°"], answer: "lo" },
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky1', question: "T·ª´ n√†o ƒë·ªìng nghƒ©a v·ªõi 'chƒÉm ch·ªâ'?", options: ["l∆∞·ªùi bi·∫øng", "si√™ng nƒÉng", "nhanh nh·∫πn", "th√¥ng minh"], answer: "si√™ng nƒÉng" },
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky1', question: "T√¨m t·ª´ c√≥ ti·∫øng 's√°ch'.", options: ["cu·ªën s√°ch", "c√°i b√†n", "c√°i gh·∫ø", "c√¢y b√∫t"], answer: "cu·ªën s√°ch" },
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky1', question: "C√¢u n√†o d∆∞·ªõi ƒë√¢y l√† c√¢u k·ªÉ?", options: ["B·∫°n ƒëi ƒë√¢u ƒë·∫•y?", "B·∫°n th·∫≠t gi·ªèi!", "H√¥m nay tr·ªùi ƒë·∫πp.", "H√£y gi√∫p t√¥i!"], answer: "H√¥m nay tr·ªùi ƒë·∫πp." },
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky1', question: "T·ª´ n√†o l√† t·ª´ ch·ªâ s·ª± v·∫≠t?", options: ["ch·∫°y", "vui v·∫ª", "quy·ªÉn v·ªü", "ƒë·ªçc"], answer: "quy·ªÉn v·ªü" },
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky1', question: "ƒêi·ªÅn v·∫ßn 'i√™ng' hay 'y√™ng' v√†o ch·ªó tr·ªëng: 'con chim h√≥t l___'.", options: ["i√™ng", "y√™ng", "i√™n", "y√™n"], answer: "i√™ng" },
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky1', question: "T·ª´ n√†o tr√°i nghƒ©a v·ªõi 'nhanh'?", options: ["ch·∫≠m", "kh·ªèe", "y·∫øu", "b√©"], answer: "ch·∫≠m" },
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky1', question: "Trong c√¢u 'B√© ƒëi h·ªçc.', 'B√©' l√† t·ª´ ch·ªâ g√¨?", options: ["Ho·∫°t ƒë·ªông", "S·ª± v·∫≠t", "ƒê·∫∑c ƒëi·ªÉm", "M√†u s·∫Øc"], answer: "S·ª± v·∫≠t" },
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky1', question: "T·ª´ n√†o l√† t·ª´ ch·ªâ th·ªùi gian?", options: ["c√°i gh·∫ø", "h√¥m qua", "ƒÉn c∆°m", "ƒë·∫πp"], answer: "h√¥m qua" },

                // Ti·∫øng Vi·ªát L·ªõp 2 - H·ªçc K·ª≥ 2
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky2', question: "T·ª´ n√†o tr√°i nghƒ©a v·ªõi 'cao'?", options: ["th·∫•p", "d√†i", "r·ªông", "l·ªõn"], answer: "th·∫•p" },
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky2', question: "ƒêi·ªÅn d·∫•u c√¢u th√≠ch h·ª£p v√†o cu·ªëi c√¢u: 'B·∫°n c√≥ th√≠ch h·ªçc ti·∫øng Vi·ªát kh√¥ng___'", options: [".", "!", "?", ","], answer: "?" },
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky2', question: "T·ª´ n√†o l√† t·ª´ l√°y?", options: ["xanh bi·∫øc", "ƒë·ªè t∆∞∆°i", "long lanh", "vui v·∫ª"], answer: "long lanh" },
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky2', question: "Th√†nh ng·ªØ 'ch·∫≠m nh∆∞ r√πa' d√πng ƒë·ªÉ ch·ªâ ƒëi·ªÅu g√¨?", options: ["Nhanh nh·∫πn", "Ch·∫≠m ch·∫°p", "Kh·ªèe m·∫°nh", "Th√¥ng minh"], answer: "Ch·∫≠m ch·∫°p" },
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky2', question: "Ch·ªçn t·ª´ ƒë√∫ng ƒë·ªÉ ho√†n th√†nh c√¢u: 'M·∫π em l√† m·ªôt ng∆∞·ªùi ph·ª• n·ªØ r·∫•t ____.'", options: ["hi·ªÅn l√†nh", "hi·ªÅn l√†nhs", "hi·ªÅnn l√†nh", "hi·ªÅnlanh"], answer: "hi·ªÅn l√†nh" },
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky2', question: "T·ª´ n√†o l√† t·ª´ gh√©p?", options: ["ƒëi", "ƒë·ª©ng", "h·ªçc t·∫≠p", "ng·ªß"], answer: "h·ªçc t·∫≠p" },
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky2', question: "ƒêi·ªÅn t·ª´ th√≠ch h·ª£p v√†o ch·ªó tr·ªëng: 'Tr·ªùi m∆∞a, ƒë∆∞·ªùng r·∫•t ____.'", options: ["kh√¥", "∆∞·ªõt", "s·∫°ch", "ƒë·∫πp"], answer: "∆∞·ªõt" },
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky2', question: "C√¢u n√†o l√† c√¢u c·∫£m th√°n?", options: ["B·∫°n ƒëang l√†m g√¨?", "Tr·ªùi ∆°i!", "T√¥i ƒëang ƒë·ªçc s√°ch.", "H√¥m nay l√† th·ª© m·∫•y?"], answer: "Tr·ªùi ∆°i!" },
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky2', question: "T·ª´ n√†o l√† t·ª´ ch·ªâ ho·∫°t ƒë·ªông c·ªßa con ng∆∞·ªùi?", options: ["c√°i b√†n", "c√°i gh·∫ø", "ƒÉn u·ªëng", "con m√®o"], answer: "ƒÉn u·ªëng" },
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky2', question: "Ch·ªçn ti·∫øng c√≥ v·∫ßn 'oanh'.", options: ["xoan", "loan", "oanh", "hoanh"], answer: "oanh" },
                // Th√™m m·ªôt s·ªë c√¢u h·ªèi tr√πng l·∫∑p ƒë·ªÉ ki·ªÉm tra t√≠nh nƒÉng qu·∫£n l√Ω tr√πng l·∫∑p
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky1', question: "T·ª´ n√†o sau ƒë√¢y l√† t·ª´ ch·ªâ ƒë·∫∑c ƒëi·ªÉm?", options: ["c√°i b√∫t", "h·ªçc b√†i", "xinh ƒë·∫πp", "con ch√≥"], answer: "xinh ƒë·∫πp" },
                { subject: 'tiengviet', grade: 'lop2', semester: 'hocky1', question: "T·ª´ n√†o sau ƒë√¢y l√† t·ª´ ch·ªâ ƒë·∫∑c ƒëi·ªÉm?", options: ["c√°i b√∫t", "h·ªçc b√†i", "xinh ƒë·∫πp", "con ch√≥"], answer: "xinh ƒë·∫πp" },
                { subject: 'toan', grade: 'lop1', semester: 'hocky1', question: "1 + 1 = ?", options: ["1", "2", "3", "4"], answer: "2" },
            ];
            const qCollection = collection(db, `artifacts/${appId}/public/data/questions`);
            const promises = seedData.map(q => addDoc(qCollection, q)); // Add each question as a document
            await Promise.all(promises);
            await loadQuestionsFromFirestore(); // Reload questions after seeding
        }

        /**
         * Restructures the flat list of questions into a nested object
         * for easier access by subject, grade, and semester.
         */
        function restructureQuestionBank() {
            questionBank = {}; // Reset question bank
            fullQuestionCollection.forEach(q => {
                const { subject, grade, semester } = q;
                if (!subject || !grade || !semester) return; // Skip invalid questions
                if (!questionBank[subject]) questionBank[subject] = {};
                if (!questionBank[subject][grade]) questionBank[subject][grade] = {};
                if (!questionBank[subject][grade][semester]) questionBank[subject][grade][semester] = [];
                questionBank[subject][grade][semester].push(q);
            });
        }

        /**
         * Loads admin settings (like timer preferences) from Firestore.
         */
        async function loadAdminSettings() {
            if (!db || !appId) return;
            const settingsRef = doc(db, `artifacts/${appId}/public/data/adminSettings`, 'config');
            try {
                const docSnap = await getDoc(settingsRef);
                if (docSnap.exists()) {
                    const settings = docSnap.data();
                    timerEnabled = settings.timerEnabled ?? false; // Default to false if not set
                    timerDuration = settings.timerDuration ?? 30; // Default to 30 seconds if not set
                }
            } catch (error) { 
                console.error("Error loading admin settings:", error); 
            }
        }

        /**
         * Saves admin settings to Firestore.
         * @param {HTMLButtonElement} button - The button element that triggered the save.
         */
        async function saveAdminSettings(button) {
            setButtonLoading(button, true); // Show loading spinner
            const newTimerEnabled = document.getElementById('timer-toggle').checked;
            const newTimerDuration = parseInt(document.getElementById('timer-duration').value, 10);
            const feedbackEl = document.getElementById('settings-feedback');

            // Validate timer duration input
            if (isNaN(newTimerDuration) || newTimerDuration < 5 || newTimerDuration > 120) {
                feedbackEl.textContent = "Th·ªùi gian ph·∫£i t·ª´ 5 ƒë·∫øn 120 gi√¢y.";
                feedbackEl.className = 'text-center text-sm font-bold h-4 mt-4 text-red-600';
                setButtonLoading(button, false);
                return;
            }

            const settingsRef = doc(db, `artifacts/${appId}/public/data/adminSettings`, 'config');
            try {
                await setDoc(settingsRef, { timerEnabled: newTimerEnabled, timerDuration: newTimerDuration }, { merge: true });
                timerEnabled = newTimerEnabled; // Update local state
                timerDuration = newTimerDuration; // Update local state
                feedbackEl.textContent = "ƒê√£ l∆∞u c√†i ƒë·∫∑t!";
                feedbackEl.className = 'text-center text-sm font-bold h-4 mt-4 text-green-800';
                setTimeout(() => feedbackEl.textContent = '', 3000); // Clear feedback after 3 seconds
            } catch (error) {
                console.error("Error saving settings:", error);
                feedbackEl.textContent = "L·ªói khi l∆∞u c√†i ƒë·∫∑t.";
                feedbackEl.className = 'text-center text-sm font-bold h-4 mt-4 text-red-600';
            } finally {
                setButtonLoading(button, false); // Hide loading spinner
            }
        }

        /**
         * Loads the user-defined Gemini API key from Firestore.
         */
        async function loadApiKey() {
            const keyRef = doc(db, `artifacts/${appId}/public/data/adminSettings`, 'geminiKey');
            const statusEl = document.getElementById('gemini-api-status');
            try {
                const docSnap = await getDoc(keyRef);
                if (docSnap.exists() && docSnap.data().key) {
                    userDefinedApiKey = docSnap.data().key;
                    document.getElementById('gemini-api-key-input').value = userDefinedApiKey; // Display the key
                    statusEl.textContent = "ƒêang s·ª≠ d·ª•ng API Key c·ªßa b·∫°n.";
                    statusEl.className = 'text-center text-sm font-semibold h-4 text-green-700'; // Green for active
                } else {
                    userDefinedApiKey = null;
                    document.getElementById('gemini-api-key-input').value = ""; // Clear input
                    statusEl.textContent = "ƒêang s·ª≠ d·ª•ng API Key m·∫∑c ƒë·ªãnh c·ªßa h·ªá th·ªëng.";
                    statusEl.className = 'text-center text-sm font-semibold h-4 text-gray-700'; // Gray for default
                }
            } catch (error) {
                console.error("Error loading API key:", error);
                userDefinedApiKey = null;
                document.getElementById('gemini-api-key-input').value = "";
                statusEl.textContent = "L·ªói khi t·∫£i API Key.";
                statusEl.className = 'text-center text-sm font-semibold h-4 text-red-600'; // Red for error
            }
        }

        /**
         * Saves the user-provided Gemini API key to Firestore.
         * @param {HTMLButtonElement} button - The button element that triggered the save.
         */
        async function saveApiKey(button) {
            setButtonLoading(button, true);
            const newKey = document.getElementById('gemini-api-key-input').value.trim();
            const feedbackEl = document.getElementById('settings-feedback'); // General settings feedback
            const statusEl = document.getElementById('gemini-api-status'); // Specific API status

            if (!newKey) {
                feedbackEl.textContent = "API Key kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.";
                feedbackEl.className = 'text-center text-sm font-bold h-4 mt-4 text-red-600';
                setButtonLoading(button, false);
                return;
            }
            const keyRef = doc(db, `artifacts/${appId}/public/data/adminSettings`, 'geminiKey');
            try {
                await setDoc(keyRef, { key: newKey });
                userDefinedApiKey = newKey;
                feedbackEl.textContent = "ƒê√£ l∆∞u API Key th√†nh c√¥ng!";
                feedbackEl.className = 'text-center text-sm font-bold h-4 mt-4 text-green-800';
                document.getElementById('gemini-api-key-input').value = newKey; // Keep the new key visible
                statusEl.textContent = "ƒêang s·ª≠ d·ª•ng API Key c·ªßa b·∫°n.";
                statusEl.className = 'text-center text-sm font-semibold h-4 text-green-700';
                setTimeout(() => feedbackEl.textContent = '', 3000);
            } catch (error) {
                console.error("Error saving API key:", error);
                feedbackEl.textContent = "L·ªói khi l∆∞u API Key.";
                feedbackEl.className = 'text-center text-sm font-bold h-4 mt-4 text-red-600';
            } finally {
                setButtonLoading(button, false);
            }
        }

        /**
         * Deletes the stored Gemini API key from Firestore.
         * @param {HTMLButtonElement} button - The button element that triggered the delete.
         */
        async function deleteApiKey(button) {
            setButtonLoading(button, true);
            const keyRef = doc(db, `artifacts/${appId}/public/data/adminSettings`, 'geminiKey');
            const feedbackEl = document.getElementById('settings-feedback'); // General settings feedback
            const statusEl = document.getElementById('gemini-api-status'); // Specific API status

            try {
                await deleteDoc(keyRef);
                userDefinedApiKey = null;
                feedbackEl.textContent = "ƒê√£ x√≥a API Key. H·ªá th·ªëng s·∫Ω d√πng key m·∫∑c ƒë·ªãnh.";
                feedbackEl.className = 'text-center text-sm font-bold h-4 mt-4 text-green-800';
                document.getElementById('gemini-api-key-input').value = ""; // Clear input field
                statusEl.textContent = "ƒêang s·ª≠ d·ª•ng API Key m·∫∑c ƒë·ªãnh c·ªßa h·ªá th·ªëng.";
                statusEl.className = 'text-center text-sm font-semibold h-4 text-gray-700';
                setTimeout(() => feedbackEl.textContent = '', 3000);
            } catch (error) {
                console.error("Error deleting API key:", error);
                feedbackEl.textContent = "L·ªói khi x√≥a API Key.";
                feedbackEl.className = 'text-center text-sm font-bold h-4 mt-4 text-red-600';
            } finally {
                setButtonLoading(button, false);
            }
        }
        
        // --- AI EXPLANATION & GENERATION ---

        /**
         * Fetches an explanation for a given question and answer from the AI.
         * @param {string} question - The question text.
         * @param {string} answer - The correct answer text.
         * @param {string} grade - The grade level (e.g., 'lop1', 'lop2') for context.
         */
        async function getExplanationFromAI(question, answer, grade) {
            const explanationContainer = document.getElementById('explanation-container');
            const explanationTextEl = document.getElementById('explanation-text');
            explanationTextEl.textContent = 'ƒêang t·∫°o gi·∫£i th√≠ch...'; // Show loading message
            explanationContainer.classList.remove('hidden'); // Show explanation container

            const gradeMap = { lop1: "l·ªõp 1", lop2: "l·ªõp 2" };
            const gradeText = gradeMap[grade] || "h·ªçc sinh ti·ªÉu h·ªçc"; // Default if grade not found
            // Construct the prompt for the AI
            const prompt = `H√£y gi·∫£i th√≠ch ƒë√°p √°n cho c√¢u h·ªèi sau m·ªôt c√°ch th·∫≠t ng·∫Øn g·ªçn v√† d·ªÖ hi·ªÉu, ph√π h·ª£p v·ªõi tr√¨nh ƒë·ªô c·ªßa h·ªçc sinh ${gradeText}. C√¢u h·ªèi: "${question}" ƒê√°p √°n ƒë√∫ng l√†: "${answer}".`;

            try {
                const generatedText = await callGeminiAPI(prompt); // Call AI without schema for free-form text
                explanationTextEl.textContent = `üí° Gi·∫£i th√≠ch: ${generatedText}`;
                document.getElementById('read-explanation-btn').onclick = () => speakText(generatedText); // Enable speech for explanation
                document.getElementById('read-explanation-btn').style.display = 'block'; // Show speaker button
            } catch (error) {
                console.error("Error in explanation process:", error);
                explanationTextEl.textContent = 'Kh√¥ng th·ªÉ t·∫°o gi·∫£i th√≠ch l√∫c n√†y.';
                document.getElementById('read-explanation-btn').style.display = 'none'; // Hide speaker button on error
            }
        }

        /**
         * Makes a call to the Gemini API.
         * @param {string} prompt - The text prompt for the AI.
         * @param {object} [jsonSchema=null] - Optional JSON schema for structured responses.
         * @returns {Promise<string>} - The generated text content from the AI.
         */
        async function callGeminiAPI(prompt, jsonSchema = null) {
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            if (jsonSchema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: jsonSchema
                };
            }
            
            const apiKey = userDefinedApiKey || ""; // Use user's key or default (Canvas will inject)
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API call failed with status: ${response.status}. Body: ${errorBody}`);
            }
            
            const result = await response.json();
            const generatedContent = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!generatedContent) {
                throw new Error("Invalid response structure from API.");
            }
            return generatedContent;
        }

        // --- HISTORY & LEADERBOARD ---

        /**
         * Saves quiz result to Firestore for history and leaderboard.
         * @param {object} resultData - The quiz result data.
         * @param {string|null} playerName - The name of the player, or null if skipped.
         */
        async function saveResult(resultData, playerName = null) {
            if (!db || !appId || !auth.currentUser) return;

            const dataToSaveForHistory = { ...resultData, name: playerName };
            const dataToSaveForLeaderboard = { 
                name: playerName, 
                score: resultData.score, 
                totalQuestions: resultData.totalQuestions, 
                subject: resultData.subject, 
                grade: resultData.grade, 
                date: resultData.date 
            };

            // Save to leaderboard if player name is provided
            if (playerName) {
                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/leaderboard`), dataToSaveForLeaderboard);
                    console.log("Score saved to leaderboard!");
                } catch (e) {
                    console.error("Error writing to leaderboard:", e);
                }
            }
            
            // Always save full quiz result to history
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/quizResults`), dataToSaveForHistory);
                    console.log("Full quiz result saved to history!");
            } catch (e) {
                console.error("Error writing to history:", e);
            }
        }

        /**
         * Displays the quiz history from Firestore.
         */
        async function displayHistory() {
            showScreen('history');
            const container = document.getElementById('history-table-container');
            container.innerHTML = '<p class="text-center text-gray-500">ƒêang t·∫£i l·ªãch s·ª≠...</p>';

            if (!db || !appId) {
                container.innerHTML = '<p class="text-center text-red-500">L·ªói CSDL.</p>';
                return;
            }

            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/quizResults`));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    container.innerHTML = '<p class="text-center text-gray-500">Ch∆∞a c√≥ l·ªãch s·ª≠ l√†m b√†i.</p>';
                    return;
                }

                const results = [];
                querySnapshot.forEach(doc => results.push({id: doc.id, ...doc.data()}));
                // Sort by date in descending order
                results.sort((a, b) => (b.date?.toDate() || 0) - (a.date?.toDate() || 0));

                // Map for display names
                const nameMap = { toan: 'To√°n', tiengviet: 'Ti·∫øng Vi·ªát', lop1: 'L·ªõp 1', lop2: 'L·ªõp 2', hocky1: 'H·ªçc K·ª≥ 1', hocky2: 'H·ªçc K·ª≥ 2' };

                let tableHTML = `
                    <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-gray-100/50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase">Ng√†y Gi·ªù</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase">T√™n</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase">M√¥n</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase">ƒêi·ªÉm</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase">Chi ti·∫øt</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="bg-white/30 divide-y divide-gray-200 text-gray-800">
                `;

                results.forEach((r, index) => {
                    const date = r.date?.toDate() ? r.date.toDate().toLocaleString('vi-VN') : 'N/A';
                    const scoreDisplay = `${r.score}/${r.totalQuestions || 10}`;
                    tableHTML += `
                        <tr>
                            <td class="px-3 py-2 text-sm">${date}</td>
                            <td class="px-3 py-2 text-sm font-semibold">${r.name || 'Kh√¥ng l∆∞u'}</td>
                            <td class="px-3 py-2 text-sm">${nameMap[r.subject] || r.subject}</td>
                            <td class="px-3 py-2 text-sm font-bold">${scoreDisplay}</td>
                            <td class="px-3 py-2 text-sm">
                                <button data-index="${index}" class="view-detail-btn bg-blue-500 text-white px-2 py-1 rounded-md text-xs hover:bg-blue-600">Xem</button>
                            </td>
                        </tr>
                    `;
                });
                tableHTML += '</tbody></table>';
                container.innerHTML = tableHTML;

                // Add event listener for detail buttons
                document.getElementById('history-table-body').addEventListener('click', (e) => {
                    if (e.target.classList.contains('view-detail-btn')) {
                        const index = e.target.dataset.index;
                        showHistoryDetail(results[index]);
                    }
                });

            } catch (error) {
                console.error("Error fetching history:", error);
                container.innerHTML = '<p class="text-center text-red-500">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠.</p>';
            }
        }

        /**
         * Displays the detailed view of a single quiz result.
         * @param {object} result - The quiz result object to display.
         */
        function showHistoryDetail(result) {
            const summaryEl = document.getElementById('history-detail-summary');
            const contentEl = document.getElementById('history-detail-content');

            summaryEl.innerHTML = `<strong>T√™n:</strong> ${result.name || 'Kh√¥ng l∆∞u'} | <strong>ƒêi·ªÉm:</strong> ${result.score}/${result.totalQuestions}`;
            contentEl.innerHTML = ''; // Clear previous content

            if (result.questions && Array.isArray(result.questions)) {
                result.questions.forEach((q, index) => {
                    const isCorrect = q.isCorrect;
                    const itemEl = document.createElement('div');
                    itemEl.className = `p-3 rounded-lg border ${isCorrect ? 'border-green-500 bg-green-100/50' : 'border-red-500 bg-red-100/50'}`;
                    itemEl.innerHTML = `
                        <p class="font-bold text-gray-800">${index + 1}. ${q.questionText}</p>
                        <p class="text-sm ${isCorrect ? 'text-green-700' : 'text-red-700'}"><strong>B√© ch·ªçn:</strong> ${q.userAnswer || 'Kh√¥ng tr·∫£ l·ªùi'}</p>
                        ${!isCorrect ? `<p class="text-sm text-blue-700"><strong>ƒê√°p √°n ƒë√∫ng:</strong> ${q.correctAnswer}</p>` : ''}
                    `;
                    contentEl.appendChild(itemEl);
                });
            } else {
                contentEl.innerHTML = '<p>Kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt cho l·∫ßn ch∆°i n√†y.</p>';
            }
            showModal('historyDetail');
        }

        /**
         * Displays the leaderboard from Firestore, with filtering options.
         */
        async function displayLeaderboard() {
            showScreen('leaderboard');
            const container = document.getElementById('leaderboard-table-container');
            container.innerHTML = '<p class="text-center text-gray-500">ƒêang t·∫£i b·∫£ng x·∫øp h·∫°ng...</p>';

            if (!db || !appId) {
                container.innerHTML = '<p class="text-center text-red-500">L·ªói CSDL.</p>';
                return;
            }

            const subjectFilter = leaderboardSubjectFilter.value;
            const gradeFilter = leaderboardGradeFilter.value;
            const nameFilter = leaderboardNameFilter.value.trim().toLowerCase();

            try {
                let queryConstraints = [];
                // Add subject and grade filters if selected
                if (subjectFilter !== 'all') queryConstraints.push(where("subject", "==", subjectFilter));
                if (gradeFilter !== 'all') queryConstraints.push(where("grade", "==", gradeFilter));

                const q = query(collection(db, `artifacts/${appId}/public/data/leaderboard`), ...queryConstraints);
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    container.innerHTML = '<p class="text-center text-gray-500">Ch∆∞a c√≥ ai tr√™n b·∫£ng x·∫øp h·∫°ng cho m·ª•c n√†y.</p>';
                    return;
                }

                let results = [];
                querySnapshot.forEach(doc => {
                    results.push(doc.data());
                });

                // Apply name filter in memory (Firestore doesn't support 'like' queries directly)
                if (nameFilter) {
                    results = results.filter(r => r.name && r.name.toLowerCase().includes(nameFilter));
                }

                // Sort results: primary by score (desc), secondary by date (desc)
                results.sort((a, b) => {
                    if (b.score !== a.score) {
                        return b.score - a.score;
                    }
                    const dateA = a.date?.toDate() || new Date(0);
                    const dateB = b.date?.toDate() || new Date(0);
                    return dateB - dateA;
                });

                const topResults = results.slice(0, 10); // Show only top 10

                if (topResults.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p.</p>';
                    return;
                }

                let tableHTML = `
                    <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-gray-100/50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase">H·∫°ng</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase">T√™n B√©</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase">ƒêi·ªÉm</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white/30 divide-y divide-gray-200 text-gray-800">
                `;

                topResults.forEach((data, index) => {
                    const scoreDisplay = `${data.score}/${data.totalQuestions || 10}`;
                    tableHTML += `
                        <tr>
                            <td class="px-3 py-2 text-center text-sm font-bold">${index + 1}</td>
                            <td class="px-3 py-2 text-sm font-semibold">${data.name}</td>
                            <td class="px-3 py-2 text-sm font-bold">${scoreDisplay}</td>
                        </tr>
                    `;
                });
                tableHTML += '</tbody></table>';
                container.innerHTML = tableHTML;

            } catch (error) {
                console.error("Error fetching leaderboard:", error);
                container.innerHTML = '<p class="text-center text-red-500">Kh√¥ng th·ªÉ t·∫£i b·∫£ng x·∫øp h·∫°ng.</p>';
            }
        }
        
        // --- GAME LOGIC ---

        /**
         * Updates the state of the "Start" button based on selection validity.
         */
        function updateStartButtonState() {
            if (selectedSubject && selectedGrade && selectedSemester && questionBank && questionBank[selectedSubject]?.[selectedGrade]?.[selectedSemester]?.length > 0) {
                document.getElementById('start-btn').disabled = false;
                document.getElementById('start-btn').classList.remove('bg-gray-500/50', 'cursor-not-allowed');
                document.getElementById('start-btn').classList.add('bg-blue-600/70', 'hover:bg-blue-600/90');
            } else {
                document.getElementById('start-btn').disabled = true;
                document.getElementById('start-btn').classList.add('bg-gray-500/50', 'cursor-not-allowed');
                document.getElementById('start-btn').classList.remove('bg-blue-600/70', 'hover:bg-blue-600/90');
            }
        }

        /**
         * Initializes and starts a new game session.
         */
        function startGame() {
            clearInterval(timerInterval); // Clear any previous timer
            sessionAnswers = []; // Reset recorded answers for the session

            const errorEl = document.getElementById('start-error');
            errorEl.textContent = ''; // Clear previous errors

            // Check if questions exist for the selected criteria
            const questionsExist = questionBank?.[selectedSubject]?.[selectedGrade]?.[selectedSemester]?.length > 0;
            if (!questionsExist) {
                errorEl.textContent = "L·ªói: Kh√¥ng t√¨m th·∫•y b·ªô c√¢u h·ªèi. Vui l√≤ng ch·ªçn l·∫°i.";
                setTimeout(() => { errorEl.textContent = ''; }, 4000);
                return;
            }

            let allQuestions = questionBank[selectedSubject][selectedGrade][selectedSemester];
            // Shuffle and pick a subset of questions for the game
            currentQuestions = allQuestions.sort(() => 0.5 - Math.random()).slice(0, NUM_OF_QUESTIONS_PER_GAME);

            if (currentQuestions.length === 0) {
                errorEl.textContent = "L·ªói: Kh√¥ng ƒë·ªß c√¢u h·ªèi ƒë·ªÉ b·∫Øt ƒë·∫ßu. Vui l√≤ng ch·ªçn l·∫°i.";
                setTimeout(() => { errorEl.textContent = ''; }, 4000);
                return;
            }

            currentQuestionIndex = 0; // Reset question index
            score = 0; // Reset score
            showScreen('game'); // Switch to game screen
            displayQuestion(); // Display the first question
        }

        /**
         * Displays the current question and its options.
         */
        function displayQuestion() {
            clearInterval(timerInterval); // Clear timer for previous question
            document.getElementById('feedback-container').innerHTML = ''; // Clear feedback
            document.getElementById('explanation-container').classList.add('hidden'); // Hide explanation
            document.getElementById('next-btn').classList.add('hidden'); // Hide next button

            const questionData = currentQuestions[currentQuestionIndex];
            document.getElementById('question-container').querySelector('p').textContent = questionData.question;
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = ''; // Clear previous options

            // Shuffle options for the current question
            const shuffledOptions = [...questionData.options].sort(() => Math.random() - 0.5);
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'answer-option w-full p-4 rounded-2xl font-semibold glass-btn bg-white/20 hover:bg-white/40 text-gray-800';
                button.onclick = (e) => {
                    playSound('click');
                    checkAnswer(e.target, questionData.answer);
                };
                optionsContainer.appendChild(button);
            });

            // Update progress and score display
            document.getElementById('progress-text').textContent = `C√¢u ${currentQuestionIndex + 1}/${currentQuestions.length}`;
            document.getElementById('score-text').textContent = `ƒêi·ªÉm: ${score}`;
            document.getElementById('read-question-btn').onclick = () => speakText(questionData.question);

            const timerDisplay = document.getElementById('timer-display');
            if (timerEnabled) {
                timerDisplay.classList.remove('hidden');
                let timeLeft = timerDuration;
                timerDisplay.textContent = `‚è∞ ${timeLeft}`;
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timerDisplay.textContent = `‚è∞ ${timeLeft}`;
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        document.getElementById('feedback-container').textContent = '‚åõ H·∫øt gi·ªù!';
                        checkAnswer({ textContent: null }, questionData.answer); // Pass null for no selection
                    }
                }, 1000);
            } else {
                timerDisplay.classList.add('hidden');
            }
        }

        /**
         * Checks the selected answer against the correct answer.
         * @param {HTMLButtonElement} selectedButton - The button element that was clicked.
         * @param {string} correctAnswer - The correct answer string.
         */
        function checkAnswer(selectedButton, correctAnswer) {
            clearInterval(timerInterval); // Stop the timer
            // Disable all answer options after a selection
            document.querySelectorAll('.answer-option').forEach(btn => btn.disabled = true);

            const questionData = currentQuestions[currentQuestionIndex];
            const userAnswer = selectedButton.textContent; // Get text content of selected button
            const isCorrect = userAnswer == correctAnswer;

            if (isCorrect) {
                score++;
                if (selectedButton.classList) { // Check if selectedButton is a valid DOM element
                    selectedButton.classList.add('correct');
                }
                document.getElementById('feedback-container').textContent = 'üéâ ƒê√∫ng r·ªìi!';
                playSound('correct');
            } else {
                if (userAnswer) { // Only add incorrect class if an answer was actually selected
                    selectedButton.classList.add('incorrect');
                }
                if (document.getElementById('feedback-container').textContent === '') {
                    document.getElementById('feedback-container').textContent = 'üò• Sai r·ªìi!';
                }
                playSound('incorrect');
                // Highlight the correct answer
                document.querySelectorAll('.answer-option').forEach(btn => {
                    if (btn.textContent == correctAnswer) btn.classList.add('correct');
                });
            }

            // Record the answer for history
            sessionAnswers.push({
                questionText: questionData.question,
                userAnswer: userAnswer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect
            });

            // Get AI explanation for the answer
            getExplanationFromAI(questionData.question, questionData.answer, selectedGrade);
            
            document.getElementById('score-text').textContent = `ƒêi·ªÉm: ${score}`;
            document.getElementById('next-btn').classList.remove('hidden'); // Show next button

            // Stop any ongoing speech
            if (speechSynthesis.speaking) speechSynthesis.cancel();
        }

        /**
         * Moves to the next question or shows results if game is over.
         */
        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuestions.length) {
                displayQuestion();
            } else {
                showResults();
            }
        }

        /**
         * Displays the final game results and prompts for name selection.
         */
        function showResults() {
            playSound('complete'); // Play completion sound
            const finalScore = score;
            const totalQuestions = currentQuestions.length;
            document.getElementById('modal-final-score').textContent = `${finalScore}/${totalQuestions}`;

            const percentage = (finalScore / totalQuestions) * 100;
            const finalMessageElement = document.getElementById('modal-final-message');
            if (percentage === 100) finalMessageElement.textContent = "Xu·∫•t s·∫Øc! B√© th·∫≠t l√† gi·ªèi! H√£y ch·ªçn t√™n ƒë·ªÉ l∆∞u ƒëi·ªÉm nh√©.";
            else if (percentage >= 70) finalMessageElement.textContent = "Gi·ªèi l·∫Øm! H√£y ch·ªçn t√™n ƒë·ªÉ l∆∞u ƒëi·ªÉm nh√©.";
            else if (percentage >= 50) finalMessageElement.textContent = "L√†m t·ªët l·∫Øm! H√£y ch·ªçn t√™n ƒë·ªÉ l∆∞u ƒëi·ªÉm nh√©.";
            else finalMessageElement.textContent = "C·ªë g·∫Øng h∆°n l·∫ßn sau nh√©! Ch·ªçn t√™n ƒë·ªÉ l∆∞u ƒëi·ªÉm n√†o.";

            // Prepare result data to save
            const resultData = {
                date: serverTimestamp(),
                subject: selectedSubject,
                grade: selectedGrade,
                semester: selectedSemester,
                score: score,
                totalQuestions: currentQuestions.length,
                questions: sessionAnswers // Detailed answers for history
            };

            populateNameSelectionModal(); // Populate student names for selection

            // Event listener for name selection buttons
            document.getElementById('name-selection-container').onclick = (e) => {
                if (e.target.classList.contains('name-btn')) {
                    playSound('click');
                    const playerName = e.target.dataset.name;
                    saveResult(resultData, playerName); // Save with selected name
                    hideModal('nameSelection');
                    displayLeaderboard(); // Show leaderboard after saving
                }
            };

            // Event listener for skipping and playing again
            document.getElementById('skip-and-play-again-btn').onclick = () => {
                playSound('click');
                saveResult(resultData, null); // Save without a specific name
                hideModal('nameSelection');
                resetGame(); // Reset game to selection screen
            };

            showModal('nameSelection'); // Show the name selection modal
        }

        /**
         * Resets the game to the initial selection screen.
         */
        function resetGame() {
            showScreen('selection');
            selectedSubject = null;
            selectedGrade = null;
            selectedSemester = null;
            // Deselect all choice buttons
            document.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('selected'));
            updateStartButtonState(); // Update start button state
        }

        // --- UI & MODAL MANAGEMENT ---

        /**
         * Shows a specific screen and hides all others.
         * @param {string} screenName - The ID of the screen to show (e.g., 'selection', 'game').
         */
        function showScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.add('hidden')); // Hide all screens
            if (screens[screenName]) {
                screens[screenName].classList.remove('hidden'); // Show the target screen
            }
        }

        /**
         * Shows a specific modal with a fade-in effect.
         * @param {string} modalName - The ID of the modal to show.
         */
        function showModal(modalName) {
            if (modals[modalName]) {
                modals[modalName].classList.remove('hidden');
                // Trigger reflow to ensure transition plays
                setTimeout(() => modals[modalName].classList.remove('opacity-0'), 10);
            }
        }

        /**
         * Hides a specific modal with a fade-out effect.
         * @param {string} modalName - The ID of the modal to hide.
         */
        function hideModal(modalName) {
            if (modals[modalName]) {
                modals[modalName].classList.add('opacity-0');
                // Hide completely after transition
                setTimeout(() => modals[modalName].classList.add('hidden'), 300);
            }
        }

        /**
         * Uses the Web Speech API to speak a given text.
         * @param {string} text - The text to be spoken.
         */
        function speakText(text) {
            if (!'speechSynthesis' in window) {
                console.warn("Speech synthesis not supported.");
                return;
            }
            if (speechSynthesis.speaking) speechSynthesis.cancel(); // Stop current speech
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'vi-VN'; // Set language to Vietnamese
            // Try to find a Vietnamese voice
            const voice = speechSynthesis.getVoices().find(v => v.lang === 'vi-VN');
            if (voice) utterance.voice = voice;
            speechSynthesis.speak(utterance);
        }

        let confirmCallback = null; // Callback function for confirmation modal

        /**
         * Displays a generic confirmation modal.
         * @param {string} message - The message to display in the modal.
         * @param {function} onConfirm - The callback function to execute if confirmed.
         */
        function showConfirmationModal(message, onConfirm) {
            document.getElementById('confirmation-message').textContent = message;
            confirmCallback = onConfirm; // Store the callback
            showModal('confirmation');
        }

        /**
         * Clears all documents from a specified Firestore collection.
         * @param {string} collectionName - The name of the collection to clear (e.g., 'leaderboard', 'quizResults').
         * @param {HTMLButtonElement} button - The button element that triggered the action.
         */
        async function clearCollection(collectionName, button) {
            setButtonLoading(button, true); // Show loading spinner
            const feedbackEl = document.getElementById('settings-feedback');
            const friendlyName = collectionName === 'leaderboard' ? 'B·∫£ng x·∫øp h·∫°ng' : 'L·ªãch s·ª≠ thi';
            feedbackEl.textContent = `ƒêang x√≥a ${friendlyName}...`;
            feedbackEl.className = 'text-center text-sm font-bold h-4 mt-4 text-gray-700';

            const collectionRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
            try {
                const querySnapshot = await getDocs(collectionRef);
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref)); // Collect all delete promises
                });
                await Promise.all(deletePromises); // Execute all deletes concurrently
                console.log(`${collectionName} cleared successfully.`);
                feedbackEl.textContent = `ƒê√£ x√≥a th√†nh c√¥ng ${friendlyName}!`;
                feedbackEl.classList.add('text-green-800');
                setTimeout(() => feedbackEl.textContent = '', 4000);
            } catch (error) {
                console.error(`Error clearing ${collectionName}:`, error);
                feedbackEl.textContent = `L·ªói khi x√≥a ${friendlyName}.`;
                feedbackEl.classList.add('text-red-600');
            } finally {
                setButtonLoading(button, false); // Hide loading spinner
            }
        }

        /**
         * Toggles a loading spinner on a button.
         * @param {HTMLButtonElement} button - The button element.
         * @param {boolean} isLoading - True to show spinner, false to hide.
         */
        function setButtonLoading(button, isLoading) {
            if (isLoading) {
                button.disabled = true;
                button.dataset.originalContent = button.innerHTML; // Store original content
                button.innerHTML = '<div class="spinner mx-auto"></div>'; // Replace with spinner
            } else {
                button.disabled = false;
                button.innerHTML = button.dataset.originalContent; // Restore original content
            }
        }

        // --- ADMIN STUDENT MANAGEMENT ---

        /**
         * Loads the list of student names from Firestore.
         */
        async function loadStudentList() {
            const docRef = doc(db, `artifacts/${appId}/public/data/students`, 'studentList');
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists() && docSnap.data().names) {
                    studentList = docSnap.data().names;
                } else {
                    // If no list exists, create one with default names
                    studentList = ["Th·∫£o Huy·ªÅn", "H·∫±ng Nga"];
                    await setDoc(docRef, { names: studentList }); // Create the document
                }
                console.log("Student list loaded:", studentList);
            } catch (error) {
                console.error("Error loading student list:", error);
                studentList = ["Th·∫£o Huy·ªÅn", "H·∫±ng Nga"]; // Fallback to default on error
            }
        }

        /**
         * Displays the student management panel and populates the student list.
         */
        function displayStudentManager() {
            showScreen('studentManager');
            populateStudentList();
        }

        /**
         * Populates the student list display in the admin panel.
         */
        function populateStudentList() {
            const container = document.getElementById('student-list-container');
            container.innerHTML = ''; // Clear existing list
            if (studentList.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-600 font-semibold p-4">Ch∆∞a c√≥ h·ªçc sinh n√†o.</p>';
                return;
            }
            studentList.forEach(name => {
                const itemEl = document.createElement('div');
                itemEl.className = 'p-3 bg-black/10 rounded-lg flex justify-between items-center';
                itemEl.innerHTML = `
                    <p class="font-semibold text-gray-800">${name}</p>
                    <button data-name="${name}" class="delete-student-btn text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">X√≥a</button>
                `;
                container.appendChild(itemEl);
            });
        }

        /**
         * Adds a new student name to the list in Firestore.
         * @param {string} name - The name of the student to add.
         */
        async function addStudent(name) {
            if (!name || studentList.includes(name)) {
                // Using a custom modal instead of alert
                showConfirmationModal("T√™n kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ t·ªìn t·∫°i.", () => {});
                return;
            }
            const docRef = doc(db, `artifacts/${appId}/public/data/students`, 'studentList');
            try {
                await updateDoc(docRef, { names: arrayUnion(name) }); // Add name to the array
                await loadStudentList(); // Reload the list
                populateStudentList(); // Update UI
            } catch (error) {
                console.error("Error adding student:", error);
                showConfirmationModal("L·ªói khi th√™m h·ªçc sinh.", () => {});
            }
        }

        /**
         * Deletes a student name from the list in Firestore.
         * @param {string} name - The name of the student to delete.
         */
        async function deleteStudent(name) {
            const docRef = doc(db, `artifacts/${appId}/public/data/students`, 'studentList');
            try {
                await updateDoc(docRef, { names: arrayRemove(name) }); // Remove name from the array
                await loadStudentList(); // Reload the list
                populateStudentList(); // Update UI
            } catch (error) {
                console.error("Error deleting student:", error);
                showConfirmationModal("L·ªói khi x√≥a h·ªçc sinh.", () => {});
            }
        }

        /**
         * Populates the name selection modal with current student names.
         */
        function populateNameSelectionModal() {
            const container = document.getElementById('name-selection-container');
            container.innerHTML = ''; // Clear previous buttons
            const colors = ["bg-pink-500/60", "bg-indigo-500/60", "bg-teal-500/60", "bg-amber-500/60"]; // Array of colors for buttons
            studentList.forEach((name, index) => {
                const color = colors[index % colors.length]; // Cycle through colors
                const button = document.createElement('button');
                button.dataset.name = name;
                button.className = `name-btn w-full glass-btn ${color} text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:opacity-80`;
                button.textContent = name;
                container.appendChild(button);
            });
        }

        // --- ADMIN QUESTION MANAGEMENT ---

        /**
         * Displays the question management panel and populates the question list.
         */
        function displayQuestionManager() {
            showScreen('questionManager');
            populateQuestionList();
        }

        /**
         * Populates the question list based on selected filters.
         */
        function populateQuestionList() {
            const container = document.getElementById('question-list-container');
            const summaryDisplay = document.getElementById('question-summary-display'); // Get the new summary element
            container.innerHTML = '';

            const subject = document.getElementById('q-manager-subject-filter').value;
            const grade = document.getElementById('q-manager-grade-filter').value;
            const semester = document.getElementById('q-manager-semester-filter').value;

            // Filter questions from the full collection
            const filteredQuestions = fullQuestionCollection.filter(q => 
                (subject === 'all' || q.subject === subject) && 
                (grade === 'all' || q.grade === grade) && 
                (semester === 'all' || q.semester === semester)
            );

            // Update the summary display
            const totalQuestionsInDB = fullQuestionCollection.length;
            summaryDisplay.textContent = `T·ªïng s·ªë c√¢u h·ªèi: ${totalQuestionsInDB} (ƒêang hi·ªÉn th·ªã: ${filteredQuestions.length})`;

            if (filteredQuestions.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-600 font-semibold p-4">Kh√¥ng c√≥ c√¢u h·ªèi n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc.</p>';
                return;
            }

            filteredQuestions.forEach(q => {
                const itemEl = document.createElement('div');
                itemEl.className = 'p-3 bg-black/10 rounded-lg';
                itemEl.innerHTML = `
                    <p class="font-bold text-gray-800">${q.question}</p>
                    <p class="text-sm text-gray-600">ƒê√°p √°n: <span class="font-semibold">${q.answer}</span></p>
                    <div class="flex gap-2 mt-2">
                        <button data-id="${q.id}" class="edit-question-btn text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">S·ª≠a</button>
                        <button data-id="${q.id}" class="delete-question-btn text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">X√≥a</button>
                    </div>
                `;
                container.appendChild(itemEl);
            });
        }

        /**
         * Opens the question edit/add modal, populating it if editing an existing question.
         * @param {string|null} questionId - The ID of the question to edit, or null for a new question.
         */
        function openQuestionModal(questionId = null) {
            const form = document.getElementById('question-form');
            form.reset(); // Clear form fields
            document.getElementById('question-id-input').value = questionId || ''; // Set hidden ID field
            const title = document.getElementById('question-modal-title');

            if (questionId) {
                title.textContent = 'Ch·ªânh s·ª≠a c√¢u h·ªèi';
                const questionData = fullQuestionCollection.find(q => q.id === questionId);
                if (questionData) {
                    document.getElementById('question-text-input').value = questionData.question;
                    questionData.options.forEach((opt, i) => { 
                        const optionInput = document.getElementById(`option-${i+1}-input`);
                        if (optionInput) optionInput.value = opt;
                    });
                    populateAnswerSelect(questionData.options, questionData.answer); // Populate correct answer dropdown
                }
            } else {
                title.textContent = 'Th√™m c√¢u h·ªèi m·ªõi';
                populateAnswerSelect(['', '', '', '']); // Clear options for new question
            }
            showModal('questionEdit');
        }

        /**
         * Populates the dropdown for selecting the correct answer in the question form.
         * @param {string[]} options - An array of answer options.
         * @param {string|null} selectedAnswer - The currently selected correct answer.
         */
        function populateAnswerSelect(options, selectedAnswer = null) {
            const select = document.getElementById('correct-answer-select');
            select.innerHTML = ''; // Clear previous options
            options.forEach((opt, i) => {
                if(opt) { // Only add non-empty options
                    const optionEl = document.createElement('option');
                    optionEl.value = opt;
                    optionEl.textContent = `L·ª±a ch·ªçn ${i + 1}: ${opt}`;
                    if (opt === selectedAnswer) { optionEl.selected = true; } // Pre-select if matches
                    select.appendChild(optionEl);
                }
            });
        }

        /**
         * Handles the submission of the question add/edit form.
         * @param {Event} e - The form submission event.
         */
        async function handleQuestionFormSubmit(e) {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            setButtonLoading(button, true); // Show loading spinner
            const errorEl = document.getElementById('question-form-error');
            errorEl.textContent = ''; // Clear previous errors

            const questionId = document.getElementById('question-id-input').value;
            const questionText = document.getElementById('question-text-input').value.trim();
            const options = Array.from(document.querySelectorAll('.option-input')).map(input => input.value.trim());
            const answer = document.getElementById('correct-answer-select').value;

            // Form validation
            if (!questionText || options.some(opt => !opt) || !answer) {
                errorEl.textContent = 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ c√°c tr∆∞·ªùng.';
                setButtonLoading(button, false);
                return;
            }
            if (!options.includes(answer)) {
                errorEl.textContent = 'ƒê√°p √°n ƒë√∫ng ph·∫£i l√† m·ªôt trong c√°c l·ª±a ch·ªçn.';
                setButtonLoading(button, false);
                return;
            }

            // Ensure subject, grade, semester are selected from filters
            const subject = document.getElementById('q-manager-subject-filter').value;
            const grade = document.getElementById('q-manager-grade-filter').value;
            const semester = document.getElementById('q-manager-semester-filter').value;

            if (subject === 'all' || grade === 'all' || semester === 'all') {
                errorEl.textContent = 'Vui l√≤ng ch·ªçn M√¥n, L·ªõp v√† H·ªçc k·ª≥ c·ª• th·ªÉ tr∆∞·ªõc khi l∆∞u.';
                setButtonLoading(button, false);
                return;
            }

            const questionData = { subject, grade, semester, question: questionText, options, answer };
            
            try {
                const qCollection = collection(db, `artifacts/${appId}/public/data/questions`);
                if (questionId) {
                    await updateDoc(doc(qCollection, questionId), questionData); // Update existing question
                } else {
                    await addDoc(qCollection, questionData); // Add new question
                }
                hideModal('questionEdit'); // Close modal
                await loadQuestionsFromFirestore(); // Reload all questions
                populateQuestionList(); // Refresh the displayed list
            } catch (error) {
                console.error("Error saving question:", error);
                errorEl.textContent = 'L·ªói khi l∆∞u c√¢u h·ªèi v√†o CSDL.';
            } finally {
                setButtonLoading(button, false);
            }
        }

        /**
         * Deletes a question from Firestore.
         * @param {string} questionId - The ID of the question to delete.
         */
        async function deleteQuestion(questionId) {
            const qDoc = doc(db, `artifacts/${appId}/public/data/questions`, questionId);
            try {
                await deleteDoc(qDoc);
                await loadQuestionsFromFirestore(); // Reload questions after deletion
                populateQuestionList(); // Refresh the displayed list
            } catch (error) {
                console.error("Error deleting question:", error);
                showConfirmationModal("L·ªói khi x√≥a c√¢u h·ªèi.", () => {});
            }
        }

        /**
         * Handles the AI question generation process.
         * @param {HTMLButtonElement} button - The button that triggered the generation.
         */
        async function handleAIGenerate(button) {
            setButtonLoading(button, true);
            const feedbackEl = document.getElementById('ai-generation-feedback');
            const resultsContainer = document.getElementById('ai-results-container');
            const resultsList = document.getElementById('ai-generated-questions-list');
            const saveBtn = document.getElementById('ai-save-all-btn');
            const discardBtn = document.getElementById('ai-discard-all-btn');

            feedbackEl.textContent = 'ü§ñ AI ƒëang suy nghƒ©, vui l√≤ng ch·ªù trong gi√¢y l√°t...';
            resultsContainer.classList.remove('hidden');
            resultsList.innerHTML = ''; // Clear previous results
            saveBtn.classList.add('hidden');
            discardBtn.classList.add('hidden');

            const subject = document.getElementById('ai-gen-subject').options[document.getElementById('ai-gen-subject').selectedIndex].text;
            const grade = document.getElementById('ai-gen-grade').options[document.getElementById('ai-gen-grade').selectedIndex].text;
            const topic = document.getElementById('ai-gen-topic').value.trim();
            const count = parseInt(document.getElementById('ai-gen-count').value, 10);

            if (!topic) {
                feedbackEl.textContent = 'Vui l√≤ng nh·∫≠p m·ªôt ch·ªß ƒë·ªÅ c·ª• th·ªÉ.';
                setButtonLoading(button, false);
                return;
            }
            if (isNaN(count) || count < 1 || count > 20) {
                feedbackEl.textContent = 'S·ªë c√¢u h·ªèi ph·∫£i t·ª´ 1 ƒë·∫øn 20.';
                setButtonLoading(button, false);
                return;
            }

            // Prompt for AI to generate `count` multiple-choice questions in JSON format
            const prompt = `T·∫°o ${count} c√¢u h·ªèi tr·∫Øc nghi·ªám cho m√¥n ${subject} ${grade} v·ªÅ ch·ªß ƒë·ªÅ "${topic}". M·ªói c√¢u h·ªèi ph·∫£i c√≥ 4 l·ª±a ch·ªçn v√† 1 ƒë√°p √°n ƒë√∫ng. Tr·∫£ v·ªÅ d∆∞·ªõi d·∫°ng JSON.`;
            // JSON schema for the expected AI response structure
            const schema = { 
                type: "ARRAY", 
                items: { 
                    type: "OBJECT", 
                    properties: { 
                        "question": { "type": "STRING" }, 
                        "options": { "type": "ARRAY", "items": { "type": "STRING" } }, 
                        "answer": { "type": "STRING" } 
                    }, 
                    required: ["question", "options", "answer"] 
                } 
            };

            try {
                const jsonString = await callGeminiAPI(prompt, schema);
                const generatedQuestions = JSON.parse(jsonString);

                if (!Array.isArray(generatedQuestions) || generatedQuestions.length === 0) {
                    throw new Error("AI did not return a valid list of questions.");
                }

                feedbackEl.textContent = `ƒê√£ t·∫°o ${generatedQuestions.length} c√¢u h·ªèi! Vui l√≤ng xem l·∫°i v√† l∆∞u.`;
                // Display generated questions for review
                generatedQuestions.forEach(q => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'p-3 bg-black/10 rounded-lg text-sm';
                    itemEl.innerHTML = `
                        <p class="font-bold">${q.question}</p>
                        <p>ƒê√°p √°n: ${q.answer}</p>
                    `;
                    resultsList.appendChild(itemEl);
                });

                saveBtn.classList.remove('hidden');
                discardBtn.classList.remove('hidden');
                // Set click handlers for save/discard
                saveBtn.onclick = () => saveGeneratedQuestions(generatedQuestions);
                discardBtn.onclick = () => { resultsContainer.classList.add('hidden'); };

            } catch (error) {
                console.error("Error generating questions with AI:", error);
                feedbackEl.textContent = 'ƒê√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c ki·ªÉm tra API Key.';
            } finally {
                setButtonLoading(button, false); // Hide loading spinner
            }
        }

        /**
         * Saves the AI-generated questions to Firestore.
         * @param {object[]} questions - An array of question objects to save.
         */
        async function saveGeneratedQuestions(questions) {
            const subject = document.getElementById('ai-gen-subject').value;
            const grade = document.getElementById('ai-gen-grade').value;
            const semester = document.getElementById('ai-gen-semester').value;
            const feedbackEl = document.getElementById('ai-generation-feedback');
            feedbackEl.textContent = 'ƒêang l∆∞u c√¢u h·ªèi...';

            const qCollection = collection(db, `artifacts/${appId}/public/data/questions`);
            // Filter out questions where the answer is not one of the options
            const promises = questions.map(q => {
                if (q.options.includes(q.answer)) {
                    return addDoc(qCollection, { ...q, subject, grade, semester });
                }
                return null;
            }).filter(p => p !== null); // Remove null promises

            try {
                await Promise.all(promises); // Save all valid questions
                feedbackEl.textContent = `ƒê√£ l∆∞u th√†nh c√¥ng ${promises.length} c√¢u h·ªèi!`;
                document.getElementById('ai-results-container').classList.add('hidden'); // Hide results container
                await loadQuestionsFromFirestore(); // Reload all questions to update local bank
            } catch (error) {
                console.error("Error saving AI questions:", error);
                feedbackEl.textContent = 'L·ªói khi l∆∞u c√¢u h·ªèi.';
            }
        }

        // New function for temporary feedback
        function displayTemporaryFeedback(elementId, message, isError = false) {
            const feedbackEl = document.getElementById(elementId);
            if (!feedbackEl) {
                console.error(`Feedback element with ID '${elementId}' not found.`);
                return;
            }
            feedbackEl.textContent = message;
            feedbackEl.className = `text-center text-sm font-bold h-4 mt-4 ${isError ? 'text-red-600' : 'text-green-800'}`;
            setTimeout(() => {
                feedbackEl.textContent = '';
                feedbackEl.className = 'text-center text-sm font-bold h-4 mt-4'; // Reset class
            }, 3000);
        }

        // --- DUPLICATE QUESTION MANAGEMENT ---

        /**
         * Displays the duplicate question manager panel and finds/displays duplicates.
         */
        function displayDuplicateManager() {
            showScreen('duplicateManager');
            findAndDisplayDuplicates();
        }

        /**
         * Finds duplicate questions in the full question collection and displays them.
         */
        function findAndDisplayDuplicates() {
            const container = document.getElementById('duplicate-questions-list');
            container.innerHTML = '<p class="text-center text-gray-600 font-semibold p-4">ƒêang t√¨m c√¢u h·ªèi tr√πng l·∫∑p...</p>';

            const duplicatesMap = new Map(); // Map to store unique key -> array of question objects

            fullQuestionCollection.forEach(q => {
                // Create a unique key based on question text, answer, and sorted options
                const normalizedQuestion = q.question.trim().toLowerCase();
                const normalizedAnswer = q.answer.trim().toLowerCase();
                // Ensure options are sorted consistently for comparison
                const normalizedOptions = [...q.options].map(opt => opt.trim().toLowerCase()).sort().join(';');
                const uniqueKey = `${normalizedQuestion}||${normalizedAnswer}||${normalizedOptions}`;

                if (!duplicatesMap.has(uniqueKey)) {
                    duplicatesMap.set(uniqueKey, []);
                }
                duplicatesMap.get(uniqueKey).push(q);
            });

            let hasDuplicates = false;
            let htmlContent = '';

            duplicatesMap.forEach((questions, uniqueKey) => { // Use uniqueKey as the map key
                if (questions.length > 1) { // Found duplicates
                    hasDuplicates = true;
                    htmlContent += `
                        <div class="p-4 bg-black/10 rounded-lg shadow-md mb-4">
                            <p class="font-bold text-gray-800 text-lg mb-2">C√¢u h·ªèi g·ªëc: "${questions[0].question}"</p>
                            <p class="text-sm text-gray-600 mb-2">ƒê√°p √°n: "${questions[0].answer}"</p>
                            <p class="text-sm text-gray-600 mb-2">S·ªë l∆∞·ª£ng tr√πng l·∫∑p: ${questions.length}</p>
                            <div class="space-y-2">
                    `;
                    // Display each instance of the duplicate, allowing deletion
                    questions.forEach((q, index) => {
                        const isOriginal = (index === 0); // Mark the first one as original
                        htmlContent += `
                            <div class="flex items-center justify-between p-2 bg-white/20 rounded-md">
                                <p class="text-sm text-gray-800 flex-grow pr-2">
                                    ${isOriginal ? '<span class="font-semibold text-blue-700">[G·ªëc]</span> ' : ''}
                                    ${q.question} <span class="text-gray-500 text-xs">(ID: ${q.id})</span>
                                </p>
                                ${!isOriginal ? `<button data-id="${q.id}" class="delete-duplicate-instance-btn text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">X√≥a tr√πng l·∫∑p</button>` : ''}
                            </div>
                        `;
                    });
                    htmlContent += `
                            </div>
                            <button data-original-id="${questions[0].id}" data-duplicate-ids="${questions.slice(1).map(q => q.id).join(',')}" 
                                class="delete-all-duplicates-btn w-full mt-4 glass-btn bg-red-600/70 text-white font-bold py-2 rounded-xl shadow-lg hover:bg-red-600/90">
                                Gi·ªØ l·∫°i 1 c√¢u g·ªëc, x√≥a t·∫•t c·∫£ ${questions.length - 1} c√¢u tr√πng l·∫∑p
                            </button>
                        </div>
                    `;
                }
            });

            if (!hasDuplicates) {
                container.innerHTML = '<p class="text-center text-gray-600 font-semibold p-4">Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi tr√πng l·∫∑p n√†o.</p>';
            } else {
                container.innerHTML = htmlContent;
                // Add event listeners for delete buttons
                container.querySelectorAll('.delete-duplicate-instance-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const idToDelete = e.target.dataset.id;
                        showConfirmationModal(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¢u h·ªèi tr√πng l·∫∑p n√†y (ID: ${idToDelete}) kh√¥ng?`, () => deleteQuestionById(idToDelete));
                    });
                });
                container.querySelectorAll('.delete-all-duplicates-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const originalId = e.target.dataset.originalId;
                        const duplicateIds = e.target.dataset.duplicateIds.split(',').filter(id => id !== ''); // Get all duplicate IDs
                        showConfirmationModal(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën gi·ªØ l·∫°i c√¢u g·ªëc (ID: ${originalId}) v√† x√≥a t·∫•t c·∫£ ${duplicateIds.length} c√¢u h·ªèi tr√πng l·∫∑p c√≤n l·∫°i kh√¥ng?`, () => deleteAllDuplicatesInGroup(originalId, duplicateIds));
                    });
                });
            }
        }

        /**
         * Deletes a single question by its ID and refreshes the duplicate list.
         * @param {string} id - The ID of the question to delete.
         */
        async function deleteQuestionById(id) {
            const qDoc = doc(db, `artifacts/${appId}/public/data/questions`, id);
            try {
                await deleteDoc(qDoc);
                await loadQuestionsFromFirestore(); // Reload all questions
                findAndDisplayDuplicates(); // Refresh the duplicate list
                populateQuestionList(); // Also refresh the main question list
                displayTemporaryFeedback('duplicate-feedback', 'ƒê√£ x√≥a c√¢u h·ªèi tr√πng l·∫∑p th√†nh c√¥ng!', false);
            } catch (error) {
                console.error("Error deleting duplicate question instance:", error);
                displayTemporaryFeedback('duplicate-feedback', 'L·ªói khi x√≥a c√¢u h·ªèi tr√πng l·∫∑p.', true);
            }
        }

        /**
         * Keeps one original question and deletes all other duplicates in a group.
         * @param {string} originalId - The ID of the question to keep.
         * @param {string[]} duplicateIds - An array of IDs of duplicate questions to delete.
         */
        async function deleteAllDuplicatesInGroup(originalId, duplicateIds) {
            const deletePromises = duplicateIds.map(id => deleteDoc(doc(db, `artifacts/${appId}/public/data/questions`, id)));
            try {
                await Promise.all(deletePromises);
                await loadQuestionsFromFirestore(); // Reload all questions
                findAndDisplayDuplicates(); // Refresh the duplicate list
                populateQuestionList(); // Also refresh the main question list
                displayTemporaryFeedback('duplicate-feedback', `ƒê√£ x√≥a ${duplicateIds.length} c√¢u h·ªèi tr√πng l·∫∑p th√†nh c√¥ng!`, false);
            } catch (error) {
                console.error("Error deleting all duplicates in group:", error);
                displayTemporaryFeedback('duplicate-feedback', 'L·ªói khi x√≥a t·∫•t c·∫£ c√¢u h·ªèi tr√πng l·∫∑p trong nh√≥m.', true);
            }
        }


        // --- EVENT LISTENERS ---

        // Initialize Firebase and start audio context on DOM load and first user interaction
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeFirebase();
            document.body.addEventListener('click', async () => {
                if (Tone.context.state !== 'running') {
                    await Tone.start();
                    console.log('Audio context started');
                }
            }, { once: true }); // Only run once
        });

        // Sound toggle button
        document.getElementById('sound-toggle-btn').addEventListener('click', () => {
            soundsEnabled = !soundsEnabled;
            document.getElementById('speaker-on-icon').classList.toggle('hidden', !soundsEnabled);
            document.getElementById('speaker-off-icon').classList.toggle('hidden', soundsEnabled);
        });

        // Game selection buttons (Subject, Grade, Semester)
        document.querySelectorAll('.choice-btn').forEach(btn => btn.addEventListener('click', (e) => {
            playSound('click');
            const type = Object.keys(e.target.dataset)[0]; // 'subject', 'grade', or 'semester'
            const value = e.target.dataset[type];

            // Update selected state variables
            if (type === 'subject') selectedSubject = value;
            if (type === 'grade') selectedGrade = value;
            if (type === 'semester') selectedSemester = value;

            // Remove 'selected' class from siblings and add to the clicked button
            document.querySelectorAll(`[data-${type}]`).forEach(b => b.classList.remove('selected'));
            e.target.classList.add('selected');
            updateStartButtonState(); // Re-evaluate start button state
        }));

        // Start Game button
        document.getElementById('start-btn').addEventListener('click', () => {
            if (!document.getElementById('start-btn').disabled) {
                playSound('click');
                startGame();
            }
        });

        // Next Question button
        document.getElementById('next-btn').addEventListener('click', () => {
            playSound('click');
            nextQuestion();
        });

        // Leaderboard buttons and filters
        leaderboardBtn.addEventListener('click', () => { playSound('click'); displayLeaderboard(); });
        backToMenuBtn.addEventListener('click', () => { playSound('click'); resetGame(); });
        leaderboardSubjectFilter.addEventListener('change', displayLeaderboard);
        leaderboardGradeFilter.addEventListener('change', displayLeaderboard);
        leaderboardNameFilter.addEventListener('input', displayLeaderboard);

        // Admin Login Modal
        document.getElementById('admin-login-btn').addEventListener('click',_=> { playSound('click'); showModal('login'); });
        document.getElementById('close-modal-btn').addEventListener('click', () => hideModal('login'));
        document.getElementById('close-history-detail-btn').addEventListener('click', () => hideModal('historyDetail'));

        // Confirmation Modal buttons
        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            if (typeof confirmCallback === 'function') {
                playSound('click');
                confirmCallback(); // Execute stored callback
            }
            hideModal('confirmation');
            confirmCallback = null; // Clear callback
        });
        document.getElementById('cancel-delete-btn').addEventListener('click', () => {
            playSound('click');
            hideModal('confirmation');
            confirmCallback = null; // Clear callback
        });

        // Admin Login Form submission
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            playSound('click');
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            // Hardcoded admin credentials (for demo purposes)
            if (u === 'admin' && p === 'admin') {
                hideModal('login');
                showScreen('admin');
            } else {
                document.getElementById('login-error').textContent = 'T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.';
            }
        });

        // Logout button
        document.getElementById('logout-btn').addEventListener('click', () => {
            playSound('click');
            showScreen('selection'); // Go back to selection screen
        });
        
        // Admin Panel Navigation
        document.getElementById('view-history-btn').addEventListener('click', () => { playSound('click'); displayHistory(); });
        document.getElementById('manage-settings-btn').addEventListener('click', () => { 
            playSound('click'); 
            showScreen('settings'); 
            // Populate settings fields with current values
            document.getElementById('timer-toggle').checked = timerEnabled; 
            document.getElementById('timer-duration').value = timerDuration; 
        });
        document.getElementById('manage-students-btn').addEventListener('click', () => { playSound('click'); displayStudentManager(); });
        document.getElementById('manage-questions-btn').addEventListener('click', () => { playSound('click'); displayQuestionManager(); });
        document.getElementById('ai-generate-btn').addEventListener('click', () => { playSound('click'); showScreen('aiGenerator'); });
        // Back to Admin buttons (common class for navigation)
        document.querySelectorAll('.back-to-admin-btn').forEach(btn => btn.addEventListener('click', () => { playSound('click'); showScreen('admin'); }));

        // Settings Panel actions
        document.getElementById('save-settings-btn').addEventListener('click', (e) => { playSound('click'); saveAdminSettings(e.currentTarget); });
        document.getElementById('save-api-key-btn').addEventListener('click', (e) => { playSound('click'); saveApiKey(e.currentTarget); });
        document.getElementById('delete-api-key-btn').addEventListener('click', (e) => { playSound('click'); deleteApiKey(e.currentTarget); });
        // Clear data buttons with confirmation
        document.getElementById('clear-leaderboard-btn').addEventListener('click', (e) => { 
            showConfirmationModal('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a TO√ÄN B·ªò b·∫£ng x·∫øp h·∫°ng kh√¥ng?', () => clearCollection('leaderboard', e.currentTarget)); 
        });
        document.getElementById('clear-history-btn').addEventListener('click', (e) => { 
            showConfirmationModal('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a TO√ÄN B·ªò l·ªãch s·ª≠ thi kh√¥ng?', () => clearCollection('quizResults', e.currentTarget)); 
        });

        // Student Manager actions
        document.getElementById('add-student-form').addEventListener('submit', (e) => { 
            e.preventDefault(); 
            const input = document.getElementById('new-student-name');
            const name = input.value.trim();
            addStudent(name);
            input.value = ''; // Clear input field
        });
        document.getElementById('student-list-container').addEventListener('click', (e) => { 
            if (e.target.classList.contains('delete-student-btn')) { 
                const name = e.target.dataset.name; 
                showConfirmationModal(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h·ªçc sinh "${name}" kh√¥ng?`, () => deleteStudent(name)); 
            } 
        });

        // Question Manager actions
        document.getElementById('q-manager-subject-filter').addEventListener('change', populateQuestionList);
        document.getElementById('q-manager-grade-filter').addEventListener('change', populateQuestionList);
        document.getElementById('q-manager-semester-filter').addEventListener('change', populateQuestionList);
        document.getElementById('add-new-question-btn').addEventListener('click', () => openQuestionModal());
        document.getElementById('question-list-container').addEventListener('click', (e) => { 
            if (e.target.classList.contains('edit-question-btn')) { 
                openQuestionModal(e.target.dataset.id); 
            } 
            if (e.target.classList.contains('delete-question-btn')) { 
                showConfirmationModal('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¢u h·ªèi n√†y kh√¥ng?', () => deleteQuestion(e.target.dataset.id)); 
            } 
        });
        document.getElementById('find-duplicates-btn').addEventListener('click', () => { // New button listener
            playSound('click');
            displayDuplicateManager();
        });
        document.getElementById('question-form').addEventListener('submit', handleQuestionFormSubmit);
        document.getElementById('close-question-modal-btn').addEventListener('click', () => hideModal('questionEdit'));
        // Update correct answer dropdown when option inputs change
        document.querySelectorAll('.option-input').forEach(input => { 
            input.addEventListener('input', () => { 
                const options = Array.from(document.querySelectorAll('.option-input')).map(i => i.value.trim()); 
                const selected = document.getElementById('correct-answer-select').value; 
                populateAnswerSelect(options, selected); 
            }); 
        });

        // AI Generator actions
        document.getElementById('ai-execute-generation-btn').addEventListener('click', (e) => handleAIGenerate(e.currentTarget));

    </script>
</body>
</html>
